---
title: "plots with prolactin"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(cowplot)
library(magick)
library(png)
library(grid)
library(ggimage)
library(apaTables)

source("../R/themes.R") 
source("../R/functions.R")
source("../R/icons.R")

knitr::opts_chunk$set(fig.path = '../figures/PRL/',message=F, warning=FALSE)
```


```{r data}
hormones <- read_csv("../results/hormones.csv")
hormones$treatment <- factor(hormones$treatment, levels = alllevels)

meanprolactin <- hormones %>% 
    filter(study == "characterization", hormone %in% c("prolactin"))  %>% 
    droplevels() %>% 
  dplyr::group_by(treatment) %>%
  dplyr::summarise(m = mean(plasma_conc), 
                   se = sd(plasma_conc)/sqrt(length(plasma_conc))) %>%
  dplyr::mutate(m = round(m,0)) 
meanprolactin <- left_join(meanprolactin, birds)
meanprolactin$treatment <- factor(meanprolactin$treatment, levels = alllevels)
meanprolactin

```



```{r hormone}
p1 <- hormones %>% 
    filter(study == "characterization", hormone %in% c("prolactin"))  %>% 
    droplevels() %>% 
  ggplot(aes(x = treatment, y = plasma_conc, fill = treatment)) +
    geom_boxplot() +
  ylim(c(-10,120)) + 
    theme_B3() +
  #theme(axis.text.x = element_blank()) + 
  theme(legend.position = "none") + 
  labs(x = "parental care stages", y = "prolactin (ng/mL)") +
  annotation_custom(control, ymin = -20, ymax = 0, xmin = -7.5) +
  annotation_custom(bldg, ymin = -20, ymax = 0, xmin = -5.5) +
  annotation_custom(lay, ymin = -20, ymax = 0, xmin = -3.5) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = -1.5) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = 0.5) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = 2.5) +
  annotation_custom(hatch, ymin = -20, ymax = 0, xmin = 4.5) +
  annotation_custom(nestling, ymin = -20, ymax = 0, xmin = 6.5) +
  annotation_custom(nestling, ymin = -20, ymax = 0, xmin = 8.5) 
p1



p2 <-  ggplot(meanprolactin, aes(treatment, m)) +
  geom_errorbar(aes(ymin=m-se, ymax=m+se, color = treatment), width=.1) +
   geom_image(aes(image=iconpath), size=.1)  +
  labs(x = "parental care stages", y = "prolactin (ng/mL)") +
  theme_B3() +
  theme(legend.position = "none")
  
p2

p3 <- ggplot(meanprolactin, aes(treatment, m)) +
   geom_image(aes(image=music), size=.12)  +
  labs(x = "increasing time >>", y = "prolactin (ng/mL)")  +
  mytheme() +
  ylim(c(-15,80)) +
  annotation_custom(control, ymin = -20, ymax = 0, xmin = -7.5) +
  annotation_custom(bldg, ymin = -20, ymax = 0, xmin = -5.5) +
  annotation_custom(lay, ymin = -20, ymax = 0, xmin = -3.5) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = -1.5) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = 0.5) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = 2.5) +
  annotation_custom(hatch, ymin = -20, ymax = 0, xmin = 4.5) +
  annotation_custom(nestling, ymin = -20, ymax = 0, xmin = 6.5) +
  annotation_custom(nestling, ymin = -20, ymax = 0, xmin = 8.5) +
  geom_hline(yintercept=0) +
  geom_hline(yintercept=20) +
  geom_hline(yintercept=40) +
  geom_hline(yintercept=60) +
  geom_hline(yintercept=80) 
p3


p4 <- hormones %>% 
    filter(study == "characterization", hormone %in% c("prolactin"))  %>% 
    droplevels() %>% 
  ggplot(aes(x = treatment, y = plasma_conc)) +
    geom_boxplot(aes(fill = treatment, alpha = sex, color = sex)) +
    theme_B3() +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = "prolactin (ng/mL)", x = NULL) +
    guides(fill = FALSE, alpha = FALSE,
         color = guide_legend(order=1)) +
    scale_alpha_manual(values = c(0.75,1)) +
    theme(legend.position = c(0.85,0.15), legend.direction = "horizontal") + 
  labs(x = "increasing time >>", y = "prolactin (ng/mL)") +
  annotation_custom(control, ymin = -20, ymax = 0, xmin = -7.8) +
  annotation_custom(bldg, ymin = -20, ymax = 0, xmin = -5.8) +
  annotation_custom(lay, ymin = -20, ymax = 0, xmin = -3.8) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = -1.8) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = 0.6) +
  annotation_custom(inc, ymin = -20, ymax = 0, xmin = 2.4) +
  annotation_custom(hatch, ymin = -20, ymax = 0, xmin = 4.4) +
  annotation_custom(nestling, ymin = -20, ymax = 0, xmin = 6.4) +
  annotation_custom(nestling, ymin = -20, ymax = 0, xmin = 8.4) + 
  ylim(c(-10,120)) 
p4

plot_grid(p1,p4,p2,p3)


```


```{r PRL.pit}
vsd.pit <- readvsd("../results/04_vsd_pit.csv")
colData.pit <- readcolData("../results/04_colData_pit.csv")

geneinfo <- read_csv("../metadata/00_geneinfo.csv") %>%  dplyr::select(Name, geneid, entrezid) %>% arrange(Name)

candidategenes <- c("PRL")
candidates.pit <- selectcandidatevsds(candidategenes, vsd.pit, colData.pit)

meanPRL <- candidates.pit %>% 
    droplevels() %>% 
  dplyr::group_by(treatment) %>%
  dplyr::summarise(m = mean(PRL), 
                   se = sd(PRL)/sqrt(length(PRL))) %>%
  dplyr::mutate(m = round(m,1)) 
meanPRL <- left_join(meanPRL, birds)
meanPRL$treatment <- factor(meanPRL$treatment, levels = alllevels)
meanPRL

p5 <- candidates.pit %>% 
  ggplot(aes(x = treatment, y = PRL, fill = treatment)) +
    geom_boxplot() +
    theme_B3() +
  theme(legend.position = "none") + 
  labs(x = "increasing time >>", y = "prolactin (ng/mL)") +
  annotation_custom(control, ymin = 12, ymax = 14, xmin = -7.8) +
  annotation_custom(bldg, ymin = 12, ymax = 14, xmin = -5.8) +
  annotation_custom(lay, ymin = 12, ymax = 14, xmin = -3.8) +
  annotation_custom(inc, ymin = 12, ymax = 14, xmin = -1.8) +
  annotation_custom(inc, ymin = 12, ymax = 14, xmin = 0.6) +
  annotation_custom(inc, ymin = 12, ymax = 14, xmin = 2.4) +
  annotation_custom(hatch, ymin = 12, ymax = 14, xmin = 4.4) +
  annotation_custom(nestling, ymin = 12, ymax = 14, xmin = 6.4) +
  annotation_custom(nestling, ymin = 12, ymax = 14, xmin = 8.4)  +
  ylim(c(13,24)) 
p5





p7 <- ggplot(meanPRL, aes(treatment, m)) +
  geom_errorbar(aes(ymin=m-se, ymax=m+se, color = treatment), width=.1) +
   geom_image(aes(image=iconpath), size=.12)  +
  labs(x = "increasing time >>", y = "Pituitary PRL expression") +
  theme_B3()  +
  theme(legend.position = "none")
p7

p8 <- ggplot(meanPRL, aes(treatment, m)) +
   geom_image(aes(image=music), size=.12)  +
  labs(x = "parental care stages", y = "Pituitary PRL expression") +
  mytheme() +
  ylim(c(15,22)) +
  annotation_custom(control, ymin = 15, ymax = 16.5, xmin = -7.5) +
  annotation_custom(bldg, ymin = 15, ymax = 16.5, xmin = -5.5) +
  annotation_custom(lay, ymin = 15, ymax = 16.5, xmin = -3.5) +
  annotation_custom(inc, ymin = 15, ymax = 16.5, xmin = -1.5) +
  annotation_custom(inc, ymin = 15, ymax = 16.5, xmin = 0.5) +
  annotation_custom(inc, ymin = 15, ymax = 16.5, xmin = 2.5) +
  annotation_custom(hatch, ymin = 15, ymax = 16.5, xmin = 4.5) +
  annotation_custom(nestling, ymin = 15, ymax = 16.5, xmin = 6.5) +
  annotation_custom(nestling, ymin = 15, ymax = 16.5, xmin = 8.5)   +
  geom_hline(yintercept=17) +
  geom_hline(yintercept=18) +
  geom_hline(yintercept=19) +
  geom_hline(yintercept=20) +
  geom_hline(yintercept=21) 

p8

p6 <- ggplot(candidates.pit, aes(x = treatment, y = PRL)) + 
    geom_boxplot(aes(fill = treatment, alpha = sex, color = sex)) + 
    scale_alpha_manual(values = c(0.75,1)) +
    theme_B3() +
  theme(legend.position = c(0.85,0.2), legend.direction = "horizontal") + 
  scale_color_manual(values = c("female" = "#969696", "male" = "#525252")) +
  labs(y = "PRL", x = NULL) +
  guides(fill = FALSE, alpha = FALSE, color = guide_legend(order=1)) +
  theme(axis.title.y  = element_text(face = "italic"))
p6

```


```{r PRLBRCA1}
brca <- c( "NP_989500.1")
brca.pit <- selectcBRCA1vsds(brca, vsd.pit, colData.pit)

meanBRCA <- brca.pit %>% 
    droplevels() %>% 
  dplyr::group_by(treatment) %>%
  dplyr::summarise(m = mean(BRCA1), 
                   se = sd(BRCA1)/sqrt(length(BRCA1))) %>%
  dplyr::mutate(m = round(m,1)) 
meanBRCA <- left_join(meanBRCA, birds)
meanBRCA$treatment <- factor(meanBRCA$treatment, levels = alllevels)
meanBRCA

brca1 <- brca.pit %>% 
  ggplot(aes(x = treatment, y = BRCA1, fill = treatment, color = sex)) +
    geom_boxplot() +
    theme_B3() +
  scale_color_manual(values = c("female" = "#969696", "male" = "#525252")) +
  theme(legend.position = "none") + 
  labs(x = "increasing time >>", y = "BRCA1") +
  annotation_custom(control, ymin = 5, ymax = 5.5, xmin = -7.8) +
  annotation_custom(bldg, ymin = 5, ymax = 5.5, xmin = -5.8) +
  annotation_custom(lay, ymin = 5, ymax = 5.5, xmin = -3.8) +
  annotation_custom(inc, ymin = 5, ymax = 5.5, xmin = -1.8) +
  annotation_custom(inc, ymin = 5, ymax = 5.5, xmin = 0.6) +
  annotation_custom(inc, ymin = 5, ymax = 5.5, xmin = 2.4) +
  annotation_custom(hatch, ymin = 5, ymax = 5.5, xmin = 4.4) +
  annotation_custom(nestling, ymin = 5, ymax = 5.5, xmin = 6.4) +
  annotation_custom(nestling, ymin = 5, ymax = 5.5, xmin = 8.4) +
  ylim(5,8) +
  theme(axis.title.y  = element_text(face = "italic"))
brca1


plot_grid(p6, brca1, nrow = 2)
```

## prolactin manip


```{r manipdata}
vsd.pit <- readvsd("../results/06_pitallvsd.csv")
vsd.pit$entrezid <- row.names(vsd.pit)

colData.pit <- read_csv("../metadata/00_samples.csv") %>% 
  filter(tissue == "pituitary") %>% 
  mutate(sample = V1)

geneinfo <- read_csv("../metadata/00_geneinfo.csv") %>%  
  dplyr::select(Name, geneid, entrezid) %>% arrange(Name)

candidategenes <- c("PRL")
candidates.pit <- selectcandidatevsds(candidategenes, vsd.pit, colData.pit)
candidates.pit$treatment <- factor(candidates.pit$treatment, levels = alllevels)

meanPRL <- candidates.pit %>% 
    droplevels() %>% 
  dplyr::group_by(treatment) %>%
  dplyr::summarise(m = median(PRL), 
                   se = sd(PRL)/sqrt(length(PRL))) %>%
  dplyr::mutate(m = round(m,1)) 
meanPRL <- left_join(meanPRL, birds)
meanPRL$treatment <- factor(meanPRL$treatment, levels = alllevels)
meanPRL
```



```{r PRL.pit.maip}
p10 <- ggplot(meanPRL, aes(treatment, m)) +
   geom_errorbar(aes(ymin=m-se, ymax=m+se, color = treatment), width=.1) +
   geom_image(aes(image = iconpath), size = 0.06)  +
   geom_image(aes(image = music , y = m + 0.5), size = 0.04) +
   labs(x = "parental care stages", y = "Pituitary PRL") +
   mytheme() +
   ylim(c(16,22)) +
   theme(axis.text.x = element_text(angle = 45)) +
  theme(legend.position = "none") +
  scale_color_manual(values = colorscharmaip2) +
  geom_hline(yintercept=16.8) +
  geom_hline(yintercept=17.8) +
  geom_hline(yintercept=18.8) +
  geom_hline(yintercept=19.8) +
  geom_hline(yintercept=20.8)  
p10

p11 <- ggplot(candidates.pit, aes(x = treatment, y = PRL)) + 
       geom_smooth(aes(colour = sex)) +
    geom_boxplot(aes(fill = treatment)) +
    scale_alpha_manual(values = c(0.75,1)) +
    theme_B3() +
   theme(legend.position = "none", legend.direction = "horizontal") + 
   scale_color_manual(values = c("female" = "#969696", "male" = "#525252")) +
    labs(y = "Pituitary PRL", x = NULL) +
  scale_fill_manual(values = colorscharmaip2) +
  ylim(c(13,22.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  annotation_custom(control, ymin = 13, ymax = 14, xmin = -14.8) +
  annotation_custom(bldg, ymin = 13, ymax = 14, xmin = -12.8) +
  annotation_custom(lay, ymin = 13, ymax = 14, xmin = -10.8) +
  annotation_custom(inc, ymin = 13, ymax = 14, xmin = -8.8) +
  annotation_custom(removeegg, ymin = 13, ymax = 14, xmin = -6.8) +
  annotation_custom(inc, ymin = 13, ymax = 14, xmin = -4.8) +
  annotation_custom(maniphatch, ymin = 13, ymax = 14, xmin = -2.8) +
  annotation_custom(removeegg, ymin = 13, ymax = 14, xmin = -0.8) +
  annotation_custom(inc, ymin = 13, ymax = 14, xmin = 1.4) +
  annotation_custom(removeegg, ymin = 13, ymax = 14, xmin = 3.4)  +
  annotation_custom(manipinc, ymin = 13, ymax = 14, xmin = 5.4) +
  annotation_custom(hatch, ymin = 13, ymax = 14, xmin = 7.4) +
  annotation_custom(removechick, ymin = 13, ymax = 14, xmin = 9.4) +
  annotation_custom(maniphatch, ymin = 13, ymax = 14, xmin = 11.4) +
  annotation_custom(nestling, ymin = 13, ymax = 14, xmin = 13.4) +
  annotation_custom(nestling, ymin = 13, ymax = 14, xmin = 15.4) 
p11

p12 <- candidates.pit %>%
  filter(treatment %in% c("inc.d9", "m.inc.d8", "hatch")) %>%
    ggplot(aes(x = treatment, y = PRL)) + 
    geom_boxplot(aes(fill = treatment, color = sex)) + 
    scale_alpha_manual(values = c(0.75,1)) +
    theme_B3() +
   theme(legend.position = "none", legend.direction = "horizontal") + 
   scale_color_manual(values = c("female" = "#969696", "male" = "#525252")) +
    labs(y = "Pituitary PRL", x = NULL) +
  ylim(c(13,22.5)) +
  scale_fill_manual(values = colorscharmaip2)   +
  annotation_custom(control, ymin = 13, ymax = 14, xmin = -1.6) +
  annotation_custom(maniphatch, ymin = 13, ymax = 14, xmin = 0.4) +
  annotation_custom(hatch, ymin = 13, ymax = 14, xmin = 2.4)
p12

p13 <- candidates.pit %>%
  filter(treatment %in% c("inc.d17", "prolong", "hatch")) %>%
    ggplot(aes(x = treatment, y = PRL)) + 
    geom_boxplot(aes(fill = treatment, color = sex)) + 
    scale_alpha_manual(values = c(0.75,1)) +
    theme_B3() +
   theme(legend.position = "none", legend.direction = "horizontal") + 
   scale_color_manual(values = c("female" = "#969696", "male" = "#525252")) +
    labs(y = "Pituitary PRL", x = NULL) +
  ylim(c(13,22.5)) +
  scale_fill_manual(values = colorscharmaip2)   +
  annotation_custom(control, ymin = 13, ymax = 14, xmin = -1.6) +
  annotation_custom(manipinc, ymin = 13, ymax = 14, xmin = 0.4) +
  annotation_custom(hatch, ymin = 13, ymax = 14, xmin = 2.4)
p13


p14 <- candidates.pit %>%
  filter(treatment %in% c("hatch", "extend", "n5")) %>%
    ggplot(aes(x = treatment, y = PRL)) + 
    geom_boxplot(aes(fill = treatment, color = sex)) + 
    scale_alpha_manual(values = c(0.75,1)) +
    theme_B3() +
   theme(legend.position = "none", legend.direction = "horizontal") + 
   scale_color_manual(values = c("female" = "#969696", "male" = "#525252")) +
    labs(y = "Pituitary PRL", x = NULL) +
  ylim(c(13,22.5)) +
  scale_fill_manual(values = colorscharmaip2)   +
  annotation_custom(control, ymin = 13, ymax = 14, xmin = -1.6) +
  annotation_custom(maniphatch, ymin = 13, ymax = 14, xmin = 0.4) +
  annotation_custom(hatch, ymin = 13, ymax = 14, xmin = 2.4)
p14

plot_grid(p12,p13 + theme(axis.text.y = element_blank(), axis.title.y = element_blank()),
          p14 + theme(axis.text.y = element_blank(), axis.title.y = element_blank()), 
          nrow = 1, rel_widths = c(1.2,1,1))


```

```{r geneshormones}
candidates.pit$bird_id <- candidates.pit$bird

geneshormones <- left_join(candidates.pit, hormones) %>%
  select(-X1, -V1, -okay, - icons, -music, -iconpath) %>%
  drop_na()
head(geneshormones)


ggplot(geneshormones, aes(x = plasma_conc, y = PRL)) +
  geom_point(aes(color = treatment)) +
  facet_wrap(~hormone, scales = "free_x") +
    geom_smooth(method = "lm", color = "grey") 


prolactin2 <- read_csv("../results/07_prolactin2.csv")
head(prolactin2)
geneshormones2 <- left_join(candidates.pit, prolactin2) %>%
  drop_na()
head(geneshormones)


ggplot(geneshormones2, aes(x = plasma_conc, y = PRL)) +
  geom_point(aes( color = treatment)) +
  geom_smooth(method = "lm", color = "grey") +
  facet_wrap(~hormone, scales = "free") 
```


```{r}
aov_all = data.frame()
for(i in alllevels3){
  
  df <- candidates.pit %>% filter(treatment == i) %>% droplevels()
  aovtable <- apa.aov.table(aov(PRL ~ sex , data=df))
  aovtable <- as.data.frame(aovtable$table_body)
  totaldf <- aovtable[3, 3]
  aovtable$df <- paste(aovtable$df, ", " , totaldf, sep = "")
  aovtable$ANOVA <- "PRL ~ sex"
  aovtable$stages <- paste(i)
  aovtable$p <- as.numeric(as.character(aovtable$p))
  aov_all <- rbind(aov_all,aovtable)
}

aov_all <- aov_all %>%
  filter(Predictor == "sex")  %>%
  select(stages, ANOVA, df, "F", p) %>%
  mutate(sig = ifelse(p < 0.05, "*", " "))
aov_all

one <- c("m.inc.d3", "inc.d3")
two <- c("m.inc.d9", "inc.d9")
three <- c("m.inc.d17", "inc.d17")
four <- c("m.n2", "hatch")
five <- c("m.inc.d8", "inc.d9")
six <- c("m.inc.d8", "hatch")
seven <- c("prolong", "inc.d17")
eight <- c("prolong", "hatch")
nine <- c("extend", "hatch")
ten <- c("extend", "n5")

manipcomparisons <- list(one, two, three, four, five, six, seven, eight, nine, ten)

aov_manip = data.frame()
for(i in manipcomparisons){
  
  df <- candidates.pit %>% filter(treatment %in% i) %>% droplevels()
  aovtable <- apa.aov.table(aov(PRL ~ sex * treatment , data=df))
  aovtable <- as.data.frame(aovtable$table_body)
  totaldf <- aovtable[5, 3]
  aovtable$df <- paste(aovtable$df, ", " , totaldf, sep = "")
  aovtable$ANOVA <- "PRL ~ sex"
  aovtable$stages <- paste(i, collapse = " vs ")
  aovtable$p <- as.numeric(as.character(aovtable$p))
  aov_manip <- rbind(aov_manip,aovtable)
}

aov_manip  <- aov_manip %>%
  filter(Predictor %in% c( "treatment"))  %>%
  select(stages, ANOVA, Predictor, df, "F", p) %>%
  mutate(sig = ifelse(p < 0.05, "*", " "))
aov_manip
```




```{r}
write.csv(candidates.pit, "../results/16_pitPRL.csv")
write.csv(aov_all, "../results/16_aov_PRLsex.csv")
write.csv(aov_manip, "../results/16_aov_PRLsextreatment.csv")

```

