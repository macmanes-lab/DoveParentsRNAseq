---
title: "04_DESeq_sexes"
output: md_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(cowplot)
library(forcats)
library(caret) # LDA analysis
library(MASS) # LDA analysis

source("../R/functions.R")  # load custom functions 
source("../R/themes.R")  # load custom themes and color palletes

knitr::opts_chunk$set(fig.path = '../figures/LDA/', cache = TRUE,  message=F, comment=FALSE, warning=FALSE)
```

## LDA analysis of characterization and manipulation

```{r readfiles}
colData <- read.csv("../metadata/00_samples.csv", row.names = 1)

charHyp <- colData %>% filter(study == "charcterization", tissue == "hypothalamus") %>% droplevels()
charPit <- colData %>% filter(study == "charcterization", tissue == "pituitary") %>% droplevels()
charGon <- colData %>% filter(study == "charcterization", tissue == "gonad") %>% 
  mutate(tissue = fct_recode(tissue, "gonads" = "gonad")) %>% droplevels()

manipHyp <- colData %>% filter(study == "manipulation", tissue == "hypothalamus") %>% droplevels()
manipPit <- colData %>% filter(study == "manipulation", tissue == "pituitary") %>% droplevels()
manipGon <- colData %>% filter(study == "manipulation", tissue == "gonad") %>% 
  mutate(tissue = fct_recode(tissue, "gonads" = "gonad")) %>% droplevels()


selectvsd <- function(pathtofile, colData){
  
  df <- read.csv(pathtofile, row.names = 1)
  savecols <- as.character(colData$V1) 
  savecols <- as.vector(savecols) 
  df <- df %>% dplyr::select(one_of(savecols)) 
  df <- as.data.frame(t(df))
  df$V1 <- row.names(df)
  return(df)
}

vsd.hyp.train <- selectvsd("../results/06_hypallvsd.csv",  charHyp)
vsd.pit.train <- selectvsd("../results/06_pitallvsd.csv",  charPit)
vsd.gon.train <- selectvsd("../results/06_gonallvsd.csv",  charGon)

vsd.hyp.test <- selectvsd("../results/06_hypallvsd.csv",  manipHyp)
vsd.pit.test <- selectvsd("../results/06_pitallvsd.csv",  manipPit)
vsd.gon.test <- selectvsd("../results/06_gonallvsd.csv",  manipGon)
```



## Linear discriminant analysis (LDA)

http://www.sthda.com/english/articles/36-classification-methods-essentials/146-discriminant-analysis-essentials-in-r/


```{r LDAdfs}

LDanalysis <- function(trainsamples, traindata, testdata, testsamples){
  
  train.data <- left_join(trainsamples, traindata) %>%
    dplyr::select(-V1, -bird, -tissue, -group, -study, -sex)
  
  test.data <- testdata
  
  # Normalize the data. Categorical variables are automatically ignored.
  # Estimate preprocessing parameters
  preproc.param <- train.data %>% 
    preProcess(method = c("center", "scale"))
  
  # Transform the data using the estimated parameters
  train.transformed <- preproc.param %>% predict(train.data)
  test.transformed <- preproc.param %>% predict(test.data)
  
  # LDA analysis
  # Fit the model
  model <- lda(treatment~ ., data = train.transformed)
  # Make predictions
  predictions <- model %>% predict(test.transformed)
  
  # Model accuracy
  print("model accuracy")
  print("predictions$class==test.transformed$treatment)")
  print(mean(predictions$class==test.transformed$treatment))
  
  # results
  print("the samples sizes")
  print(model$counts)
  
  print("the prior probabilities used")
  print(model$prior)
  
  print("svd: the singular values, which give the ratio of the between- and within-group standard deviations on the linear discriminant variables. Their squares are the canonical F-statistics.")
  print(model$svd)
  
  
  #  predictions
  predictions <- model %>% predict(test.transformed)
  head(predictions)
  
  # Predicted classes
  #print(predictions$class, 6)
  # Predicted probabilities of class memebership.
  #print(predictions$posterior, 6) 
  # Linear discriminants
  #print(predictions$x, 3)
  
  
  predictedstage <-  predict(model, test.transformed)$class
  testsamples$predictedstage <- predictedstage
  
  lda.data <- cbind(testsamples, predictions$x)
  
  return(lda.data)
}  

LDA.hyp <- LDanalysis(charHyp, vsd.hyp.train, vsd.hyp.test, manipHyp)
LDA.pit <- LDanalysis(charPit, vsd.pit.train, vsd.pit.test, manipPit)
LDA.gon <- LDanalysis(charGon, vsd.gon.train, vsd.gon.test, manipGon)
```



```{r LDAplots}
library(kableExtra)
#myshapes = c("hypothalamus" = 20,  "pituitary" = 17,  "gonads" = 15)

a <- ggplot(LDA.hyp, aes(x = LD1, LD2, color = predictedstage)) + geom_point(shape = 20) + theme(legend.position = "none") + scale_color_manual(values = colorscharmaip) 
b <- ggplot(LDA.hyp, aes(x = LD1, LD2, color = treatment)) + geom_point(shape = 20) + theme(legend.position = "none") + scale_color_manual(values = colorscharmaip)

plot_grid(a,b) 

c <- ggplot(LDA.pit, aes(x = LD1, LD2, color = predictedstage)) + geom_point(shape = 17) + theme(legend.position = "none") + scale_color_manual(values = colorscharmaip)
d <- ggplot(LDA.pit, aes(x = LD1, LD2, color = treatment)) + geom_point(shape = 17) + theme(legend.position = "none") + scale_color_manual(values = colorscharmaip)

plot_grid(a,b) 

e <- ggplot(LDA.gon, aes(x = LD1, LD2, color = predictedstage)) + geom_point(shape = 15) + theme(legend.position = "none") + scale_color_manual(values = colorscharmaip)
f <- ggplot(LDA.gon, aes(x = LD1, LD2, color = treatment)) + geom_point(shape = 15) + theme(legend.position = "none") + scale_color_manual(values = colorscharmaip)

plot_grid(a,b,c,d,e,f, nrow = 3)
```


```{r LDApredictions}

df1 <- LDA.hyp %>% distinct(treatment, predictedstage) %>%
  group_by(treatment) %>%
  summarize(predictedstages = str_c(predictedstage , collapse = ", "))  %>%
  mutate(tissue = "hypothalamus")
kable(df1)

df2 <- LDA.hyp %>% 
  group_by(treatment,predictedstage) %>%
  summarize(n = n()) %>%
  mutate(tissue = "hypothalamus")
kable(df2)

df3 <- LDA.pit %>% distinct(treatment, predictedstage) %>%
  group_by(treatment) %>%
  summarize(predictedstages = str_c(predictedstage , collapse = ", ")) %>%
  mutate(tissue = "pituitary")
kable(df3)

df4  <- LDA.pit %>% 
  group_by(treatment,predictedstage) %>%
  summarize(n = n()) %>%
  mutate(tissue = "pituitary")
kable(df4)


df5 <- LDA.gon %>% distinct(treatment, predictedstage) %>%
  group_by(treatment) %>%
  summarize(predictedstages = str_c(predictedstage , collapse = ", ")) %>%
  mutate(tissue = "gonads")
kable(df5)

df6 <- LDA.gon %>% 
  group_by(treatment,predictedstage) %>%
  summarize(n = n()) %>%
  mutate(tissue = "gonads")
kable(df6)
```

