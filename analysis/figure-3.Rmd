---
title: "Fig3"
output: md_document
---

# Figure 3: All things prolactin

```{r setup}
library(tidyverse)
library(cowplot)
library(ggimage)
library(apaTables)
library(factoextra)
library(corrr)
library(ggpubr)
library(ggrepel)
library(ggsignif)
library(forcats)

source("../R/themes.R") 
source("../R/functions.R")
source("../R/genelists.R")


knitr::opts_chunk$set(fig.path = '../figures/',message=F, warning=FALSE)
```

## import limma counts and sample info

```{r data}
countData <- read_csv("../results/01_limma.csv") %>%
  column_to_rownames(var = "X1")
countData <- as.data.frame(t(countData))
head(countData[1:3])

colData <- read_csv("../metadata/04_colData.csv") %>%
  mutate(treatment = factor(treatment, levels = alllevels),
         tissue = factor(tissue, levels = tissuelevels),
         temprowname = V1) %>% 
  column_to_rownames(var = "temprowname") 
head(colData)
# check ready for analysis
# row.names(countData) == row.names(colData)
head(row.names(countData) == row.names(colData))
```


## PCA data

```{r PCA}
# pca relies on count data from limma

pca1f <- subsetmakepca("pituitary", charlevels, "female")	
pca2f <- makefvizdf("pituitary", charlevels, "female")	

pca1m <- subsetmakepca("pituitary", charlevels, "male")	
pca2m <- makefvizdf("pituitary", charlevels, "male")

pca1 <- subsetmakepca("pituitary", charlevels, sexlevels)	
pca2 <- makefvizdf("pituitary", charlevels, sexlevels)	
```

## candidate genes, hypotheses genes, and data-driven genes


```{r}
# candidate counts for boxplots
candidatevsd <- read_csv("../results/06_candidatevsd.csv") %>%
  mutate(treatment = factor(treatment)) %>%
  mutate(tissue = factor(tissue, levels = charlevels),
        treatment = factor(treatment, levels = charlevels)) %>%
  drop_na()
head(candidatevsd)

## prlpit
PRLpit <- candidatevsd %>% 
  filter(gene == "PRL", tissue == "pituitary")

# list of pvalue and DEGs
allDEG <- read_csv("../results/06_allDEG.csv")  %>%
  mutate(direction = factor(direction, levels = hypothesislevels))

# candidate genes from GO and literature
parentalcaregenes <- read_csv("../metadata/03_parentalcaregenes.csv") %>% 
  distinct(literature)  %>% drop_na() %>% pull(literature)

## genes WGCNA prl module
WGCNAgenes <- read_csv("../results/05_PRLmodule.csv") %>% pull(x)

# DEGs infor for PRL and external
hilodf <- allDEG %>%
  filter(comparison == "lo_hi")  %>%
  arrange(padj) 
hilogenes <- hilodf %>%  top_n(20) %>% pull(gene)

eggchickdf <- allDEG %>%
  filter(!comparison %in% c("lo_hi", "nest_eggs", "nest_chicks"))  %>%
  arrange(padj)  
eggchickgenes <- eggchickdf %>%  top_n(20) %>% pull(gene)


## data-driven PRL genes
pithilo <- makecorrdf("female", "pituitary", hilogenes)
pitWGCNA <- makecorrdf("female", "pituitary", WGCNAgenes[1:20])


## https://www.gynecologiconcology-online.net/article/S0090-8258(19)30069-1/fulltext
cancergenes <- makecorrdf("female", "pituitary", c(shaidgenes,suszynskaagenes))


## for scatter correlation (not currently usesed)
candidatevsdwide <- candidatevsd  %>%
    pivot_wider(names_from = gene, values_from = counts) 
pitwide <- subsetcandidatevsdwide(sexlevels, "pituitary")

```





```{r fig3, fig.width=7.25, fig.height=7.25}

a1 <- plotpc12(pca1, pca2, pca1$treatment, allcolors, "Pituitary gene expression", NULL)   
a2 <- plotprolactin(PRLpit, PRLpit$counts, "PRL", NULL) + 
  theme(axis.text.x = element_text(angle = 25))  +
  facet_wrap(~sex)
a <- plot_grid(a1,a2, labels = c("A", "B"), label_size = 8, rel_widths = c(1,1))

b1 <- png::readPNG("../figures/images/fig_fig3b.png")
b1 <- ggdraw() +  draw_image(b1, scale = 1)
b2 <- makenewbargraph("pituitary", "female","eggs_chicks", 0, 4000) + labs(subtitle = "female")  + labs(title = " ") +
  scale_x_discrete(labels = "eggs vs. chicks")
b3 <- makenewbargraph("pituitary", "male", "eggs_chicks", 0, 4000)  + labs(subtitle = "male")  + labs(title = " ") +
  theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), 
        axis.text.y = element_blank(), axis.line.y = element_blank()) +
  scale_x_discrete(labels = "eggs vs. chicks")
b4 <- makenewbargraph("pituitary", "male", "lo_hi", 0, 4000)  +
  scale_x_discrete(labels = "lo vs. hi PRL")
b5 <- makenewbargraph("pituitary", "female", "lo_hi", 0, 4000)   + 
  theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), 
        axis.text.y = element_blank(), axis.line.y = element_blank()) +
  scale_x_discrete(labels = "lo vs. hi PRL")
b25 <- plot_grid(b2,b3,b4,b5, nrow = 2, rel_widths = c(1.2,1), rel_heights = c(1.2,1))

b6 <-  plottopDEGs(eggchickdf, "female",  "LFC eggs vs. chicks", "Top 10 female DEGs") + labs(title = " ")
b7 <-  plottopDEGs(eggchickdf, "male",  "LFC eggs vs. chicks", "Top 10 male DEGs") + labs(title = " ")
b8 <-  plottopDEGs(hilodf, "female",  "LFC lo vs. hi PRL", NULL)
b9 <-  plottopDEGs(hilodf, "male",  "LFC lo vs. hi PRL", NULL)
b15 <- plot_grid(b1,b25,nrow = 1, rel_widths = c(1.2,1))
b69 <- plot_grid(b6,b7,b8,b9, align = "v" , rel_heights = c(1.2,1))
b <- plot_grid(b15,b69, labels = c("C"), label_size = 8, rel_widths = c(1.2,1))

c1 <- plotcorrplot(pithilo, NULL) + theme(legend.position = "none") + labs(subtitle = "Top 20 lo vs. hi PRL DEGs") 
c2 <- plotcorrplot(pitWGCNA, NULL) + theme(legend.position = "none") + labs(subtitle = "20 genes from WGCNA module with PRL") 
c3 <- plotcorrplot(cancergenes, NULL) + theme(legend.position = "right") + labs(subtitle = "Breast, ovary, piuitary cancer genes") 
c <- plot_grid(c1,c2,c3, nrow = 1, labels = c("D", "E", "F"), label_size = 8, rel_widths = c(1,1,1.4))
c


fig3 <- plot_grid(a, b, c, nrow = 3, rel_heights = c(1.2,2,1.8))
fig3


```
 
```{r savefiles}
#write.csv(PRLpit,"../results/PRLvsd.csv", row.names = F)

#pdf(file="../figures/fig3-1.pdf", width=7.25, height=7.25)
#plot(fig3)
#dev.off()
```




```{r forvictoria, eval = F}
## PRL and PRLR in three tissues 

candidatevsd <- candidatevsd %>%
  filter(treatment %in%  c("early", "extend", charlevels))

p1 <- candidateboxplot("hypothalamus", c("PRL"), sexlevels) + labs(subtitle = "hypothalamus", title = "PRL")
p2 <- candidateboxplot("pituitary", c("PRL"), sexlevels) + labs(subtitle = "pituitary")
p3 <- candidateboxplot("gonad", c("PRL"), sexlevels) + labs(subtitle = "gonads") + theme(axis.text.x = element_text(angle = 45))

p4 <- candidateboxplot("hypothalamus", c("PRLR"), sexlevels) + labs(subtitle = " ", title = " ") 
p5 <- candidateboxplot("pituitary", c("PRLR"), sexlevels) + labs(subtitle = " ")
p6 <- candidateboxplot("gonad", c("PRLR"), sexlevels) + theme(axis.text.x = element_text(angle = 45))+ labs(subtitle = " ")

plot_grid(p1,p4,p2,p5,p3,p6, ncol = 2, rel_heights = c(1.2,1,1.2))
```



