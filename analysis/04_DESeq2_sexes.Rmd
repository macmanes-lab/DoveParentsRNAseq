---
title: "04_DESeq_sexes"
output: md_document
---

```{r setup, message=F, comment=FALSE, warning=FALSE, results='hide'}

library(tidyverse)
library(DESeq2)
library(cowplot)
library(RColorBrewer)
library(pheatmap)
library(kableExtra)
library(viridis)


# load custom functions  
source("../R/functions.R")   

knitr::opts_chunk$set(fig.path = '../figures/sexes/', cache = TRUE)
```

## Starting with all the data

```{r readfiles}
# import "colData" which contains sample information and "countData" which contains read counts
a.colData <- read.csv("../metadata/00_samples.csv", header = T, row.names = 1)
a.countData <- read.csv("../results/00_counts.csv", header = T, row.names = 1)
geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)

# set levels
levels(a.colData$treatment)

a.colData$treatment <- factor(a.colData$treatment, levels = 
                             c("control", "bldg", "lay",
                               "inc.d3", "m.inc.d3", 
                               "inc.d9", "m.inc.d8", "m.inc.d9",
                               "inc.d17", "m.inc.d17",
                               "hatch",  "m.n2"  ,
                               "n5", "prolong", "extend", "n9" ))
                               
                               
a.colData$sextissue <- as.factor(paste(a.colData$sex, a.colData$tissue, sep = "_"))

a.colData$lastday <- ifelse(grepl("m.inc.d3|m.inc.d9|m.inc.d17|m.n2", a.colData$treatment), "empty nest", 
                    ifelse(grepl("m.inc.d8|hatch|extend", a.colData$treatment),"chicks hatch",      
                     ifelse(grepl("n5", a.colData$treatment),"chicks early",
                     ifelse(grepl("n9", a.colData$treatment),"chicks later",
                     ifelse(grepl("control", a.colData$treatment),"control",
                     ifelse(grepl("bldg", a.colData$treatment),"nest building",
                     ifelse(grepl("prolong", a.colData$treatment),"eggs delay",
                      ifelse(grepl("lay", a.colData$treatment),"eggs lay",
                      ifelse(grepl("inc.d3", a.colData$treatment),"eggs early",
                     ifelse(grepl("inc.d9", a.colData$treatment),"eggs middle",
                    ifelse(grepl("inc.d17", a.colData$treatment),"eggs later", NA)))))))))))

a.colData$penultimate <-  ifelse(grepl("extend", a.colData$treatment),"eggs delay",  
                          ifelse(grepl("m.n2", a.colData$treatment),"chicks hatch",
                     ifelse(grepl("n5", a.colData$treatment),"chicks early",
                     ifelse(grepl("n9", a.colData$treatment),"chicks later",
                     ifelse(grepl("control", a.colData$treatment),"control",
                     ifelse(grepl("bldg|lay", a.colData$treatment),"nest building",
                     ifelse(grepl("prolong", a.colData$treatment),"eggs delay",
                      ifelse(grepl("inc.d3|m.inc.d3", a.colData$treatment),"eggs early",
                     ifelse(grepl("inc.d9|m.inc.d9|m.inc.d8", a.colData$treatment),"eggs middle",
                    ifelse(grepl("inc.d17|hatch", a.colData$treatment),"eggs later", NA))))))))))



a.colData$xlabel <- a.colData$treatment
levels(a.colData$xlabel) <-  c("control", "nest building", "egg lay",
                               "eggs early", "eggs early remove", 
                               "eggs mid", "eggs mid hatch", "eggs mid remove",
                               "eggs end", "eggs end remove",
                               "chicks hatch",  "chicks hatch remove"  ,
                               "chicks mid", "eggs delay", "eggs delay hatch", "chicks end")



a.colData$lastday <- factor(a.colData$lastday, levels =  c("control", "nest building", "eggs lay",
                               "eggs early",  
                               "eggs middle", 
                               "eggs later", 
                               "eggs delay",
                               "chicks hatch",
                               "chicks early", 
                               "chicks later", 
                               "empty nest"))

a.colData$penultimate <- factor(a.colData$penultimate, levels =  c("control", "nest building",
                               "eggs early",  
                               "eggs middle", 
                               "eggs later", 
                               "eggs delay",
                               "chicks hatch",
                               "chicks early", 
                               "chicks later"))

colorlastday <-  c("control" = "#636363", 
                   "nest building" = "#fb6a4a", 
                   "eggs lay" = "#c7e9c0",
                   "eggs early" = "#a1d99b",
                   "eggs middle" = "#74c476", 
                   "eggs later" = "#31a354",  
                   "eggs delay" = "#006d2c",
                   "chicks hatch" = "#cbc9e2",   
                   "chicks early" = "#9e9ac8", 
                   "chicks later" = "#6a51a3",
                   "empty nest" = "#a50f15")

colorpenultimate <- c("control" = "#636363", 
                      "nest building" = "#fb6a4a", 
                      "eggs early" = "#a1d99b",
                   "eggs middle" = "#74c476", 
                   "eggs later" = "#31a354",  
                   "eggs delay" = "#006d2c",
                   "chicks hatch" = "#cbc9e2",   
                   "chicks early" = "#9e9ac8", 
                   "chicks later" = "#6a51a3")

colorlastdaybad <-  c("control" = "#636363", 
                   "nest bldg" = "#fb6a4a", 
                   "lay" = "#c7e9c0",
                   "incubate begin" = "#a1d99b",
                   "incubate middle" = "#74c476", 
                   "incubate end" = "#31a354",  
                   "eggs late" = "#006d2c",
                   "nestling being" = "#cbc9e2",  
                   "nestling begin" = "#cbc9e2",   
                   "nestling middle" = "#9e9ac8", 
                   "nestling end" = "#6a51a3",
                   "empty nest" = "#a50f15")

colorpenultimatebad <- c("control" = "#636363", 
                      "nestbldg" = "#fb6a4a", 
                      "incubate begin" = "#a1d99b",
                   "incubate middle" = "#74c476", 
                   "incubate end" = "#31a354",  
                   "eggs late" = "#006d2c",
                   "nestling begin" = "#cbc9e2",   
                   "nestling middle" = "#9e9ac8", 
                   "nestling end" = "#6a51a3")

summary(a.colData[c(7,3,4,5,8,9, 10,11)])

```

## Run DESeq on all subsets of the data


```{r dds, cache = T}
dds.female_hypothalamus <- subsetDESeq(a.colData, a.countData, "female_hypothalamus")
dds.female_pituitary <- subsetDESeq(a.colData, a.countData, "female_pituitary" )
dds.female_gonad <- subsetDESeq(a.colData, a.countData, "female_gonad" )
dds.male_hypothalamus <- subsetDESeq(a.colData, a.countData, "male_hypothalamus" )
dds.male_pituitary <- subsetDESeq(a.colData, a.countData, "male_pituitary"  )
dds.male_gondad <- subsetDESeq(a.colData, a.countData, "male_gonad")
```


## Calculate and plot total DEGs

```{r totalDEGs, eval = F}

#create list of groups for deseq contrasts
group1 <- levels(a.colData$treatment)
group2 <- group1

a <- plottotalDEGs(dds.female_hypothalamus, "female hypothalamus")
b <- plottotalDEGs(dds.female_pituitary, "female pituitary")
c <- plottotalDEGs(dds.female_gonad, "female gonad")
d <- plottotalDEGs(dds.male_hypothalamus, "male hypothalamus")
e <- plottotalDEGs(dds.male_pituitary, "male pituitary")
f <- plottotalDEGs(dds.male_gondad, "male gonad")

plot_grid(a + theme(legend.position = "none"),
          b + theme(legend.position = "none"),
          c,
          d + theme(legend.position = "none"),
          e + theme(legend.position = "none"),
          f,
          nrow = 2, rel_widths = c(0.3, 0.3, 0.4)) 
```

## Calculate and plot principal components

```{r pcadf}
p1 <- plotPCAs(dds.female_hypothalamus, "female hypothalamus")
p2 <- plotPCAs(dds.female_pituitary, "female pituitary")      
p3 <- plotPCAs(dds.female_gonad, "female gonad")
p4 <- plotPCAs(dds.male_hypothalamus, "male hypothalamus")
p5 <- plotPCAs(dds.male_pituitary, "male pituitary")
p6 <- plotPCAs(dds.male_gondad, "male gonad")
p1
p2
p3
p4
p5
p6
```

```{r pca, fig.dim = c(12, 10)}
mylegend <- get_legend(p1)


allPC1s <- plot_grid(p1 +  theme(legend.position = "none",
               axis.title.x=element_blank(),axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
    p4 + theme(legend.position = "none",
               axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
    p2 + theme(legend.position = "none",
               axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()),
    p5 + theme(legend.position = "none",
               axis.title.x=element_blank(), axis.text.x=element_blank(),axis.ticks.x=element_blank()),
    p3 + theme(legend.position = "none", axis.ticks.x=element_blank()),
    p6 + theme(legend.position = "none", axis.ticks.x=element_blank()),
    nrow = 3, rel_heights = c(0.3, 0.3, 0.4))

pc1grid <- plot_grid(allPC1s, mylegend, ncol = 2, rel_widths = c(1.0, 0.15))
pc1grid

pdf("../figures/sexes/pc1grid.pdf", width = 12, height = 10)
plot(pc1grid)
dev.off()

```

## heamap with minimum pvalue

```{r pheatmap, eval = F}
makepheatmap(dds.female_hypothalamus, a.colData, "female hypothalamus")
makepheatmap(dds.female_pituitary, "female pituitary")
makepheatmap(dds.female_gonad, "female gonad")
makepheatmap(dds.male_hypothalamus, "male hypothalamus")
makepheatmap(dds.male_pituitary, "male pituitary")
makepheatmap(dds.male_gondad, "male gonad")        
```

## candidate genes

```{r candidates, eval =F}
plotcandidates(dds.female_hypothalamus, a.colData, "female hypothalamus")
plotcandidates(dds.female_pituitary, "female pituitary")
plotcandidates(dds.female_gonad, "female gonad")
plotcandidates(dds.male_hypothalamus, "male hypothalamus")
plotcandidates(dds.male_pituitary, "male pituitary")
plotcandidates(dds.male_gondad, "male gonad")
```

