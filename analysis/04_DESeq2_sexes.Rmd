---
title: "04_DESeq_sexes"
output: md_document
---

```{r setup, message=F, comment=FALSE, warning=FALSE, results='hide'}

library(tidyverse)
library(DESeq2)
library(cowplot)
library(RColorBrewer)
library(pheatmap)
library(kableExtra)
library(viridis)
library(forcats)
library("wesanderson")

library("BiocParallel")
register(MulticoreParam(4))

source("../R/functions.R")  # load custom functions 
source("../R/themes.R")  # load custom themes and color palletes

knitr::opts_chunk$set(fig.path = '../figures/sexes/', cache = TRUE)
```

## DEseq2 analysis on characterization. Looking at treatment AND sex for each tissue

```{r readfiles}
# import "colData" which contains sample information and "countData" which contains read counts
c.colData <- read.csv("../metadata/00_colData_characterization.csv", header = T, row.names = 1)
c.countData <- read.csv("../results/00_countData_characterization.csv", header = T, row.names = 1)
geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)

# set levels
c.colData$treatment <- factor(c.colData$treatment, levels = 
                              c("control",  "bldg", "lay", "inc.d3", "inc.d9", "inc.d17", "hatch", "n5", "n9"))
levels(c.colData$treatment)
c.colData$sextissue <- as.factor(paste(c.colData$sex, c.colData$tissue, sep = "_"))
summary(c.colData[c(7,3,4,5,8)])
```



```{r dds}
dds.hypothalamus <- subsetDESeq2(c.colData,  c.countData, c("female_hypothalamus","male_hypothalamus") )
dds.pituitary <- subsetDESeq2(c.colData,  c.countData, c("female_pituitary", "male_pituitary" ) )
dds.gonad <- subsetDESeq2(c.colData,  c.countData, c("female_gonad", "male_gonad") )
```

## PCA

```{r pca}
hypPCA <- returnPCAs2(dds.hypothalamus)
plotPC12(hypPCA, "female and male hypothalamus")

pitPCA <- returnPCAs2(dds.pituitary)
plotPC12(pitPCA, "female and male pituitary")

gonPCA <- returnPCAs2(dds.gonad)
plotPC12(gonPCA, "female and male gonad")
```


## Linear discriminant analysis (LDA)

http://www.sthda.com/english/articles/36-classification-methods-essentials/146-discriminant-analysis-essentials-in-r/

```{r LDA}
library(caret)
theme_set(theme_classic())

# Load the data
data("iris")

# Split the data into training (80%) and test set (20%)
set.seed(123)
training.samples <- iris$Species %>%
  createDataPartition(p = 0.8, list = FALSE)
train.data <- iris[training.samples, ]
test.data <- iris[-training.samples, ]

# Normalize the data. Categorical variables are automatically ignored.
# Estimate preprocessing parameters
preproc.param <- train.data %>% 
  preProcess(method = c("center", "scale"))

# Transform the data using the estimated parameters
train.transformed <- preproc.param %>% predict(train.data)
test.transformed <- preproc.param %>% predict(test.data)

# LDA analysis
library(MASS)
# Fit the model
model <- lda(Species~., data = train.transformed)
# Make predictions
predictions <- model %>% predict(test.transformed)
# Model accuracy
mean(predictions$class==test.transformed$Species)

# results
model
plot(model)

# make predictions
predictions <- model %>% predict(test.transformed)
names(predictions)

# Predicted classes
head(predictions$class, 6)
# Predicted probabilities of class memebership.
head(predictions$posterior, 6) 
# Linear discriminants
head(predictions$x, 3) 

# LDA plot using ggplot2 
lda.data <- cbind(train.transformed, predict(model)$x)
ggplot(lda.data, aes(LD1, LD2)) +
  geom_point(aes(color = Species))

# model accuracy 
mean(predictions$class==test.transformed$Species)
```




