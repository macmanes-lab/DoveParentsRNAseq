---
title: "04_DESeq_sexes"
output: md_document
---

```{r setup, include = FALSE}

library(tidyverse)
library(DESeq2)
library(cowplot)
library(pheatmap)
library(viridis)
library(forcats)
library(caret) # LDA analysis
library(MASS) # LDA analysis

library(BiocParallel)
register(MulticoreParam(6))

source("../R/functions.R")  # load custom functions 
source("../R/themes.R")  # load custom themes and color palletes

knitr::opts_chunk$set(fig.path = '../figures/sexes/', cache = TRUE,  message=F, comment=FALSE, warning=FALSE)
```

## DEseq2 analysis on characterization. Looking at treatment AND sex for each tissue

```{r readfiles}
# import "colData" which contains sample information and "countData" which contains read counts
c.colData <- read.csv("../metadata/00_colData_characterization.csv", header = T, row.names = 1)
c.countData <- read.csv("../results/00_countData_characterization.csv", header = T, row.names = 1)
geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)

# set levels
c.colData$treatment <- factor(c.colData$treatment, levels = 
                              c("control",  "bldg", "lay", "inc.d3", "inc.d9", "inc.d17", "hatch", "n5", "n9"))

c.colData$sextissue <- as.factor(paste(c.colData$sex, c.colData$tissue, sep = "_"))

c.colData <- c.colData %>%
    mutate(hypothesis = fct_recode(treatment,
                            "anticipation" = "control",
                            "anticipation" = "bldg",
                            "incubation" = "lay",
                            "incubation" = "inc.d3",
                            "incubation" = "inc.d9",
                            "incubation" = "inc.d17",
                            "hatchling.care" = "hatch",
                            "hatchling.care" = "n5",
                            "hatchling.care" = "n9"))

# drop columsn that are bad for model AND not needed for later joining
c.colData$bird <- NULL
c.colData$tissue <- NULL
c.colData$study <- NULL
c.colData$group <- NULL
head(c.colData)
```



```{r dds}
dds.hypothalamus <- subsetDESeq2(c.colData,  c.countData, c("female_hypothalamus","male_hypothalamus") )
dds.pituitary <- subsetDESeq2(c.colData,  c.countData, c("female_pituitary", "male_pituitary" ) )
dds.gonad <- subsetDESeq2(c.colData,  c.countData, c("female_gonad", "male_gonad") )
```


## total degs

```{r totalDEGs, results = 'hide', eval = F}
DEGs.pituitary <- returntotalDEGs(dds.pituitary)
plottotalDEGs(DEGs.pituitary, "Male & Female Pituitary DEGs")
```

## Variance stabilized data

```{r vsd}
vsd.hyp <- vst(dds.hypothalamus, blind=FALSE) 
vsd.pit <- vst(dds.pituitary, blind=FALSE) 
vsd.gon <- vst(dds.gonad, blind=FALSE) 

vsd.hyp.df <- vsd.dataframe(vsd.hyp) 
vsd.pit.df <- vsd.dataframe(vsd.pit) 
vsd.gon.df <- vsd.dataframe(vsd.gon) 
```





## PCA

```{r pca}
hypPCA <- returnPCAs2(vsd.hyp)
plotPC12(hypPCA, "Hypothalamus")

pitPCA <- returnPCAs2(vsd.pit)
plotPC12(pitPCA, "Pituitary")

gonPCA <- returnPCAs2(vsd.gon)
plotPC12(gonPCA, "Gonad")
```


## Linear discriminant analysis (LDA)

http://www.sthda.com/english/articles/36-classification-methods-essentials/146-discriminant-analysis-essentials-in-r/

```{r LDA}
LDAanalysis <- function(mydds, mycolData, mysubtitle){
  # data prep
  vsd <- vst(mydds, blind=FALSE) # variance stabilized 
  tvsd <- as.data.frame(t(assay(vsd)))   # get vsd counts and transform

  #tvsd <- tvsd[, sample(ncol(tvsd), 20)] # select 20 random genes
  tvsd$V1 <- row.names(tvsd)             # prep for joining

  mydata <- left_join(tvsd, mycolData, by = "V1")  # merge counts and variables
  mydata$V1 <- NULL
  mydata$sextissue <- NULL
  
  # Split the data into training (80%) and test set (20%)
  set.seed(175)

  training.samples <- mydata$treatment %>%
    createDataPartition(p = 0.8, list = FALSE)
  train.data <- mydata[training.samples, ]
  test.data <- mydata[-training.samples, ]

  # Normalize the data. Categorical variables are automatically ignored.
  # Estimate preprocessing parameters
  preproc.param <- train.data %>% 
    preProcess(method = c("center", "scale"))

  # Transform the data using the estimated parameters
  train.transformed <- preproc.param %>% predict(train.data)
  test.transformed <- preproc.param %>% predict(test.data)

  # LDA analysis
  # Fit the model
  model <- lda(hypothesis~ ., data = train.transformed)
  # Make predictions
  predictions <- model %>% predict(test.transformed)
  # Model accuracy
  mean(predictions$class==test.transformed$hypothesis)

  # results
  print(model)

  # make predictions
  predictions <- model %>% predict(test.transformed)
  
  # Predicted classes
  head(predictions$class, 6)
  # Predicted probabilities of class memebership.
  head(predictions$posterior, 6) 
  # Linear discriminants
  head(predictions$x, 3)

  # LDA plot using ggplot2 
  lda.data <- cbind(train.transformed, predict(model)$x)
  p <- ggplot(data = lda.data, aes(LD1, LD2, color = hypothesis, shape = sex)) +
    geom_point() +
    labs(subtitle = mysubtitle)
  plot(p)

  # model accuracy 
  print(mean(predictions$class==test.transformed$hypothesis))
}

colDataHyp <- subsetcolData2(c.colData, c("female_hypothalamus", "male_hypothalamus"))
colDataPit <- subsetcolData2(c.colData, c("female_pituitary", "male_pituitary"))
colDataGon <- subsetcolData2(c.colData, c("female_gonad", "male_gonad"))

LDAanalysis(dds.hypothalamus, colDataHyp, "Hypothalamus")
LDAanalysis(dds.pituitary, colDataPit, "Pituitary")
LDAanalysis(dds.gonad, colDataGon, "Gonad")
```

```{r LDA2}

LDAanalysis2 <- function(mydds, mycolData, mysubtitle){
  # data prep
  vsd <- vst(mydds, blind=FALSE) # variance stabilized 
  tvsd <- as.data.frame(t(assay(vsd)))   # get vsd counts and transform

  #tvsd <- tvsd[, sample(ncol(tvsd), 20)] # select 20 random genes
  tvsd$V1 <- row.names(tvsd)             # prep for joining

  mydata <- left_join(tvsd, mycolData, by = "V1")  # merge counts and variables
  mydata$V1 <- NULL
  mydata$sextissue <- NULL
  mydata$hypothesis <- NULL

  # Split the data into training (80%) and test set (20%)
  set.seed(175)

  training.samples <- mydata$treatment %>%
    createDataPartition(p = 0.8, list = FALSE)
  train.data <- mydata[training.samples, ]
  test.data <- mydata[-training.samples, ]

  # Normalize the data. Categorical variables are automatically ignored.
  # Estimate preprocessing parameters
  preproc.param <- train.data %>% 
    preProcess(method = c("center", "scale"))

  # Transform the data using the estimated parameters
  train.transformed <- preproc.param %>% predict(train.data)
  test.transformed <- preproc.param %>% predict(test.data)

  # LDA analysis
  # Fit the model
  model <- lda(treatment~ ., data = train.transformed)
  # Make predictions
  predictions <- model %>% predict(test.transformed)
  # Model accuracy
  mean(predictions$class==test.transformed$treatment)

  # results
  print(model)

  # make predictions
  predictions <- model %>% predict(test.transformed)
  
  # Predicted classes
  head(predictions$class, 6)
  # Predicted probabilities of class memebership.
  head(predictions$posterior, 6) 
  # Linear discriminants
  head(predictions$x, 3)

  # LDA plot using ggplot2 
  lda.data <- cbind(train.transformed, predict(model)$x)
  p <- ggplot(data = lda.data, aes(LD1, LD2, color = treatment, shape = sex)) +
    geom_point() +
    labs(subtitle = mysubtitle)
  plot(p)

  # model accuracy 
  print(mean(predictions$class==test.transformed$hypothesis))
}

LDAanalysis2(dds.hypothalamus, colDataHyp, "Hypothalamus")
LDAanalysis2(dds.pituitary, colDataPit, "Pituitary")
LDAanalysis2(dds.gonad, colDataGon, "Gonad")

```


