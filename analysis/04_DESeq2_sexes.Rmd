---
title: "04_DESeq_sexes"
output: md_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(DESeq2)
library(cowplot)
library(pheatmap)
library(viridis)
library(forcats)
library(caret) # LDA analysis
library(MASS) # LDA analysis
library(ggtext) # for pretty plots
library(ctsGE)

library(BiocParallel)
register(MulticoreParam(6))

source("../R/functions.R")  # load custom functions 
source("../R/themes.R")  # load custom themes and color palletes

knitr::opts_chunk$set(fig.path = '../figures/sexes/', cache = TRUE,  message=F, comment=FALSE, warning=FALSE)
```

## DEseq2 analysis on characterization. Looking at treatment AND sex for each tissue

```{r readfiles}
# import "colData" which contains sample information and "countData" which contains read counts
c.colData <- read.csv("../metadata/00_colData_characterization.csv", header = T, row.names = 1)
c.countData <- read.csv("../results/00_countData_characterization.csv", header = T, row.names = 1)
geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)

# set treatment levels
c.colData$treatment <- factor(c.colData$treatment, levels = 
                              c("control",  "bldg", "lay", "inc.d3", "inc.d9", "inc.d17", "hatch", "n5", "n9"))

# craete variable that will be critical for subset later on
c.colData$sextissue <- as.factor(paste(c.colData$sex, c.colData$tissue, sep = "_"))

# ceate new variable for hypothesis testing
c.colData <- c.colData %>%
    mutate(hypothesis = fct_recode(treatment,
                            "anticipation" = "control",
                            "anticipation" = "bldg",
                            "incubation" = "lay",
                            "incubation" = "inc.d3",
                            "incubation" = "inc.d9",
                            "incubation" = "inc.d17",
                            "hatchling.care" = "hatch",
                            "hatchling.care" = "n5",
                            "hatchling.care" = "n9"))

# drop columsn that are bad for model AND not needed for later joining
c.colData$bird <- NULL
c.colData$tissue <- NULL
c.colData$study <- NULL
c.colData$group <- NULL
head(c.colData)
```



```{r dds}
dds.hypothalamus <- subsetDESeq2(c.colData,  c.countData, c("female_hypothalamus","male_hypothalamus") )
dds.pituitary <- subsetDESeq2(c.colData,  c.countData, c("female_pituitary", "male_pituitary" ) )
dds.gonad <- subsetDESeq2(c.colData,  c.countData, c("female_gonad", "male_gonad") )
```


## total degs

```{r totalDEGs, results = 'hide', eval = F}
DEGs.pituitary <- returntotalDEGs(dds.pituitary)
plottotalDEGs(DEGs.pituitary, "Male & Female Pituitary DEGs")
```

## Variance stabilized data

```{r vsd}
vsd.hyp <- vst(dds.hypothalamus, blind=FALSE) 
vsd.pit <- vst(dds.pituitary, blind=FALSE) 
vsd.gon <- vst(dds.gonad, blind=FALSE) 

vsd.hyp.df <- vsd.dataframe(vsd.hyp) 
vsd.pit.df <- vsd.dataframe(vsd.pit) 
vsd.gon.df <- vsd.dataframe(vsd.gon) 
```

## PCA

```{r pca}
hypPCA <- returnPCAs2(vsd.hyp)
plotPC12(hypPCA, "Hypothalamus")

pitPCA <- returnPCAs2(vsd.pit)
plotPC12(pitPCA, "Pituitary")

gonPCA <- returnPCAs2(vsd.gon)
plotPC12(gonPCA, "Gonad")
```


## Linear discriminant analysis (LDA)

http://www.sthda.com/english/articles/36-classification-methods-essentials/146-discriminant-analysis-essentials-in-r/


```{r LDAdfs}
# prep col data for LDA
colDataHyp <- subsetcolData2(c.colData, c("female_hypothalamus", "male_hypothalamus"))
colDataPit <- subsetcolData2(c.colData, c("female_pituitary", "male_pituitary"))
colDataGon <- subsetcolData2(c.colData, c("female_gonad", "male_gonad"))

# LDA for treatment (9 groups)
LDA.hyp1 <- LDAdata.treatment(vsd.hyp, colDataHyp)
LDA.pit1 <- LDAdata.treatment(vsd.pit, colDataPit)
LDA.gon1 <- LDAdata.treatment(vsd.gon, colDataGon)

# LDA for hypothesis (3 groups)

LDA.hyp2 <- LDAdata.hypothesis(vsd.hyp, colDataHyp)
LDA.pit2 <- LDAdata.hypothesis(vsd.pit, colDataPit)
LDA.gon2 <- LDAdata.hypothesis(vsd.gon, colDataGon)
```

```{r LDA, fig.width = 9}
# treatment
a <- LDAplot.treatment(LDA.hyp1 , "Hypothalamus model 1", "parental state ~ .  0.277 pred. acc.",
                        "LD1, F = 7.1504779", "LD2, F = 2.4219585")
b <- LDAplot.treatment(LDA.pit1 ,  "Pituitary model 1", "parental state ~ .  0.405 pred. acc.",
                        "LD1, F = 9.6144160", "LD2, F = 3.7773314")
c <- LDAplot.treatment(LDA.gon1 , "Gonad model 1", "parental state ~ .  has 0.297 pred. acc.",
                        "LD1, F = 6.137500", "LD2, F = 3.320437")

c <- c + theme(legend.direction = "horizontal")
mylegend <- get_legend(c)

temp <- plot_grid(a + theme(legend.position = "none"),
                  b + theme(legend.position = "none"),
                  c + theme(legend.position = "none"), nrow = 1)


plot_grid(temp, mylegend, nrow = 2, rel_heights = c(1,0.3))

# hypothesis
d <- LDAplot.hypothesis(LDA.hyp2 , "Hypothalamus model 2", "parental stage ~ .  0.432 pred. acc.",
                        "LD1, F = 7.386458", "LD2, F = 3.720794")
e <- LDAplot.hypothesis(LDA.pit2 ,  "Pituitary model 2", "parental stage ~ .  0.473 pred. acc.",
                        "LD1, F = 7.846659", "LD2, F = 5.076861")
f <- LDAplot.hypothesis(LDA.gon2 , "Gonad model 2", "parental stage ~ .  has 0.368 pred. acc.",
                        "LD1, F = 6.029069", "LD2, F = 3.837591")

f <- f + theme(legend.direction = "horizontal")
mylegend <- get_legend(f)

temp <- plot_grid(d + theme(legend.position = "none"),
                  e + theme(legend.position = "none"),
                  f + theme(legend.position = "none"), nrow = 1)


plot_grid(temp, mylegend, nrow = 2, rel_heights = c(1,0.3))
```

## plot genes in a  PRL WGCNA module

```{r wgcna, eval = T, fig.width=6, fig.height=6}
# pitutiary expression

plotWGCNAcandidates(vsd.pit, c("NP_990797.2"), colDataPit, "PRL expression, Pituitary")
plotWGCNAcandidates(vsd.pit, c("NP_001090992.1"), colDataPit, "VIP1R expression, Pituitary")
plotWGCNAcandidates(vsd.pit, c("NP_990797.2", "NP_001090992.1"), colDataPit, "PRL & VIP1R expression, Pituitary")
plotWGCNAcandidates(vsd.pit, c("NP_990136.1", "NP_001035179.1"), colDataPit, "TH & AR expression, Pituitary")
plotWGCNAcandidates(vsd.pit, c("NP_990797.2", "NP_001090992.1","NP_990136.1", "NP_001035179.1", "NP_001026269.1"), 
                    colDataPit, "PRL, PRLR, VIP1R, POMC, TH & AR expression, Pituitary")
plotWGCNAcandidates(vsd.pit, c("XP_015155078.1", "XP_015146451.1", "NP_001025709.2", "NP_990327.2"), 
                    colDataPit, "Stat and JAK proteins, Pituitary")
plotWGCNAcandidates(vsd.pit,
                    c("NP_990797.2","NP_001004392.2", "NP_001004403.1", "NP_001006255.2", "NP_001006274.1",
                           "NP_989500.1", "XP_001234815.2", "XP_015149152.1", "XP_416110.5"),
                    colDataPit, "9 of 102 genes in a WGCNA module containting Prolactin")
plotWGCNAcandidates(vsd.pit,
                    c("XP_428110.3","NP_001004392.2",  "XP_015142961.1", "XP_015139636.1",
                      "XP_015137408.1", "XP_004938696.1", "NP_990620.1", "NP_001170793.2", "NP_001026250.1"),
                    colDataPit, "Prolaction receptor: 9 of 147 genes in a WGCNA module containting PRLR")
plotWGCNAcandidates(vsd.pit, c("NP_989957.1", "NP_001120784.1", "NP_001120786.1",
                               "NP_001131120.1", "NP_001186037.1", "NP_989871.1",
                               "NP_990797.2", "XP_015132722.1"), colDataPit, "Pitutary: CISH, SOCS, PRL, PRLR")



# genes from https://link.springer.com/article/10.1007%2Fs12079-012-0168-0
# A pathway map of prolactin signaling
# PL, RAC1, IRS2 not found
plotWGCNAcandidates(vsd.pit, c("NP_990797.2", "XP_015132722.1", "NP_989690.1",
                               "NP_001025709.2", "XP_015144878.1", "NP_989481.1",
                               "NP_001186467.1", "NP_990386.1", "XP_015132490.1",
                               "XP_417614.3", "XP_015150421.1", "NP_001155844.1"), 
                    colDataPit, "Pit: Genes involved in prolactin signaling")


# hyp
plotWGCNAcandidates(vsd.hyp, c("NP_989957.1", "NP_001120784.1", "NP_001120786.1",
                               "NP_001131120.1", "NP_001186037.1", "NP_989871.1",
                               "NP_990797.2", "XP_015132722.1"), colDataHyp, "Hypothalamus: CISH, SOCS, PRL, PRLR")
plotWGCNAcandidates(vsd.hyp, c("NP_001170780.1", "NP_001090992.1", "NP_001014970.1"), colDataHyp, "VIP expression, Hypothalamus")

plotWGCNAcandidates(vsd.hyp, c("NP_990797.2", "XP_015132722.1", "NP_989690.1",
                               "NP_001025709.2", "XP_015144878.1", "NP_989481.1",
                               "NP_001186467.1", "NP_990386.1", "XP_015132490.1",
                               "XP_417614.3", "XP_015150421.1", "NP_001155844.1"), 
                    colDataHyp, "Hyp: Genes involved in prolactin signaling")


# gonad
plotWGCNAcandidates(vsd.gon, c("NP_989957.1", "NP_001120784.1", "NP_001120786.1",
                               "NP_001131120.1", "NP_001186037.1", "NP_989871.1",
                               "NP_990797.2", "XP_015132722.1"), colDataGon, "Gonad: CISH, SOCS, PRL, PRLR")

plotWGCNAcandidates(vsd.gon, c("NP_990797.2", "XP_015132722.1", "NP_989690.1",
                               "NP_001025709.2", "XP_015144878.1", "NP_989481.1",
                               "NP_001186467.1", "NP_990386.1", "XP_015132490.1",
                               "XP_417614.3", "XP_015150421.1", "NP_001155844.1"), 
                    colDataGon, "Gonad: Genes involved in prolactin signaling")

```

```{r wgcna2, eval = T, fig.width=12, fig.height=8}
PRL_associated <- read.csv("../results/08_PRL_associated.csv", header = T)
prl36 <-  PRL_associated$entrezid[1:57]
prl72 <-  PRL_associated$entrezid[58:102]
plotWGCNAcandidates(vsd.pit, prl36, colDataPit, "A-K genes with PRL pattern in the pituitary")
plotWGCNAcandidates(vsd.pit, prl72, colDataPit, "K-Z genes with PRL pattern in the pituitary")

PRLR_associated <- read.csv("../results/08_PRLR_associated.csv", header = T)
prlr36 <-  PRLR_associated$entrezid[1:57]
prlr72 <-  PRLR_associated$entrezid[58:115]
prlr116<-  PRLR_associated$entrezid[116:147]
plotWGCNAcandidates(vsd.pit, prlr36, colDataPit, "A-G genes with PRLR pattern in the pituitary")
plotWGCNAcandidates(vsd.pit, prlr72, colDataPit, "L-S genes with PRLR pattern in the pituitary")
plotWGCNAcandidates(vsd.pit, prlr116, colDataPit, "S-Z genes with PRLR pattern in the pituitary")

VIPR1_associated <- read.csv("../results/08_VIPR1_associated.csv", header = T)
vipr156 <-  VIPR1_associated$entrezid[398:456]
plotWGCNAcandidates(vsd.pit, vipr156, colDataPit, "Genes with VIPR1 pattern in the pituitary")

AR_associated <- read.csv("../results/08_AR_associated.csv", header = T)
AR <-  AR_associated$entrezid[1:31]
plotWGCNAcandidates(vsd.pit, AR, colDataPit, "Genes with AR pattern in the pituitary")


POMC_associated <- read.csv("../results/08_POMC_associated.csv", header = T)
pomc <-  POMC_associated$entrezid[32:61]
plotWGCNAcandidates(vsd.pit, pomc, colDataPit, "Genes with POMC pattern in the pituitary")

```

```{r ctsGE}
rts <- assay(vsd.pit)
```
