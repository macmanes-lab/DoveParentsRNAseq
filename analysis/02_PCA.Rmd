---
title: "PCA"
output: md_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggfortify)
library(factoextra)
library(cowplot)
library(Rtsne)
library(viridis)
library(forcats)

knitr::opts_chunk$set(echo = TRUE, fig.path = '../figures/pca/', cache = T)

source("../R/themes.R")  
```

# note. this file is too big for storage in github :(

## Data: Pseudocounts from Limma

```{r read}
pseudocounts <- read_csv("../results/01_pseudo.counts.csv")
head(pseudocounts[1:3])
pseudocounts <- as.data.frame(pseudocounts)
row.names(pseudocounts) <- pseudocounts$X1
pseudocounts$X1 <- NULL
# prep count data for all samples
countData <- as.data.frame(t(pseudocounts))
head(countData[1:3])
```


## All data, characterization and manipulations


```{r colData}
# prep col data for all samples
colData <- read.csv("../metadata/00_samples.csv", header = T, row.names = 1)
colData$treatment <- factor(colData$treatment, levels = alllevels)
colData <- colData %>% mutate(tissue = fct_recode(tissue, "gonads" = "gonad"))
colData$tissue <- factor(colData$tissue, levels = tissuelevels)
row.names(colData) <- colData$V1

# check ready for analysis
#row.names(countData) == row.names(colData)
```

```{r pcadf}
# pca
mypca <- prcomp(countData)
eig.val <- get_eigenvalue(mypca)
head(eig.val)

mypcadf <- data.frame(PC1 = mypca$x[, 1], PC2 = mypca$x[, 2], PC3 = mypca$x[, 3], 
                  PC4 = mypca$x[, 4],PC5 = mypca$x[, 5],PC6 = mypca$x[, 6],
                  ID = row.names(countData))
mypcadf$V1 <- row.names(mypcadf)
mypcadf <- left_join(colData, mypcadf)
mypcadf <- mypcadf %>% select(bird,sex,tissue,treatment,PC1:PC6)
head(mypcadf)
```

```{r pca}
plotcolorfulpcs <- function(whichfactor, whichcolors){
  p <- ggplot(mypcadf, aes(x = PC1, y = PC2, color = whichfactor)) +
    geom_point(size = 1)  +
    theme_B3() +
    theme(legend.title = element_blank(),
         axis.text = element_blank(),
         legend.position = "none") +
    labs(x = "PC1", y = "PC2") +
    scale_color_manual(values = whichcolors) 
  print(p)
}

a <- plotcolorfulpcs(mypcadf$tissue, colorstissue)  
b <- plotcolorfulpcs(mypcadf$sex, sexcolors) 
c <- plotcolorfulpcs(mypcadf$treatment, colorscharmaip)   


d <- fviz_screeplot(mypca, addlabels = TRUE, ylim = c(0, 50),  ncp = 5, barcolor = "white", barfill = "white") + 
  labs(title = NULL, y = "PC Variance") + theme_B3() 
e <- fviz_contrib(mypca, choice = "var", axes = 1, top = 5)  + labs(title = NULL, subtitle = "PC1", x = NULL) + 
          theme_B3() + theme(axis.text.x = element_text(angle = 55, hjust = 1))
f <- fviz_contrib(mypca, choice = "var", axes = 2, top = 5)  + labs(title = NULL, subtitle = "PC2", y = NULL, x = NULL) + 
          theme_B3()  + theme(axis.text.x = element_text(angle = 55, hjust = 1))
g <- fviz_pca_var(mypca,  labelsize = 3 , axes.linetype = "blank", 
                   repel = TRUE ,
                  select.var= list(contrib = 6)) + 
      theme_B3() + 
      labs(x = "PC1", y = "PC2", title =  NULL) +
      theme( axis.text = element_blank()) 

legend <- png::readPNG("../figures/images/DoveParentsRNAseq_legend.png")
legend <-  grid::rasterGrob(legend, interpolate=TRUE)


abc <- plot_grid(a,b, c, nrow =  1,  labels = c("d", "e", "f"), label_size = 12)
defg <- plot_grid(d,e,f,g, nrow = 1, rel_widths = c(1, 0.55, 0.45, 1), labels = c("h", "i", "j", "k" ), label_size = 12)
dg <- plot_grid(d,g, legend, nrow = 1, rel_widths = c(1, 1, 1), labels = c("h", "i", NULL ), label_size = 12)
plot_grid(abc, dg, nrow = 2)
```

```{r tSNE-df}
# prep for tsne
euclidist <- dist(countData) # euclidean distances between the rows

tsne_model <- Rtsne(euclidist, check_duplicates=FALSE, pca=TRUE, perplexity=10, theta=0.5, dims=2)
tsne_df = as.data.frame(tsne_model$Y) 

# prep for adding columns
colData2 <- colData 
colData2$V1 <- NULL
tsne_df_cols <- cbind(colData2, tsne_df)

```

```{r tSNE}
plotcolorfultsnes <- function(whichfactor, whichcolors){
  p <- ggplot(tsne_df_cols, aes(x = V1, y = V2, color = whichfactor)) +
    geom_point(size = 1) +
    theme_B3() +
    labs(x = "tSNE 1", y = "tSNE 2") +
    scale_color_manual(values = whichcolors) +
    theme(legend.position = "none",
          axis.text = element_blank())
  print(p)
}

h <- plotcolorfultsnes(tsne_df_cols$tissue, colorstissue)  
i <- plotcolorfultsnes(tsne_df_cols$sex, sexcolors)   
j <- plotcolorfultsnes(tsne_df_cols$treatment, colorscharmaip)  

hij <- plot_grid(h,i,j, nrow = 1, labels = c("a", "b", "c"), label_size = 12)
hij

```
```{r PCA-tSNE, fig.height= 7, fig.width=7}
plot_grid(hij, abc, dg, nrow = 3)

```
