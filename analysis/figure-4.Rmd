---
title: "Removal only"
output: md_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(cowplot)
library(Rtsne)
library(ggsignif)
library(corrr)

source("../R/themes.R")
source("../R/functions.R")
source("../R/genelists.R")

knitr::opts_chunk$set(echo = TRUE, message = F, warning = F,
                      fig.path = '../figures/', fig.width = 7.25, fig.height = 7.25)
```

# Figure 4. What is the effect of removal?


## import limma counts and sample info

```{r data}
countData <- read_csv("../results/01_limma.csv") %>%
  column_to_rownames(var = "X1")
countData <- as.data.frame(t(countData))
head(countData[1:3])

colData <- read_csv("../metadata/00_colData.csv") %>%
  mutate(treatment = factor(treatment, levels = alllevels),
         tissue = factor(tissue, levels = tissuelevels)) %>% 
  column_to_rownames(var = "X1") 
head(colData)
# check ready for analysis
# row.names(countData) == row.names(colData)
head(row.names(countData) == row.names(colData))
```

## tsne


```{r tSNE-df}

# prep for tsne
hyptsne <- subsetmaketsne("hypothalamus", removallevels, sexlevels)
pittsne <- subsetmaketsne("pituitary", removallevels, sexlevels)
gontsne <- subsetmaketsne("gonads", removallevels, sexlevels)

addgroupings <- function(df){
  
  df <- df %>% mutate(earlylate = fct_collapse(treatment, 
                                  early = c("early", "m.inc.d3", "m.inc.d9", "inc.d3", 
                                         "inc.d9",  "bldg"),
                                  late = c("inc.d17",   "m.inc.d17", "prolong" ,  "hatch" , 
                                         "m.n2", "extend", "n5"),
                                  reference = "control"),
                extint = fct_collapse(treatment, 
                                  nest = c("m.inc.d3", "m.inc.d9", "m.n2", "m.inc.d17", "bldg"),
                                  eggs = c("inc.d3", "inc.d9", "inc.d17", "prolong"),
                                  chicks = c("early", "hatch", "extend", "n5"),
                                  reference = "control")) 
  return(df)
}
  

pittsne <- addgroupings(pittsne)

t4 <- plottsneelipsev2(pittsne, pittsne$treatment, allcolors) +  labs(title = "Pituitary ", subtitle = "parental stage") +
  facet_wrap(~sex) 
t5 <- plottsneelipsev2(pittsne, pittsne$extint, colorhypothesis) +  labs(title = "  ", subtitle = "external enviornment")   +
  facet_wrap(~sex) + theme(axis.title.y = element_blank())
t6 <- plottsneelipsev2(pittsne, pittsne$earlylate, colorhypothesis) +  labs(title = "  ", subtitle = "internal timing")   +
  facet_wrap(~sex) + theme(axis.title.y = element_blank())
t456 <- plot_grid(t4, t5, t6, nrow = 1, rel_widths = c(1.1,1,1))
t456

```


## variance stabilized gene expression  (vsd)

```{r vsd}
vsd_path <- "../results/DEseq2/treatment/"   # path to the data
vsd_files <- dir(vsd_path, pattern = "*vsd.csv") # get file names
vsd_pathfiles <- paste0(vsd_path, vsd_files)
vsd_files

allvsd <- vsd_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x), .id = "file_name")  %>% 
  dplyr::rename("gene" = "X1") 
## before pivoting, check names of df with
## head(names(allvsd)) and tail(names(allvsd))
allvsd <- allvsd %>% 
  pivot_longer(cols = L.G118_female_gonad_control:y98.o50.x_male_pituitary_inc.d3, 
               names_to = "samples", values_to = "counts") 
allvsd <- as_tibble(allvsd)
head(allvsd)
tail(allvsd)

```

```{r candidatevsd}

# for plotting gene expression over time
getcandidatevsdmanip <- function(whichgenes, whichtissue){
  
  candidates  <- allvsd %>%
    filter(gene %in% whichgenes) %>%
    dplyr::mutate(sextissue = sapply(strsplit(file_name, '_vsd.csv'), "[", 1),
                  sextissue = sapply(strsplit(sextissue, '../results/DEseq2/treatment/'), "[", 2),
                  sex = sapply(strsplit(sextissue, '\\_'), "[", 1),
                tissue = sapply(strsplit(sextissue, '\\_'), "[", 2),
                treatment = sapply(strsplit(samples, '\\_'), "[", 4),
                treatment = sapply(strsplit(treatment, '.NYNO'), "[", 1),
                treatment = recode(treatment, "m.hatch" = "m.n2", "extend.hatch" = "m.n2",
                                                   "inc.prolong" = "prolong", "m.inc.d8" = "early"),
                treatment =  factor(treatment, levels = alllevels),
                earlylate = fct_collapse(treatment, 
                                  early = c("early", "m.inc.d3", "m.inc.d9", "inc.d3", 
                                         "inc.d9",  "bldg"),
                                  late = c("inc.d17",   "m.inc.d17", "prolong" ,  "hatch" , 
                                         "m.n2", "extend", "n5"),
                                  reference = "control"),
                extint = fct_collapse(treatment, 
                                  nest = c("m.inc.d3", "m.inc.d9", "m.n2", "m.inc.d17", "bldg"),
                                  eggs = c("inc.d3", "inc.d9", "inc.d17", "prolong"),
                                  chicks = c("early", "hatch", "extend", "n5"),
                                  reference = "control"))  %>%
    dplyr::select(gene, counts, sex, tissue, treatment, earlylate, extint, samples)  
  return(candidates)
}

candidatevsd <- getcandidatevsdmanip(candidategenes)
hypvsd <- candidatevsd %>% filter(tissue %in% "hypothalamus")  
pitvsd <- candidatevsd %>% filter(tissue %in% "pituitary") 
gonvsd <- candidatevsd %>% filter(tissue %in% "gonad") 

# not all genes appear to be expressed in the gonads... these are
filter(gonvsd, treatment == "control") %>% head()
```


```{r timingfigure, fig.height= 7.25in}

plotcandidateremoval <- function(df, whichgene, whichtissue){
  
  p <- df %>%
    dplyr::filter(gene  == whichgene, 
                  treatment %in% removallevels)  %>%
    ggplot(aes(y =  counts, x = treatment, fill = treatment, color = sex)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(size = 0.25, aes(color = sex)) +
    theme_B3() +
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          plot.subtitle = element_text(face = "italic")) +
    scale_color_manual(values = allcolors) +
    scale_fill_manual(values = allcolors)  +
    labs(title = paste(whichtissue, sep = " "), subtitle = whichgene, y = "gene expression") +
    geom_signif(comparisons = list(c( "inc.d3", "m.inc.d3"),
                                   c( "inc.d9", "m.inc.d9"),
                                   c( "inc.d17", "m.inc.d17"),
                                   c( "hatch", "m.n2")),
                map_signif_level=TRUE,
                textsize = 3, family = 'Helvetica',
                vjust = 1.5, size = 0.5) 
  return(p)
  
}

a <- plotcandidateremoval(hypvsd, "HTR2C", "hypothalamus") + theme(axis.title.x = element_blank())
b <- plotcandidateremoval(pitvsd, "PRL", "pituitary")+ theme(axis.title.x = element_blank(), strip.text = element_blank())
c <- plotcandidateremoval(gonvsd, "ESR2", "gonads") + theme(strip.text = element_blank())
boxplots1 <- plot_grid(a,b,c, nrow = 3)
boxplots1

plotcandidatetiming <- function(df, whichgene, whichtissue){
  
  p <- df %>%
    dplyr::filter(gene  == whichgene, 
                  treatment %in% timinglevels,
                  !treatment %in%  c("control", "bldg", "inc.d3"))  %>%
    ggplot(aes(y =  counts, x = treatment, fill = treatment, color = sex)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(size = 0.25, aes(color = sex)) +
    theme_B3() +
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          plot.subtitle = element_text(face = "italic")) +
    scale_color_manual(values = allcolors) +
    scale_fill_manual(values = allcolors)  +
    labs(title = paste(whichtissue, sep = " "), subtitle = whichgene, y = "gene expression") +
    geom_signif(comparisons = list(c("inc.d9", "early"), 
                                  c( "inc.d17", "prolong"), c( "prolong", "hatch"),
                                  c( "hatch", "extend"), c( "n5", "extend")),
                map_signif_level=TRUE,
                textsize = 3, family = 'Helvetica',
                vjust = 1.5, size = 0.5) 
  return(p)
  
}

e <- plotcandidatetiming(hypvsd, "HTR2C", "hypothalamus") + theme(axis.title.x = element_blank())
f <- plotcandidatetiming(pitvsd, "PRL", "pituitary")+ theme(axis.title.x = element_blank(), strip.text = element_blank())
g <- plotcandidatetiming(gonvsd, "ESR2", "gonads") + theme(strip.text = element_blank())
boxplots2 <- plot_grid(e,f,g, nrow = 3)
boxplots2
```



## DEGs

```{r allDEGs}
DEG_path <- "../results/DEseq2/treatment/"   # path to the data
DEG_files <- dir(DEG_path, pattern = "*DEGs") # get file names
DEG_pathfiles <- paste0(DEG_path, DEG_files)
#DEG_files

allDEG <- DEG_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x), .id = "file_name") %>% 
  mutate(DEG = sapply(strsplit(as.character(file_name),'./results/DEseq2/treatment/'), "[", 2))  %>% 
  mutate(DEG = sapply(strsplit(as.character(DEG),'_diffexp.csv'), "[", 1))  %>% 
  mutate(tissue = sapply(strsplit(as.character(DEG),'\\.'), "[", 1)) %>%
  mutate(down = sapply(strsplit(as.character(DEG),'\\_'), "[", 3)) %>%
  mutate(up = sapply(strsplit(as.character(DEG),'\\_'), "[", 4)) %>%
  mutate(comparison = paste(down,up, sep = "_")) %>%
  mutate(sex = sapply(strsplit(as.character(sextissue),'\\_'), "[", 1)) %>%
  mutate(tissue = sapply(strsplit(as.character(sextissue),'\\_'), "[", 2)) %>%
  dplyr::select(sex,tissue,comparison, direction, gene, lfc, padj, logpadj) # %>%
 # mutate(tissue = factor(tissue, levels = tissuelevel),
  #       comparison = factor(comparison , levels = comparisonlevelsremoval),
  #       direction = factor(direction, levels = alllevels))
head(allDEG)


candidateDEGS <- allDEG %>%
  filter(gene %in% parentalcaregenes) %>%
  mutate(posneg = ifelse(lfc >= 0, "+", "-"),
         sex = recode(sex, "female" = "F", "male" = "M" ),
         tissue = recode(tissue, 
                         "hypothalamus" = "H",
                         "pituitary" = "P", 
                         "gonad" = "G", "gonads" = "G")) %>%
  mutate(res = paste(sex, tissue, posneg, sep = "")) %>%
  select(gene, res, comparison)  %>%
  group_by(gene,  comparison) %>%
  summarize(res = str_c(res, collapse = " ")) %>%
  pivot_wider(names_from = comparison, values_from = res) %>%
  select(gene, inc.d3_m.inc.d3, inc.d9_m.inc.d9, inc.d17_m.inc.d17, hatch_m.n2,
          inc.d17_prolong, hatch_prolong)
candidateDEGS

```



## make figure

```{r fig4, fig.width=7.25, fig.height=7.25}

a <- png::readPNG("../figures/images/fig_fig4a.png")
a <- ggdraw() +  draw_image(a, scale = 1)


boxplots <- plot_grid(boxplots1, boxplots2, nrow = 1, rel_widths = c(1.5,1))
plot_grid(boxplots, t456, a, ncol = 1, rel_heights = c(3,1,1))


#pdf(file="../figures/fig4-1.pdf", width=7.25, height=7.25)
#plot(fig4)
#dev.off()

makecorrdf <- function(whichsex, whichtissue, whichgenes){
  corrrdf <- candidatevsd %>% 
    filter(sex == whichsex, tissue == whichtissue,
           gene %in% whichgenes) %>%
    drop_na() %>%
    pivot_wider(names_from = gene, values_from = counts) %>%
    select(-sex, -tissue, -treatment, -samples, -earlylate, -extint) %>%
    correlate() 
  print(head(corrrdf))
  return(corrrdf)
}

candidatevsd <- candidatevsd %>% filter(treatment %in% maniplevels)

hyp1 <- makecorrdf(sexlevels, "hypothalamus", curleychampagnegenes)  
pit1 <- makecorrdf(sexlevels, "pituitary", curleychampagnegenes)  
gon1 <- makecorrdf(sexlevels, "gonad", curleychampagnegenes)  

hyp2 <- makecorrdf(sexlevels, "hypothalamus", GOgenes)  
pit2 <- makecorrdf(sexlevels, "pituitary", GOgenes)  
gon2 <- makecorrdf(sexlevels, "gonad", GOgenes) 

hyp3 <- makecorrdf(sexlevels, "hypothalamus", cancergenes)  
pit3 <- makecorrdf(sexlevels, "pituitary", GOgecancergenesnes)  
gon3 <- makecorrdf(sexlevels, "gonad", cancergenes)  
 

b1 <- plotcorrplot(hyp1, "Literature") + labs(title = "hyp")
b2 <- plotcorrplot(pit1, NULL)  + labs(title = "pit")
b3 <- plotcorrplot(gon1, NULL)  + labs(title = "gon")

b4 <- plotcorrplot(hyp2, "GO")  + labs(title = " ")
b5 <- plotcorrplot(pit2, NULL)   + labs(title = " ")
b6 <- plotcorrplot(gon2, NULL)  + labs(title = " ")

b7 <- plotcorrplot(hyp3, "Caner") + labs(title = " ")
b8 <- plotcorrplot(pit3, NULL)   + labs(title = " ")
b9 <- plotcorrplot(gon3, NULL)  + labs(title = " ")

forlegend <- plotcorrplot(gon3, NULL) + theme(legend.position = "bottom") + labs(color = "Correlation")
mylegend <- get_legend(forlegend)

allcorplots <- plot_grid(b1,b4,b7,
          b2,b5,b8,
          b3,b6,b9)

supplfigX <- plot_grid(allcorplots, mylegend, ncol = 1, rel_heights = c(1,0.1))
supplfigX
```


## supplementary

```{r}

hyptsne <- addgroupings(hyptsne)
gontsne <- addgroupings(gontsne)

t1 <- plottsneelipsev2(hyptsne, hyptsne$treatment, allcolors) +  labs(subtitle = "Hypothalamus ") +
  facet_wrap(~sex) + theme(axis.title.x = element_blank())
t2 <- plottsneelipsev2(hyptsne, hyptsne$extint, colorhypothesis) +  labs(subtitle = "  ")   +
  facet_wrap(~sex) + theme(axis.title = element_blank())
t3 <- plottsneelipsev2(hyptsne, hyptsne$earlylate, colorhypothesis) +  labs(subtitle = "  ")   +
  facet_wrap(~sex) + theme(axis.title = element_blank())
t123 <- plot_grid(t1, t2, t3, nrow = 1, rel_widths = c(1.1,1,1))

t7 <- plottsneelipsev2(gontsne, gontsne$treatment, allcolors) +  labs(subtitle = "Gonads ") +
  facet_wrap(~sex) + theme(strip.text = element_blank())
t8 <- plottsneelipsev2(gontsne, gontsne$extint, colorhypothesis) +  labs(subtitle = "  ")   +
  facet_wrap(~sex) + theme(axis.title.y = element_blank(), strip.text = element_blank())
t9 <- plottsneelipsev2(gontsne, gontsne$earlylate, colorhypothesis) +  labs(subtitle = "  ")   +
  facet_wrap(~sex) + theme(axis.title.y = element_blank(), strip.text = element_blank())
t789 <- plot_grid(t7, t8, t9, nrow = 1)
```

## write files

```{r write}
#write.csv(candidateDEGS, "../results/table2.csv", row.names = F)
```


