---
title: "Fig4"
output: md_document
---

# Figure 4: All things prolactin

```{r setup}
library(tidyverse)
library(cowplot)
library(ggimage)
library(apaTables)
library(factoextra)

source("../R/themes.R") 
source("../R/functions.R")
source("../R/wrangledata.R")

knitr::opts_chunk$set(fig.path = '../figures/',message=F, warning=FALSE)
```

## PCA data

```{r PCA}
# pca
pca1f <- subsetmakepca("pituitary", charlevelsnocontrol, "female")	
pca1m <- subsetmakepca("pituitary", charlevelsnocontrol, "male")	

pca2f <- makefvizdf("pituitary", charlevelsnocontrol, "female")	
pca2m <- makefvizdf("pituitary", charlevelsnocontrol, "male")	

```

## PRL hormone

```{r hormones}

# hormones
prolactin <- read_csv("../results/07_hormones.csv") %>%
    filter(study == "characterization", hormone %in% c("prolactin"))  %>% 
    droplevels() 
prolactin$treatment <- factor(prolactin$treatment, levels = alllevels)
```

# subset PRL vsd

```{r}
# `candidatevsd` loaded with `source("../R/wrangledata.R")`

PRLpit <- candidatevsd %>% filter(tissue == "pituitary", gene == "PRL")
PRLpitF <- candidatevsd %>% filter(tissue == "pituitary", gene == "PRL", 
                                   sex == "female" , treatment != "control")
PRLpitM <- candidatevsd %>% filter(tissue == "pituitary", gene == "PRL", 
                                   sex == "male", treatment != "control")
```




## Internal versus external hyotheses

```{r hypothesis}

PRLpit %>%
  group_by(sex) %>%
  summarize(median = median(counts))

PRLvsd3 <- PRLpit %>%
  mutate(hiloPRL = ifelse(counts >= 18, "hi", "lo"))  %>%
  drop_na()
PRLvsd3$hiloPRL <- factor(PRLvsd3$hiloPRL, levels = c("lo", "hi"))

PRLvsd3 %>%
  group_by(sex, tissue, hiloPRL) %>%
  summarize(n = n())

DEG_path <- "../results/DEseq2/hypothesis/"   # path to the data
DEG_files <- dir(DEG_path, pattern = "*DEGs") # get file names
DEG_pathfiles <- paste0(DEG_path, DEG_files)
#DEG_files

allDEG2 <- DEG_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x), .id = "file_name") %>% 
  mutate(DEG = sapply(strsplit(as.character(file_name),'./results/DEseq2/hypothesis/'), "[", 2))  %>% 
  mutate(DEG = sapply(strsplit(as.character(DEG),'_diffexp.csv'), "[", 1))  %>% 
  mutate(tissue = sapply(strsplit(as.character(DEG),'\\.'), "[", 1)) %>%
  mutate(down = sapply(strsplit(as.character(DEG),'\\_'), "[", 3)) %>%
  mutate(up = sapply(strsplit(as.character(DEG),'\\_'), "[", 4)) %>%
  mutate(comparison = paste(down,up, sep = "_")) %>%
  mutate(sex = sapply(strsplit(as.character(sextissue),'\\_'), "[", 1)) %>%
  mutate(tissue = sapply(strsplit(as.character(sextissue),'\\_'), "[", 2)) %>%
dplyr::select(sex,tissue,comparison, direction, gene, lfc, padj, logpadj) 
head(allDEG2)

allDEG2$tissue <- factor(allDEG2$tissue, levels = tissuelevel)

allDEG2$comparison <- factor(allDEG2$comparison, levels = c("eggs_chicks", "lo_hi"))
allDEG2 <- allDEG2 %>% mutate(comparison = fct_recode(comparison, "lo vs. hi PRL   " = "lo_hi",
                                                      "eggs vs. chicks" = "eggs_chicks"))
allDEG2$direction <- factor(allDEG2$direction, levels = c("eggs", "chicks", "lo", "hi"))


PRLDEGs <- allDEG2 %>%
  filter(tissue == "pituitary", comparison == "lo vs. hi PRL   ", direction == "hi") %>%
  arrange(desc(comparison))
PRLDEGs
```



```{r fig4, fig.width=7.25, fig.height=7.25}

expdesign <- png::readPNG("../figures/images/fig_fig4a.png")
expdesign <- ggdraw() +  draw_image(expdesign, scale = 1)

a <-plotcolorfulpcs(pca1f,pca1f$treatment, allcolors) + labs(subtitle = "Female pituitary") 
b <- plotfriz(pca2f) + labs(subtitle = " ") 
c <- plotprolactin(PRLpitF, PRLpitF$counts, "PRL", " ") + 
  theme(legend.position = "none", 
        axis.title.y = element_text(face = "italic"))  
d <- makenewbargraph("pituitary", "female","eggs vs. chicks", 0, 2100)   
e <- makenewbargraph("pituitary", "female", "lo vs. hi PRL   ", 0, 2100) + theme(axis.title.y = element_blank())   

f <- plotcolorfulpcs(pca1m, pca1m$treatment, allcolors) + labs(subtitle = "Male pituitary")
g <- plotfriz(pca2m) + labs(subtitle = " ") 
h <- plotprolactin(PRLpitM, PRLpitM$counts, "PRL", " ") + theme(legend.position = "none", 
        axis.title.y = element_text(face = "italic"))  
i <- makenewbargraph("pituitary", "male", "eggs vs. chicks", 0, 2100)  
j <- makenewbargraph("pituitary", "male", "lo vs. hi PRL   ", 0, 2100) + theme(axis.title.y = element_blank()) 


d2m <- plot_grid(a,b,c,d,e,f,g,h,i,j, nrow = 2, rel_widths = c(1,1,2,0.8, 0.75), 
                 labels = c("D", "E", "F", "G", "H", "I", "J", "K", "L", "M"), label_size = 8)

fig4 <- plot_grid(expdesign,d2m, ncol = 1, rel_heights = c(0.25,1))
fig4
```
 
```{r savefiles}
#write.csv(PRLvsd3,"../results/PRLvsd.csv", row.names = F)
```