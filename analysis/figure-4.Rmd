---
title: "Fig5"
output: md_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(cowplot)
library(Rtsne)
library(ggsignif)

source("../R/themes.R")
source("../R/functions.R")
#source("../R/wrangledata.R")

knitr::opts_chunk$set(echo = TRUE, fig.path = '../figures/')
```

# Figure 1. Experimental design, tSNE analysis, PCA, and prolactin


```{r tSNE-df}

# prep for tsne

hyptsne <- subsetmaketsne("hypothalamus", allmaniplevels, sexlevels)
pittsne <- subsetmaketsne("pituitary", allmaniplevels, sexlevels)
gontsne <- subsetmaketsne("gonads", allmaniplevels, sexlevels)

addgroupings <- function(df){
  
  df <- df %>% mutate(hiloPRL = fct_collapse(treatment, 
                                  lo = c("m.inc.d8", "m.inc.d3", "m.inc.d9", "inc.d3", "inc.d9", "lay", "bldg"),
                                  hi = c("inc.d17",   "m.inc.d17", "prolong" ,  "hatch" ,  "m.n2", "extend", "n5")),
                extint = fct_collapse(treatment, 
                                  eggs = c("inc.d3", "inc.d9", "inc.d17", "prolong", "lay"),
                                  chicks = c( "m.inc.d8", "hatch", "extend", "n5"),
                                  loss = c("m.inc.d3", "m.inc.d9", "m.n2", "m.inc.d17", "bldg")))
  df$extint <- factor(df$extint, levels = levelsextint)
  return(df)
}
  
hyptsne <- addgroupings(hyptsne)
pittsne <- addgroupings(pittsne)
gontsne <- addgroupings(gontsne)

```


## variance stabilized gene expression  (vsd)

```{r vsd}
vsd_path <- "../results/DEseq2/manip/"   # path to the data
vsd_files <- dir(vsd_path, pattern = "*vsd.csv") # get file names
vsd_pathfiles <- paste0(vsd_path, vsd_files)
vsd_files

allvsd <- vsd_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x), .id = "file_name")  %>% 
  dplyr::rename("gene" = "X1") %>% 
  pivot_longer(cols = blk.s031.pu.d_female_gonad_prolong:y98.o50.x_male_pituitary_inc.d3, 
               names_to = "samples", values_to = "counts") 
allvsd <- as_tibble(allvsd)

head(allvsd)

# for plotting gene expression over time
getcandidatevsdmanip <- function(whichgenes, whichtissue, whichsex){
  candidates  <- allvsd %>%
    filter(gene %in% whichgenes) %>%
    dplyr::mutate(sextissue = sapply(strsplit(file_name, '_vsd.csv'), "[", 1)) %>%
    dplyr::mutate(sextissue = sapply(strsplit(sextissue, '../results/DEseq2/manip/'), "[", 2)) %>%
    dplyr::mutate(sex = sapply(strsplit(sextissue, '\\_'), "[", 1),
                tissue = sapply(strsplit(sextissue, '\\_'), "[", 2),
                treatment = sapply(strsplit(samples, '\\_'), "[", 4)) %>%
    dplyr::mutate(treatment = sapply(strsplit(treatment, '.NYNO'), "[", 1)) %>%
     dplyr::mutate(treatment = recode(treatment, "m.hatch" = "m.n2",
                                                  "extend.hatch" = "m.n2",
                                      "inc.prolong" = "prolong")) %>%
    
    dplyr::mutate(day = fct_collapse(treatment,
                                     "1" = c("inc.d3", "m.inc.d3" ),
                                     "2" = c("inc.d9", "m.inc.d9", "m.inc.d8"  ),
                                     "2" = c("inc.d17", "m.inc.d17", "prolong"  ),
                                     "4" = c("hatch", "m.n2", "extend"  )
                                     )) %>%
    dplyr::mutate(day = as.numeric(day)) %>%
    dplyr::mutate(manip = fct_collapse(treatment,
                                       "reference" = charlevels,
                                       "removal" = c("m.inc.d3", "m.inc.d9", "m.inc.d17","m.n2"),
                                       "replacement" = c("m.inc.d8", "prolong", "extend"))) %>%
    dplyr::mutate(manip = factor(manip, levels = c("reference", "removal", "replacement"))) %>%
    dplyr::select(sex, tissue, treatment, day,  manip, gene, samples, counts) %>%
    filter(tissue == whichtissue, sex %in% whichsex)  %>%
    drop_na()
  candidates$treatment <- factor(candidates$treatment, levels = alllevels)
  return(candidates)
}

hypvsd <- getcandidatevsdmanip(candidategenes, "hypothalamus", sexlevels)
pitvsd <- getcandidatevsdmanip(candidategenes, "pituitary", sexlevels)
gonvsd <- getcandidatevsdmanip(candidategenes, "gonad", sexlevels)
candidatevsd <- rbind(hypvsd, pitvsd)
candidatevsd <- rbind(candidatevsd, gonvsd)
head(candidatevsd)


hypvsd2 <- getcandidatevsdmanip(hypothesisDEGs, "hypothalamus", sexlevels)
pitvsd2 <- getcandidatevsdmanip(hypothesisDEGs, "pituitary", sexlevels)
gonvsd2 <- getcandidatevsdmanip(hypothesisDEGs, "gonad", sexlevels)
candidatevsd2 <- rbind(hypvsd2, pitvsd2)
candidatevsd2 <- rbind(candidatevsd2, gonvsd2)
head(candidatevsd2) 
```



## DEGs

```{r allDEGs}
DEG_path <- "../results/DEseq2/manip/"   # path to the data
DEG_files <- dir(DEG_path, pattern = "*DEGs") # get file names
DEG_pathfiles <- paste0(DEG_path, DEG_files)
#DEG_files

allDEG <- DEG_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x), .id = "file_name") %>% 
  mutate(DEG = sapply(strsplit(as.character(file_name),'./results/DEseq2/manip/'), "[", 2))  %>% 
  mutate(DEG = sapply(strsplit(as.character(DEG),'_diffexp.csv'), "[", 1))  %>% 
  mutate(tissue = sapply(strsplit(as.character(DEG),'\\.'), "[", 1)) %>%
  mutate(down = sapply(strsplit(as.character(DEG),'\\_'), "[", 3)) %>%
  mutate(up = sapply(strsplit(as.character(DEG),'\\_'), "[", 4)) %>%
  mutate(comparison = paste(down,up, sep = "_")) %>%
  mutate(sex = sapply(strsplit(as.character(sextissue),'\\_'), "[", 1)) %>%
  mutate(tissue = sapply(strsplit(as.character(sextissue),'\\_'), "[", 2)) %>%
dplyr::select(sex,tissue,comparison, direction, gene, lfc, padj, logpadj) 
head(allDEG)

allDEG$tissue <- factor(allDEG$tissue , levels = tissuelevel)
allDEG$comparison <- factor(allDEG$comparison , levels = comparisonlevels)
allDEG$direction <- factor(allDEG$direction, levels = alllevels)
head(allDEG)

candidateDEGS <- allDEG %>%
  filter(gene %in% candidategenes) %>%
  mutate(posneg = ifelse(lfc >= 0, "+", "-"),
         sex = recode(sex, "female" = "F", "male" = "M" ),
         tissue = recode(tissue, 
                         "hypothalamus" = "H",
                         "pituitary" = "P", "gonad" = "G")) %>%
  mutate(res = paste(sex, tissue, posneg, sep = "")) %>%
  select(gene, res, comparison)  %>%
  group_by(gene,  comparison) %>%
  summarize(res = str_c(res, collapse = " ")) %>%
  pivot_wider(names_from = comparison, values_from = res) %>%
  select(gene, contains("m.")) 
candidateDEGS

hypothesisDEGStable <- allDEG %>%
  filter(gene %in% hypothesisDEGs) %>%
  mutate(posneg = ifelse(lfc >= 0, "+", "-"),
         sex = recode(sex, "female" = "F", "male" = "M" ),
         tissue = recode(tissue, 
                         "hypothalamus" = "H",
                         "pituitary" = "P", "gonad" = "G")) %>%
  mutate(res = paste(sex, tissue, posneg, sep = "")) %>%
  select(gene, res, comparison)  %>%
  group_by(gene,  comparison) %>%
  summarize(res = str_c(res, collapse = " ")) %>%
  pivot_wider(names_from = comparison, values_from = res) %>%
  select(gene, contains("m.")) 
hypothesisDEGStable
```



## make figure

```{r fig4, fig.width=7.25, fig.height=7.25}

a <- png::readPNG("../figures/images/fig_fig4a.png")
a <- ggdraw() +  draw_image(a, scale = 1)

b1 <- plotcandidatemanipquad(candidatevsd, "hypothalamus", c("DRD1")) 
b2 <- plotcandidatemanipquad(candidatevsd,"pituitary", c("PRL")) 
b3 <- plotcandidatemanipquad(candidatevsd,"gonad", c("PGR")) 

b <- plot_grid(b1,b2,b3, ncol = 1)

c1 <- plottsneelipsev2(hyptsne, hyptsne$treatment, allcolors) + 
  labs(subtitle = "Hypothalamus ", x = NULL)  
c2 <- plottsneelipsev2(hyptsne, hyptsne$extint, allcolors ) + 
  labs(subtitle = " ", x = NULL) + 
  theme(axis.text.y = element_blank(), axis.title.y = element_blank())
c3 <- plottsneelipsev2(hyptsne, hyptsne$hiloPRL, allcolors ) + 
  labs(subtitle = " ", x = NULL) + 
  theme(axis.text.y = element_blank(), axis.title.y = element_blank()) 
c4 <- plottsneelipsev2(pittsne, pittsne$treatment, allcolors ) + 
  labs(subtitle = "Pituitary ", x = NULL) 
c5 <- plottsneelipsev2(pittsne, pittsne$extint, allcolors ) + 
  labs(subtitle = " ", x = NULL) + 
  theme(axis.text.y = element_blank(), axis.title.y = element_blank()) 
c6 <- plottsneelipsev2(pittsne, pittsne$hiloPRL, allcolors ) + 
  labs(subtitle = " ", x = NULL) + 
  theme(axis.text.y = element_blank(), axis.title.y = element_blank())
c7 <- plottsneelipsev2(gontsne, gontsne$treatment, allcolors ) + 
  labs(subtitle = "Ggonads ")  
c8 <- plottsneelipsev2(gontsne, gontsne$extint, allcolors ) + 
  labs(subtitle = " " )    +
  theme(axis.text.y = element_blank(), axis.title.y = element_blank())
c9 <- plottsneelipsev2(gontsne, gontsne$hiloPRL, allcolors ) + 
  labs(subtitle = " " ) + 
  theme(axis.text.y = element_blank(), axis.title.y = element_blank())

c <- plot_grid(c1,c2,c3,c4,c5,c6,c7,c8,c9, nrow = 3)

bc <- plot_grid(b, c, nrow = 1, labels = c("", "C"), label_size = 8)
 
fig4 <- plot_grid(a, bc, ncol = 1, rel_heights  = c(0.25,1),
          labels = "AUTO", label_size = 8)
fig4

pdf(file="../figures/fig4-1.pdf", width=7.25, height=7.25)
plot(fig4)
dev.off()





candidatevsd <- candidatevsd %>%
  dplyr::mutate(treatment = fct_collapse(treatment,
                                         "m.n2" = c("m.n2",  "m.hatch" ),
                                         "prolong" = c("prolong", "inc.prolong") ,
                                         "extend" = c("extend", "extend.hatch")
                                         ))  %>%
  dplyr::mutate(day = fct_collapse(treatment,
                                    "0" = c("control", "bldg"),
                                    "1" = c("lay"),
                                     "3" = c("inc.d3", "m.inc.d3" ),
                                     "9" = c("inc.d9", "m.inc.d9", "m.inc.d8"  ),
                                     "17" = c("inc.d17", "m.inc.d17", "prolong"  ),
                                     "18" = c("hatch", "m.n2" ),
                                     "22" = c("n5",  "extend" ),
                                     "26" = c("n9"  )
                                     )) %>%
   mutate(treatment = factor(treatment, levels = alllevels)) %>%
  dplyr::mutate(day = factor(day, levels = c("0", "1", "3", "9", "17", "18", "22", "26")))

candidatevsd %>%
    filter(tissue == "hypothalamus", sex == "female") %>%
    filter(gene %in% "DRD1") %>%
    drop_na()  %>%
    ggplot(aes(y =  counts, x = day, fill = treatment, color = sex)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(size = 0.25, aes(color = sex)) +
    theme_B3() +
    theme(legend.position = "bottom",
          #axis.text.x = element_blank(),
          #axis.title.x = element_blank(),
          strip.text = element_text(face = "italic")) +
    scale_color_manual(values = allcolors) +
    scale_fill_manual(values = allcolors)  +
    labs(subtitle = paste("female", "hypothalamus", sep = " "), y = "DRD1")


candidatevsd %>%
    filter(tissue == "pituitary", sex == "female") %>%
    filter(gene %in% "PRL") %>%
    drop_na()  %>%
    ggplot(aes(y =  counts, x = day, fill = treatment, color = sex)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(size = 0.25, aes(color = sex)) +
    theme_B3() +
    theme(legend.position = "bottom",
          #axis.text.x = element_blank(),
          #axis.title.x = element_blank(),
          strip.text = element_text(face = "italic")) +
    scale_color_manual(values = allcolors) +
    scale_fill_manual(values = allcolors)  +
    labs(subtitle = paste("female", "pituitary", sep = " "), y = "PRL")

```





