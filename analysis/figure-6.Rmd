---
title: "Fig6"
author: "Rayna M Harris"
date: "3/26/2020"
output: md_document
---

## manipulation box plots for candidate genes

```{r setup}
library(tidyverse)
library(ggtext)
library(cowplot)
library(ggpubr)
library(kableExtra)


source("../R/themes.R")

knitr::opts_chunk$set(echo = TRUE, message = F, fig.path = "../figures/")
```


## Candidate Genes (from literature and relevant GO terms) 

```{r GO}
source("../R/wrangledata.R")
```


## variance stabilized gene expression  (vsd)

```{r vsd}
vsd_path <- "../results/DEseq2/manip/"   # path to the data
vsd_files <- dir(vsd_path, pattern = "*vsd.csv") # get file names
vsd_pathfiles <- paste0(vsd_path, vsd_files)
vsd_files

allvsd <- vsd_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x), .id = "file_name")  %>% 
  dplyr::rename("gene" = "X1") %>% 
  pivot_longer(cols = blk.s031.pu.d_female_gonad_prolong:y98.o50.x_male_pituitary_inc.d3, 
               names_to = "samples", values_to = "counts") 
allvsd <- as.tibble(allvsd)

head(allvsd)
```

```{r candidate vsd}
# for plotting gene expression over time
getcandidatevsd <- function(whichgenes, whichtissue, whichsex){
  candidates  <- allvsd %>%
    filter(gene %in% whichgenes) %>%
    dplyr::mutate(sextissue = sapply(strsplit(file_name, '_vsd.csv'), "[", 1)) %>%
    dplyr::mutate(sextissue = sapply(strsplit(sextissue, '../results/DEseq2/manip/'), "[", 2)) %>%
    dplyr::mutate(sex = sapply(strsplit(sextissue, '\\_'), "[", 1),
                tissue = sapply(strsplit(sextissue, '\\_'), "[", 2),
                treatment = sapply(strsplit(samples, '\\_'), "[", 4)) %>%
    dplyr::mutate(treatment = sapply(strsplit(treatment, '.NYNO'), "[", 1)) %>%
     dplyr::mutate(treatment = recode(treatment, "m.hatch" = "m.n2",
                                                  "extend.hatch" = "m.n2",
                                      "inc.prolong" = "prolong")) %>%
    
    dplyr::mutate(day = fct_collapse(treatment,
                                     "1" = c("inc.d3", "m.inc.d3" ),
                                     "2" = c("inc.d9", "m.inc.d9", "m.inc.d8"  ),
                                     "2" = c("inc.d17", "m.inc.d17", "prolong"  ),
                                     "4" = c("hatch", "m.n2", "extend"  )
                                     )) %>%
    dplyr::mutate(day = as.numeric(day)) %>%
    dplyr::mutate(manip = fct_collapse(treatment,
                                       "reference" = charlevels,
                                       "removal" = c("m.inc.d3", "m.inc.d9", "m.inc.d17","m.n2"),
                                       "replacement" = c("m.inc.d8", "prolong", "extend"))) %>%
    dplyr::mutate(manip = factor(manip, levels = c("reference", "removal", "replacement"))) %>%
    dplyr::select(sex, tissue, treatment, day,  manip, gene, samples, counts) %>%
    filter(tissue == whichtissue, sex %in% whichsex)  %>%
    drop_na()
  candidates$treatment <- factor(candidates$treatment, levels = alllevels)
  return(candidates)
}

hypvsd <- getcandidatevsd(candidategenes, "hypothalamus", sexlevels)
pitvsd <- getcandidatevsd(candidategenes, "pituitary", sexlevels)
gonvsd <- getcandidatevsd(candidategenes, "gonad", sexlevels)
candidatevsd <- rbind(hypvsd, pitvsd)
candidatevsd <- rbind(candidatevsd, gonvsd)
head(candidatevsd)
```


## DEGs

```{r allDEGs}
DEG_path <- "../results/DEseq2/manip/"   # path to the data
DEG_files <- dir(DEG_path, pattern = "*DEGs") # get file names
DEG_pathfiles <- paste0(DEG_path, DEG_files)
#DEG_files

allDEG <- DEG_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x), .id = "file_name") %>% 
  mutate(DEG = sapply(strsplit(as.character(file_name),'./results/DEseq2/manip/'), "[", 2))  %>% 
  mutate(DEG = sapply(strsplit(as.character(DEG),'_diffexp.csv'), "[", 1))  %>% 
  mutate(tissue = sapply(strsplit(as.character(DEG),'\\.'), "[", 1)) %>%
  mutate(down = sapply(strsplit(as.character(DEG),'\\_'), "[", 3)) %>%
  mutate(up = sapply(strsplit(as.character(DEG),'\\_'), "[", 4)) %>%
  mutate(comparison = paste(down,up, sep = "_")) %>%
  mutate(sex = sapply(strsplit(as.character(sextissue),'\\_'), "[", 1)) %>%
  mutate(tissue = sapply(strsplit(as.character(sextissue),'\\_'), "[", 2)) %>%
dplyr::select(sex,tissue,comparison, direction, gene, lfc, padj, logpadj) 
head(allDEG)

allDEG$tissue <- factor(allDEG$tissue , levels = tissuelevel)
allDEG$comparison <- factor(allDEG$comparison , levels = comparisonlevels)
allDEG$direction <- factor(allDEG$direction, levels = alllevels)
head(allDEG)

candidateDEGS <- allDEG %>%
  filter(gene %in% candidategenes) %>%
  mutate(posneg = ifelse(lfc >= 0, "+", "-"),
         sex = recode(sex, "female" = "F", "male" = "M" ),
         tissue = recode(tissue, 
                         "hypothalamus" = "H",
                         "pituitary" = "P", "gonad" = "G")) %>%
  mutate(res = paste(sex, tissue, posneg, sep = "")) %>%
  select(gene, res, comparison)  %>%
  group_by(gene,  comparison) %>%
  summarize(res = str_c(res, collapse = " ")) %>%
  pivot_wider(names_from = comparison, values_from = res) %>%
  select(gene, contains("m.")) 
candidateDEGS

table2 <- left_join(candidateDEGS, GOgenesWide) %>%
  select(gene, m.inc.d17_prolong:m.inc.d9_m.inc.d17, parentalcare, parentalbehavior, NCBI) %>%
  mutate(parentalcare = if_else(is.na(parentalcare), " ", "X"),
         parentalbehavior = if_else(is.na(parentalbehavior), " ", "X")) %>%
  rename("Literature" = "parentalcare", "GO" =  "parentalbehavior")
table2$numDEGs <- rowSums(is.na(table2)) # count NAs to know how many are NS
table2 <- table2 %>% 
  mutate(sig = ifelse(numDEGs == 6, "NS", "DEG")) %>% 
  arrange(sig, gene)  %>%  select(-sig, -numDEGs)
table2[is.na(table2)] <- " " # replace NA with blank space so it's pretty
table2

table2 %>% select(gene,inc.d3_m.inc.d3, inc.d9_m.inc.d9, inc.d17_m.inc.d17, hatch_m.n2)
```


```{r fig6, fig.height=7.25, fig.width=10}

plotcandidatemanip <- function(whichtissue, whichsex, whichgenes){
  
  p <- candidatevsd %>%
  filter(tissue == whichtissue, sex == whichsex) %>%
  filter(gene %in% whichgenes) %>%
  filter(treatment %in% c(levelsremoval, controlsremoval)) %>%
  mutate(treatment = factor(treatment, levels = alllevels3)) %>%
  ggplot(aes(y =  counts, x = treatment, fill = treatment, color = sex)) +
  geom_boxplot() +
  facet_wrap(~gene, scales = "free_y", nrow = 2) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(face = "italic")) +
  scale_color_manual(values = allcolors) +
  scale_fill_manual(values = allcolors) 
  
  
  return(p)
}

p1 <- plotcandidatemanip("hypothalamus", "female", c("AVP", "BRINP1", "COMT", "CREBRF", "CRH", "CRHBP", "CRHR1", "CRHR2", "OPRK1")) +
  labs(subtitle = "hypothalamus") +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank()) 
p2 <- plotcandidatemanip("pituitary", "female", c("CREBRF", "CRHR1", "DRD1", "DRD4", "GNAQ")) +
  labs(subtitle = "pituitary")
p3 <- plotcandidatemanip("gonad", "female", c("BRINP1", "OPRK1"))  +
  labs(subtitle = "gonads")


p23 <- plot_grid(p2,p3, nrow = 1, rel_widths = c(3,1))

plot_grid(p1,p23, nrow = 2, rel_heights = c(1,1.2))

## hypothesis
```

```{r, eval = F}

## not working
meanse <- candidatevsd %>%
  dplyr::group_by(sex, tissue, treatment, day, manip, gene) %>%
  dplyr::summarise(m = mean(counts), 
                   se = sd(counts)/sqrt(length(counts))) %>%
  dplyr::mutate(m = round(m,0))
head(meanse)

meanse %>%
  filter(gene == "PRL") %>%
  ggplot(aes(x = day, y = m, color = manip)) +
  geom_errorbar(aes(ymin=m-se, ymax=m+se), width=.1) +
    geom_point(size = 1) +
  facet_wrap(sex~tissue, scales = "free")
```


```{r writefiles}
write.csv(table2, "../results/table2.csv")

# for victoria
prlmanip <- candidatevsd %>%
  filter(gene == "PRL", 
         treatment %in% c("extend", "m.inc.d8"))
write.csv(prlmanip, "../results/prlmanip.csv")
```