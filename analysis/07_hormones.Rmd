---
title: "hormones"
output: md_document
---

```{r setup}
library(tidyverse)
library(cowplot)
library(readxl)
library(modelr)
library(lubridate)

source("../R/themes.R")  # load custom themes and color palletes

knitr::opts_chunk$set(fig.path = '../figures/hormones/',message=F, warning=FALSE)
```


```{r wrangle-prolactin}
prolactin <- read_excel("../results/Pigeon prolactin concentrations juil 2018.xlsx", sheet = 1)

# keep only samples realated to parental care
prolactin <- prolactin %>% filter(Study %in% c("Baseline", "ParentalCare"))

# create lists of factos for characterization and manipluation studies

# rename some of the treatments levels, store in new columns
prolactin <- prolactin %>%
    mutate(sex = fct_recode(Sex,
                            "female" = "f",
                            "male" = "m"),
           treatment = fct_recode(Treatment,
                            "hatch" = "Hatch",
                            "inc.d17" = "Inc_d17",
                            "inc.d17" = "inc_d17",
                            "inc.d3" = "Inc_d3",
                             "inc.d3" = "inc_d3",
                            "inc.d9" = "Inc_d9",
                             "inc.d9" = "inc_d9",
                            "m.inc.d9" = "M_Inc9",
                            "m.inc.d9" = "M_inc9",
                            "m.inc.d3" = "M_Inc3",
                            "m.inc.d8" = "M_Inc8",
                            "m.inc.d8" = "M_inc8",
                            "m.inc.d17" = "M_Inc17",
                            "m.n2" = "M_hatch",
                            "control" = "baseline",
                            "n5" = "N5", 
                            "n9" = "N9"),
           study = fct_collapse(treatment,
                                 characterization = charlevels,
                                 manipulation = maniplevels1))

colnames(prolactin)[colnames(prolactin)=="Prolactin ng/mL"] <- "plasma_conc"
prolactin$hormone <- "prolactin"
prolactin <- prolactin %>% 
              select(study, treatment, sex, hormone, plasma_conc)  %>% 
              drop_na()

summary(prolactin)
```


```{r wrangle-steroids}
PETC <- read_excel("../results/parental_care_hormone_RIA_data_master.xlsx", sheet = 2)

PETC <- PETC %>% select(stage, sex, hormone, plasma_conc)  %>%
                mutate(treatment = fct_recode(stage,
                            "inc.d17" = "inc_d17",
                            "inc.d3" = "inc_d3",
                            "inc.d9" = "inc_d9",
                            "m.inc.d9" = "m_incd9",
                            "m.inc.d3" = "m_incd3",
                            "m.inc.d8" = "m_incd8",
                            "m.inc.d17" = "m_incd17",
                            "m.n2" = "m_hatch",
                            "control" = "stress_hpg")) %>%
                filter(treatment %in% alllevels2) %>%   
                mutate(sex = fct_recode(sex,
                            "female" = "f",
                            "male" = "m"),
                       study = fct_collapse(treatment,
                                characterization = charlevels,
                                manipulation = maniplevels1)) %>% 
              drop_na() %>%  droplevels()  %>% 
              select(study, treatment, sex, hormone, plasma_conc)
summary(PETC)
```


```{r combine-clean-split}
hormones <- rbind(prolactin, PETC)
hormones$treatment <- factor(hormones$treatment, levels = alllevels)


hormones$okay <- ifelse(hormones$hormone == "cort" & hormones$plasma_conc > 30, "bad",
                    ifelse(hormones$hormone == "progesterone" & hormones$plasma_conc > 5, "bad", 
                           ifelse(hormones$hormone == "prolactin" & hormones$plasma_conc > 150, "bad", 
                        ifelse(hormones$hormone == "testosterone" & hormones$sex == "female", "bad",
                               ifelse(hormones$hormone == "estradiol" & hormones$sex == "male", "bad", "okay")))))
hormones <- hormones %>% filter(okay == "okay") %>% droplevels()
summary(hormones)
```

```{r characterizationplots}
hormonecharplot <- function(myhormone, myylab){

  hormones %>% 
    filter(study == "characterization",
           hormone %in% c(myhormone))  %>% 
    droplevels() %>% 
  ggplot(aes(x = as.numeric(treatment), y = plasma_conc)) +
        geom_smooth(aes(colour = sex)) +
    geom_boxplot(aes(outlier.colour = treatment, fill = treatment, alpha = sex)) +
    mytheme() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.position = "none") +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = myylab, x = NULL) +
    guides(fill = guide_legend(order=1),
         color = guide_legend(order=2)) +
    scale_alpha_manual(values = c(0.75,1)) +
    scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = charlevels)
  }

```

```{r PRLonly}
hormonecharplot("prolactin", "PRL (ng/mL)")
```

```{r sexsteroids}
hormonecharplot("cort", "CORT (ng/mL)")
hormonecharplot("progesterone", "PROG (ng/mL)") 
d1 <- hormonecharplot("estradiol", "E (ng/mL)")
d2 <- hormonecharplot("testosterone", "T (ng/mL)")
plot_grid(d1,d2, nrow = 1)

```


```{r aov-char}
prl.char <- hormones %>% filter(hormone == "prolactin", treatment %in% charlevels)   %>%  droplevels()
test.char <- hormones %>% filter(hormone == "testosterone", treatment %in% charlevels)   %>%  droplevels()
est.char <- hormones %>% filter(hormone == "estradiol", treatment %in% charlevels)   %>%  droplevels()
prog.char <- hormones %>% filter(hormone == "progesterone", treatment %in% charlevels)   %>%  droplevels()
cort.char <- hormones %>% filter(hormone == "cort", treatment %in% charlevels)   %>%  droplevels()


aovSexTretment <- function(mydata, whichormone){
  aov2 <- aov(data = mydata, plasma_conc ~ treatment * sex)
  print(whichormone)
  print(summary(aov2))
  #print(TukeyHSD(aov2, which = "treatment"))
}

aovTretment  <- function(mydata, whichormone){
  aov1 <- aov(data = mydata, plasma_conc ~ treatment )
  print(whichormone)
  print(summary(aov1))
  #print(TukeyHSD(aov1, which = "treatment"))
}

aovSexTretment(prl.char, "PRL") # yes, sex difference (p = 0.00256), yes treatment effect (p < 2e-16), no interaction
aovSexTretment(cort.char, "CORT") # no sex difference (p = 0.779 ), small treatment effect (p = 0.0238),  no interaction
aovSexTretment(prog.char, "PROG") # no sex difference or treatment effect, signifiant interacion (p = 0.0107)

aovTretment(est.char, "E") # p = 0.101
aovTretment(test.char, "T") # p = 0.609
```


```{r manipulation}
# prolactin, removal only
hormones %>% 
    filter( hormone == c("prolactin"))  %>% 
    filter( !treatment %in% c("m.inc.d8", "prolong", "extend"))  %>% 
  ggplot(aes(x = treatment, y = plasma_conc, fill = treatment,  color = sex)) +
    geom_boxplot() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = "PRL (ng/mL)", x = NULL) +
    annotate("rect", xmin = 3.7, xmax = 5.3, ymin = -2, ymax = 0, alpha = 1) +
    annotate("rect", xmin = 5.7, xmax = 7.3, ymin = -2, ymax = 0, alpha = 1) +
    annotate("rect", xmin = 7.7, xmax = 9.3, ymin = -2, ymax = 0, alpha = 1) +
    annotate("rect", xmin = 9.7, xmax = 11.3, ymin = -2, ymax = 0, alpha = 1)

hormones %>% 
    filter( hormone == c("prolactin"))  %>% 
    filter( !treatment %in% c("m.inc.d3", "m.inc.d9", "m.inc.d17","m.n2"))  %>% 
  ggplot(aes(x = treatment, y = plasma_conc, fill = treatment,  color = sex)) +
    geom_boxplot() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = "PRL (ng/mL)", x = NULL) +
    annotate("rect", xmin = 4.7, xmax = 6.3, ymin = -2, ymax = 0, alpha = 1, alpha = 1) +
    annotate("rect", xmin = 6.7, xmax = 8.3, ymin = -2, ymax = 0, alpha = 1, alpha = 1) +
    annotate("rect", xmin = 8.7, xmax = 10.3, ymin = -2, ymax = 0, alpha = 1, alpha = 1)


hormonemanipSteroids <- function(myhormone, myylab, myymax){
  
  hormones %>% 
    filter( hormone %in% c(myhormone))  %>% 
  ggplot(aes(x = treatment, y = plasma_conc, fill = treatment, color = sex)) +
    geom_boxplot() + 
    mytheme() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
         # legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = myylab, x = NULL) 
}

a <- hormonemanipSteroids("estradiol", "E (ng/mL)", 1)
b <- hormonemanipSteroids("testosterone", "T (ng/mL)", 3.5)
c <- hormonemanipSteroids("cort", "CORT (ng/mL)", 10)
d <- hormonemanipSteroids("progesterone", "PROG (ng/mL)",2.5)

a
b
c
d
```


```{r}
write.csv(hormones, "../results/hormones.csv", row.names = F)
```

# do control bird with high prolactin hormone have high PRL expression in the pituitary? yes.

```{r PRLvPRL}
PRLpit <- read_csv("../results/10_PRLpit.csv") %>% 
  filter(treatment == "control") %>% 
  arrange(desc(PRL))
head(PRLpit,2)
```

```{r}
prolactin <- read_excel("../results/Pigeon prolactin concentrations juil 2018.xlsx", sheet = 1)  %>% 
            filter(Treatment == "baseline")  %>% 
            select(ColorBands,BandNo_old, Treatment, Sex, `Prolactin ng/mL`)  %>% 
            arrange(desc(`Prolactin ng/mL`))

head(prolactin,2)
```