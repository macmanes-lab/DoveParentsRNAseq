---
title: "hormones"
output: md_document
---

```{r setup}
library(tidyverse)
library(cowplot)
library(readxl)
library(modelr)
library(lubridate)

source("../R/themes.R")  # load custom themes and color palletes
source("../R/icons.R")

knitr::opts_chunk$set(fig.path = '../figures/hormones/',message=F, warning=FALSE)
```

```{r}
colData  <- read_csv("../metadata/00_birds.csv") %>%
  mutate(RNAseq = "RNAseq",
         bird_id = bird)  %>%
   select(-X1, -bird)
colData
```



```{r wrangle-prolactin}
prolactin <- read_excel("../results/Pigeon prolactin concentrations juil 2018.xlsx", sheet = 1) %>% 
  filter(Study %in% c("Baseline", "ParentalCare")) %>%
    dplyr::mutate(sex = fct_recode(Sex,
                            "female" = "f",
                            "male" = "m"),
           treatment = fct_recode(Treatment,
                            "hatch" = "Hatch",
                            "inc.d17" = "Inc_d17",
                            "inc.d17" = "inc_d17",
                            "inc.d3" = "Inc_d3",
                             "inc.d3" = "inc_d3",
                            "inc.d9" = "Inc_d9",
                             "inc.d9" = "inc_d9",
                            "m.inc.d9" = "M_Inc9",
                            "m.inc.d9" = "M_inc9",
                            "m.inc.d3" = "M_Inc3",
                            "m.inc.d8" = "M_Inc8",
                            "m.inc.d8" = "M_inc8",
                            "m.inc.d17" = "M_Inc17",
                            "m.n2" = "M_hatch",
                            "control" = "baseline",
                            "n5" = "N5", 
                            "n9" = "N9"),
           study = fct_collapse(treatment,
                                 characterization = charlevels,
                                 manipulation = maniplevels1)) %>%
          dplyr::rename("plasma_conc" = "Prolactin ng/mL") %>%
          mutate(bird_id = gsub("[[:punct:]]", "." , ColorBands)) %>% 
          dplyr::mutate(hormone = "prolactin") %>% 
          dplyr::select(study, treatment, sex, bird_id, hormone, plasma_conc)  %>% 
          drop_na()
head(prolactin)


prolactin2 <- read_csv("../results/prolactin.csv") %>% 
          dplyr::rename("plasma_conc" = "prolactin_ng_mL",
                        "treatment" = "stage") %>% 
           dplyr::mutate(hormone = "prolactin") %>% 
           dplyr::mutate(treatment = fct_recode(treatment,
                            "m.n2" = "m.hatch",
                            "prolong" = "inc.prolong",
                            "extend" = "extend.hatch"),
                          study = fct_collapse(treatment,
                                 characterization = charlevels,
                                 manipulation = maniplevels1)) %>% 
  
          dplyr::mutate(bird_id = gsub(".ATLAS", "" , bird_id)) %>% 
          dplyr::select(study, treatment, sex, bird_id, hormone, plasma_conc) 
head(prolactin2)

same <- inner_join(prolactin, prolactin2, by = "bird_id")
ggplot(same, aes(x = plasma_conc.x, y = plasma_conc.y, label = bird_id)) + geom_point() + geom_text()


all <- full_join(prolactin, prolactin2, by = "bird_id") 
onlyin1 <- anti_join(prolactin, prolactin2, by = "bird_id") 
onlyin2 <- anti_join(prolactin2, prolactin, by = "bird_id") 


dim(prolactin)
dim(prolactin2)
dim(all)
dim(same)
dim(onlyin1)
dim(onlyin2)

print("only in old prolactin dataset") 
onlyin1$bird_id

print("only in new prolactin dataset") 
onlyin2$bird_id

prolctin1rnaseq <- full_join(prolactin, colData)
prolctin2rnaseq <- full_join(prolactin2, colData)

prolctin1rnaseq
prolctin2rnaseq
```


```{r wrangle-steroids}
PETC <- read_excel("../results/parental_care_hormone_RIA_data_master.xlsx", sheet = 2)  %>% 
                dplyr::mutate(treatment = fct_recode(stage,
                            "inc.d17" = "inc_d17",
                            "inc.d3" = "inc_d3",
                            "inc.d9" = "inc_d9",
                            "m.inc.d9" = "m_incd9",
                            "m.inc.d3" = "m_incd3",
                            "m.inc.d8" = "m_incd8",
                            "m.inc.d17" = "m_incd17",
                            "m.n2" = "m_hatch",
                            "control" = "stress_hpg")) %>%
                dplyr::filter(treatment %in% alllevels2) %>%   
                dplyr::mutate(sex = fct_recode(sex,
                            "female" = "f",
                            "male" = "m"),
                       study = fct_collapse(treatment,
                                characterization = charlevels,
                                manipulation = maniplevels1)) %>% 
              dplyr::mutate(bird_id = gsub("[[:punct:]]", "." , band_combo)) %>% 
              dplyr::select(study, treatment, sex, bird_id, hormone, plasma_conc) %>% 
             drop_na() %>%  droplevels()  
head(PETC)

```

```{r correlations}
PETCP <- left_join(prolactin2, PETC, by = "bird_id") %>% drop_na()
PETCP$treatment.x <- factor(PETCP$treatment.x, levels = alllevels2)

plothormonecorrelations <- function(myhormone, myylab){
  PETCP %>% filter(hormone.y == myhormone) %>%
  ggplot(aes(x = plasma_conc.x, y = plasma_conc.y, color = treatment.x )) +
  geom_point() + 
  geom_smooth(method = "lm", se = F) +
  labs(x = "Prolactin (ng/mL)", y = myylab) +
  scale_color_manual(values = colorscharmaip) +
  facet_wrap(~treatment.x, nrow = 3) +
  theme(legend.position = "none")
}

plothormonecorrelations("cort", "Corticosterone (ng/mL")
plothormonecorrelations("estradiol", "Estradiol (ng/mL")
plothormonecorrelations("progesterone", "Progesterone (ng/mL")
plothormonecorrelations("testosterone", "Testosterone (ng/mL")
```


```{r combine-clean-split}
hormones <- rbind(prolactin, PETC)
hormones <- left_join(hormones, birds)

hormones$treatment <- factor(hormones$treatment, levels = alllevels)


hormones$okay <- ifelse(hormones$hormone == "cort" & hormones$plasma_conc > 30, "bad",
                    ifelse(hormones$hormone == "progesterone" & hormones$plasma_conc > 5, "bad", 
                           ifelse(hormones$hormone == "prolactin" & hormones$plasma_conc > 150, "bad", 
                        ifelse(hormones$hormone == "testosterone" & hormones$sex == "female", "bad",
                               ifelse(hormones$hormone == "estradiol" & hormones$sex == "male", "bad", "okay")))))
hormones <- hormones %>% filter(okay == "okay") %>% droplevels()
summary(hormones)
```

```{r characterizationplots}
hormonecharplot <- function(myhormone, myylab){

  hormones %>% 
    filter(study == "characterization",
           hormone %in% c(myhormone))  %>% 
    droplevels() %>% 
  ggplot(aes(x = as.numeric(treatment), y = plasma_conc)) +
        geom_smooth(aes(colour = sex)) +
    geom_boxplot(aes(fill = treatment, alpha = sex)) +
    mytheme() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.position = "none") +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = myylab, x = NULL) +
    guides(fill = guide_legend(order=1),
         color = guide_legend(order=2)) +
    scale_alpha_manual(values = c(0.75,1)) +
    scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = charlevels)
  }

```

```{r PRLonly}
hormonecharplot("prolactin", "PRL (ng/mL)")
```



```{r manipulation}
# prolactin, removal only
hormones %>% 
    filter( hormone == c("prolactin"))  %>% 
    filter(treatment %in% c("inc.d3", "m.inc.d3", "inc.d9", "m.inc.d9", "inc.d17", "m.inc.d17", "hatch","m.n2"))  %>% 
  ggplot(aes(x = treatment, y = plasma_conc, fill = treatment,  color = sex)) +
    geom_boxplot() + 
  theme_B3()  +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = "PRL (ng/mL)", x = NULL) +
    ylim(c(-16,100)) +
  
   annotation_custom(inc, xmax = 1.6, ymin = -14, ymax = 5) +
   annotation_custom(removeegg, xmax = 3.6, ymin = -14, ymax = 5) +
   annotation_custom(inc, xmax = 5.6, ymin = -14, ymax = 5) +
   annotation_custom(removeegg, xmax = 7.6, ymin = -14, ymax = 5) +
  annotation_custom(hatch, xmax = 9.6, ymin = -14, ymax = 5) +
  annotation_custom(removeegg, xmax = 11.6, ymin = -14, ymax = 5) +
  annotation_custom(nestling, xmax = 13.6, ymin = -14, ymax = 5) +
  annotation_custom(removechick, xmax = 15.6, ymin = -14, ymax = 5) +
    
    annotate("rect", xmin = 0.6, xmax = 2.4, ymin = -16, ymax = -14, alpha = 0.25) +
    annotate("rect", xmin = 2.6, xmax = 4.4, ymin = -16, ymax = -14, alpha = 0.5) +
    annotate("rect", xmin = 4.6, xmax = 6.4, ymin = -16, ymax = -14, alpha = 0.75)  +
    annotate("rect", xmin = 6.6, xmax = 8.4, ymin = -16, ymax = -14, alpha = 1) 


hormones %>% 
    filter( hormone == c("prolactin"))  %>% 
    filter( treatment %in% c("inc.d9", "m.inc.d8", "inc.d17", "prolong", "hatch", "extend", "n5"))  %>% 
  ggplot(aes(x = treatment, y = plasma_conc, fill = treatment,  color = sex)) +
    geom_boxplot() + 
  theme_B3()  +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = "PRL (ng/mL)", x = NULL) +
  ylim(c(-12,100)) +
   annotation_custom(inc, xmax = 1.6, ymin = -10, ymax = 10) +
   annotation_custom(maniphatch, xmax = 3.6, ymin = -10, ymax = 10) +
   annotation_custom(inc, xmax = 5.6, ymin = -10, ymax = 10) +
   annotation_custom(manipinc, xmax = 7.6, ymin = -10, ymax = 10) +
  annotation_custom(hatch, xmax = 9.6, ymin = -10, ymax = 10) +
  annotation_custom(maniphatch, xmax = 11.6, ymin = -10, ymax = 10) +
  annotation_custom(nestling, xmax = 13.6, ymin = -10, ymax = 10) +
    
  annotate("rect", xmin = 0.6, xmax = 2.4, ymin = -12, ymax = -10, alpha = 0.33) +
    annotate("rect", xmin = 4.6, xmax = 5.4, ymin = -12, ymax = -10, alpha = 0.33) +
    annotate("rect", xmin = 2.6, xmax = 5.4, ymin = -10, ymax = -8, alpha = 0.66) +
    annotate("rect", xmin = 4.6, xmax = 7.4, ymin = -8, ymax = -6, alpha = 1) 
```

```{r sexsteroids}

hormonecharplot("cort", "CORT (ng/mL)")
hormonecharplot("progesterone", "PROG (ng/mL)") 
d1 <- hormonecharplot("estradiol", "E (ng/mL)")
d2 <- hormonecharplot("testosterone", "T (ng/mL)")
plot_grid(d1,d2, nrow = 1)

hormonemanipSteroids <- function(myhormone, myylab, myymax){
  
  hormones %>% 
    filter( hormone %in% c(myhormone))  %>% 
  ggplot(aes(x = treatment, y = plasma_conc, fill = treatment, color = sex)) +
    geom_boxplot() + 
    mytheme() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
         legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = colorscharmaip) +
    scale_color_manual(values = sexcolors) +
    labs(y = myylab, x = NULL) 
}

hormonemanipSteroids("cort", "CORT (ng/mL)", 10)
hormonemanipSteroids("progesterone", "PROG (ng/mL)",2.5)

a <- hormonemanipSteroids("estradiol", "E (ng/mL)", 1)
b <- hormonemanipSteroids("testosterone", "T (ng/mL)", 3.5)
plot_grid(a,b)

```

```{r aov-char}
prl.char <- hormones %>% filter(hormone == "prolactin", treatment %in% charlevels)   %>%  droplevels()
test.char <- hormones %>% filter(hormone == "testosterone", treatment %in% charlevels)   %>%  droplevels()
est.char <- hormones %>% filter(hormone == "estradiol", treatment %in% charlevels)   %>%  droplevels()
prog.char <- hormones %>% filter(hormone == "progesterone", treatment %in% charlevels)   %>%  droplevels()
cort.char <- hormones %>% filter(hormone == "cort", treatment %in% charlevels)   %>%  droplevels()


aovSexTretment <- function(mydata, whichormone){
  aov2 <- aov(data = mydata, plasma_conc ~ treatment * sex)
  print(whichormone)
  print(summary(aov2))
  #print(TukeyHSD(aov2, which = "treatment"))
}

aovTretment  <- function(mydata, whichormone){
  aov1 <- aov(data = mydata, plasma_conc ~ treatment )
  print(whichormone)
  print(summary(aov1))
  #print(TukeyHSD(aov1, which = "treatment"))
}

aovSexTretment(prl.char, "PRL") # yes, sex difference (p = 0.00256), yes treatment effect (p < 2e-16), no interaction
aovSexTretment(cort.char, "CORT") # no sex difference (p = 0.779 ), small treatment effect (p = 0.0238),  no interaction
aovSexTretment(prog.char, "PROG") # no sex difference or treatment effect, signifiant interacion (p = 0.0107)

aovTretment(est.char, "E") # p = 0.101
aovTretment(test.char, "T") # p = 0.609
```



# do control bird with high prolactin hormone have high PRL expression in the pituitary? yes.

```{r PRLvPRL}
PRLpit <- read_csv("../results/10_PRLpit.csv") %>% 
  filter(treatment == "control") %>% 
  arrange(desc(PRL))
head(PRLpit,2)
```

```{r}
write.csv(hormones, "../results/hormones.csv", row.names = F)
write.csv(prolactin2, "../results/07_prolactin2.csv", row.names = F)

```

## for rechelle

```{r forrechelle}

rechelle <- hormones %>%
  dplyr::filter(hormone %in% c("prolactin", "cort"),
                treatment %in% c("lay", "inc.d9", "hatch", "n9")) %>%
  dplyr::select(-icons, -music, -iconpath, -okay)
   
ggplot(rechelle, aes(x = treatment, y = plasma_conc, fill = sex)) +
    geom_boxplot() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
         legend.position = "none",
          strip.text = element_blank()) +
  facet_wrap(~hormone, scales = "free_y") +
  theme_B3()

write.csv(rechelle, "../results/07_forrechelle.csv")
```

