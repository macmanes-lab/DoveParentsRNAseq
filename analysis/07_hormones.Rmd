---
title: "hormones"
output: md_document
---

```{r setup}
library(tidyverse)
library(cowplot)
library(readxl)
library(modelr)
library(lubridate)

source("../R/functions.R")  # load custom functions 
source("../R/themes.R")  # load custom themes and color palletes

knitr::opts_chunk$set(fig.path = '../figures/hormones/',message=F, warning=FALSE)
```

```{r wrangle}
prolactin <- read_excel("../results/Pigeon prolactin concentrations juil 2018.xlsx", sheet = 1)

# keep only samples realated to parental care
prolactin <- prolactin %>% filter(Study %in% c("Baseline", "ParentalCare"))

# create lists of factos for characterization and manipluation studies
charlevels <- c("control", "bldg", "lay", "inc_d3", "inc_d9", "inc_d17", "hatch", "n5", "n9" )
maniplevels <- c("M_inc3", "early", "M_inc9", "M_inc17", "M_n2", "prolong", "extend")
combolevels <- c("control", "bldg", "lay", "inc_d3", "M_inc3",
                  "inc_d9",  "M_inc9",  "inc_d17","M_inc17",  "hatch", "M_n2",
                  "n5", "n9" , "early",  "prolong", "extend")

# rename some of the treatments levels, store in new columns
prolactin <- prolactin %>%
    mutate(sex = fct_recode(Sex,
                            "female" = "f",
                            "male" = "m"),
           treatment = fct_recode(Treatment,
                            "hatch" = "Hatch",
                            "inc_d17" = "Inc_d17",
                            "inc_d3" = "Inc_d3",
                            "inc_d9" = "Inc_d9",
                            "M_inc9" = "M_Inc9",
                            "M_inc3" = "M_Inc3",
                            "early" = "M_Inc8",
                            "early" = "M_inc8",
                            "M_inc17" = "M_Inc17",
                            "M_n2" = "M_hatch",
                            "control" = "baseline",
                            "n5" = "N5", 
                            "n9" = "N9"),
           study = fct_collapse(treatment,
                                 characterization = charlevels,
                                 manipulation = maniplevels))

prolactin$treatment <- factor(prolactin$treatment, levels = combolevels)
```

```{r wranglesteroids}
PETC <- read_excel("../results/parental_care_hormone_RIA_data_master.xlsx", sheet = 2)

PETC <- PETC %>% select(stage, sex, hormone, plasma_conc)  %>%
                filter(stage %in% combolevels)  %>%
                droplevels()
PETC$stage <- factor(PETC$stage)
levels(PETC$stage)

PETC <- PETC %>%
    mutate(sex = fct_recode(sex,
                            "female" = "f",
                            "male" = "m"),
           study = fct_collapse(stage,
                                 characterization = charlevels,
                                 manipulation = maniplevels))
PETC$treatment <- factor(PETC$stage, levels = combolevels)

```



```{r prolactin}
prolactin %>%
  select(treatment, `Prolactin ng/mL`, Sex, study) %>% drop_na() %>%
ggplot(aes(x = treatment, y = `Prolactin ng/mL`, fill = Sex)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom") +
  facet_wrap(~study, scales = "free_x") +
  labs(y = "Prolactin (ng/mL)")
```

```{r testosterone}

PETC %>% 
  filter(hormone == "testosterone", sex == "male")  %>% 
ggplot(aes(x = treatment, y = plasma_conc, fill = sex)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom") +
  facet_wrap(~study, scales = "free_x") +
  labs(y = "Testosterone") +
  scale_fill_manual(values = c("#00BFC4"))
```

```{r estradiol}
PETC %>% 
  filter(hormone == "estradiol", sex == "female")  %>% 
ggplot(aes(x = treatment, y = plasma_conc, fill = sex)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom") +
  facet_wrap(~study, scales = "free_x") +
  labs(y = "Estradiol (ng/mL)") 

```

```{r progesterone}
PETC %>% 
  filter(hormone == "progesterone")  %>% 
ggplot(aes(x = treatment, y = plasma_conc, fill = sex)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom") +
  facet_wrap(~study, scales = "free_x") +
  labs(y = "Progesterone (ng/mL)") +
  ylim(c(0,6))

```

```{r cort}

PETC %>% 
  filter(hormone == "cort")  %>% 
ggplot(aes(x = treatment, y = plasma_conc, fill = sex)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom") +
  facet_wrap(~study, scales = "free_x") +
  labs(y = "Corticosterone (ng/mL)") +
  ylim(c(0,10))


```


```{r prolactin-char}
characterization <- prolactin %>% filter(treatment %in% charlevels)   %>%  droplevels()

mod_prolactin <-  lm(data = characterization, `Prolactin ng/mL` ~ treatment + sex)
mod_prolactin

grid <- characterization %>%
  data_grid(treatment, sex) %>%
  add_predictions(mod_prolactin) 

grid

df <- data.frame(
  x = c(1,2,3,4,5,6,7,8,9),
  y = c(120,120,120,120,120,120,120,120,120),
  sex = c("female", "female", "female", "female", "female", "female","female", "female", "female"),
  text = c("AB",  "A", "A" , "AB", "AB", "BCD", "D", "CD", "BC")
)

a <- ggplot(characterization, aes(x = treatment, y = `Prolactin ng/mL`, fill = sex)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        legend.title = element_blank()) +
  labs(subtitle = "Observed prolactin",
       y = "Concentration (ng/mL)", x = NULL) +
  #geom_text(data = df, aes(x,y, label = text), color = "darkgrey") +
      ylim(0,120) 

b <- ggplot(grid, aes(x = treatment, y = pred, color = sex)) +
  geom_point() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        legend.title = element_blank()) +
  labs(subtitle = "Model prediction ",
       y = NULL, x = NULL) +
  geom_smooth(se = FALSE, aes(x = as.numeric(treatment)))  +
  ylim(0,120)

plot_grid(a,b)
```

```{r aov}
aov1 <- aov(data = characterization, `Prolactin ng/mL` ~ treatment + sex)
aov1
summary(aov1)
TukeyHSD(aov1, which = "treatment")
```

```{r prolactin-manip, fig.width=8} 
manipulation <- prolactin %>% 
  filter(treatment %in% maniplevels) %>%  droplevels() %>% 
  mutate(result = fct_collapse(treatment,
                                "early hatch" = c("early"),
                                "offspring removed" = c("M_inc3",  "M_inc9", "M_inc17", "M_n2"),
                               "late incubation" = c("prolong"),
                               "late hatch" = c("extend")))

e <- manipulation %>%
  ggplot( aes(x = treatment, y = `Prolactin ng/mL`)) +
    geom_boxplot(aes(fill = sex, alpha = 0.5)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "bottom",
          legend.title = element_blank()) +
    ylim(0,125) +
    labs(subtitle = "Manipulation",
       y = NULL, x = NULL) + 
  scale_alpha(guide = 'none')

plot_grid(a,b,e, nrow = 1, rel_widths = c(1.1,.75,.8)) 

f <-  prolactin %>%
  filter(treatment %in% c("control", "bldg", "inc_d3", "M_inc3",
                          "inc_d9",  "M_inc9", "inc_d17","M_inc17",
                          "hatch", "M_n2")) %>%
ggplot(aes(x = treatment, y = `Prolactin ng/mL`, fill = Sex)) +
  geom_boxplot(aes(alpha = study)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(subtitle = "Offspring removed",
       x = NULL) +
  facet_wrap(~sex) +
  annotate("rect", xmin = 2.5, xmax = 4.5, ymin = 0, ymax = 120, alpha = .2) +
    #annotate("rect", xmin = 4.5, xmax = 6.5, ymin = 0, ymax = 120, alpha = .3) +
    annotate("rect", xmin = 6.5, xmax = 8.5, ymin = 0, ymax = 120, alpha = .2) +
    #annotate("rect", xmin = 8.5, xmax = 10.5, ymin = 0, ymax = 120, alpha = .3) +
  ylim(0,120) +
  scale_alpha_manual(values = c(1,0.5))

g <-  prolactin %>%
  filter(treatment %in% c("early","prolong", "extend",
                          "inc_d9","inc_d17","hatch", "n5" )) %>% droplevels() %>%
ggplot(aes(x = treatment, y = `Prolactin ng/mL`, fill = Sex)) +
  geom_boxplot(aes(alpha = study)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  labs(subtitle = "Timing of transition altered",
       x = NULL, y = NULL) +
  facet_wrap(~sex) +
    annotate("rect", xmin = 4.5, xmax = 7.5, ymin = 0, ymax = 120, alpha = .3) +
  ylim(0,120) +
  scale_alpha_manual(values = c(1,0.5))

plot_grid(f,g, nrow=2, rel_widths = c(.625,.375))

```

```{r fortwitter, fig.height= 3, fig.width=5.5}
ggplot(grid, aes(x = treatment, y = pred, color = sex)) +
  geom_point() + 
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        legend.position = c(0.75,0.3),
        legend.title = element_blank()) +
  labs(y = "Gene expression", x = "Time") +
  geom_smooth(se = FALSE, aes(x = as.numeric(treatment)))  
```

```{r}
write.csv(prolactin, "../results/prolactin.csv", row.names = F)
```