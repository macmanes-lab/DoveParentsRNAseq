---
title: "hormones"
output: md_document
---

```{r setup}
library(tidyverse)
library(cowplot)
library(readxl)
library(modelr)
library(lubridate)

source("../R/functions.R")  # load custom functions 
source("../R/themes.R")  # load custom themes and color palletes

knitr::opts_chunk$set(fig.path = '../figures/hormones/',message=F, warning=FALSE)
```

```{r clean}
charlevels <- c("control", "bldg", "lay", "inc_d3", "inc_d9", "inc_d17", "hatch", "n5", "n9" )
removelevels <- c("M_inc3",  "M_inc9", "M_inc17", "M_n2")
maniplevels <- c("early", "prolong", "extend")
combolevels <- c("control", "bldg", "lay", "inc_d3", "M_inc3",
                  "inc_d9",  "M_inc9", "early",  "inc_d17","M_inc17",  "hatch",
                 "prolong", "extend", "M_n2",
                  "n5", "n9" )

manipchar <- c("early",  "inc_d17", "hatch", "prolong", "extend", "n5")
removechar <- c("inc_d3", "M_inc3",  "inc_d9", "M_inc9","inc_d17", "M_inc17","hatch", "M_n2")

sexcolors <- c("female" = "#F8766D", "male" = "#00BFC4")
charcolors <- c("control" = "#F8766D", "bldg" = "#D39200",
                "lay" =  "#93AA00", "inc_d3" = "#00BA38" ,
                "inc_d9" = "#00C19F" , "inc_d17" =  "#00B9E3", 
                "hatch" = "#619Cff" , "n5" =  "#DB72Fb", "n9" =  "#FF61C3")

charsexlevels <- c("control female", "control male", "bldg female", "bldg male",  "lay female", "lay male",
                "inc_d3 female", "inc_d3 male", "inc_d9 female", "inc_d9 male",
                "inc_d17 female", "inc_d17 male", "hatch female", "hatch male", 
                "n5 female", "n5 male", "n9 female" , "n9 male")


```

```{r wrangle-prolactin}
prolactin <- read_excel("../results/Pigeon prolactin concentrations juil 2018.xlsx", sheet = 1)

# keep only samples realated to parental care
prolactin <- prolactin %>% filter(Study %in% c("Baseline", "ParentalCare"))

# create lists of factos for characterization and manipluation studies

# rename some of the timepoints levels, store in new columns
prolactin <- prolactin %>%
    mutate(sex = fct_recode(Sex,
                            "female" = "f",
                            "male" = "m"),
           timepoint = fct_recode(Treatment,
                            "hatch" = "Hatch",
                            "inc_d17" = "Inc_d17",
                            "inc_d3" = "Inc_d3",
                            "inc_d9" = "Inc_d9",
                            "M_inc9" = "M_Inc9",
                            "M_inc3" = "M_Inc3",
                            "early" = "M_Inc8",
                            "early" = "M_inc8",
                            "M_inc17" = "M_Inc17",
                            "M_n2" = "M_hatch",
                            "control" = "baseline",
                            "n5" = "N5", 
                            "n9" = "N9"),
           study = fct_collapse(timepoint,
                                 characterization = charlevels,
                                 manipulation = maniplevels,
                                removal = removelevels))

colnames(prolactin)[colnames(prolactin)=="Prolactin ng/mL"] <- "plasma_conc"
prolactin$hormone <- "prolactin"
prolactin <- prolactin %>% select(study, timepoint, sex, hormone, plasma_conc)   %>% drop_na()

summary(prolactin)
```


```{r wrangle-steroids}
PETC <- read_excel("../results/parental_care_hormone_RIA_data_master.xlsx", sheet = 2)

PETC <- PETC %>% select(stage, sex, hormone, plasma_conc)  %>%
                filter(stage %in% combolevels)  %>%
                droplevels()  
PETC$stage <- factor(PETC$stage)
levels(PETC$stage)

PETC <- PETC %>%
    mutate(sex = fct_recode(sex,
                            "female" = "f",
                            "male" = "m"),
           study = fct_collapse(stage,
                                characterization = charlevels,
                                manipulation = maniplevels)) %>% 
  drop_na()
colnames(PETC)[colnames(PETC)=="stage"] <- "timepoint"
PETC <- PETC %>% select(study, timepoint, sex, hormone, plasma_conc)
summary(PETC)
```


```{r combine-clean-split}
hormones <- rbind(prolactin, PETC)
hormones$timepoint <- factor(hormones$timepoint, levels = combolevels)

hormones <- hormones %>%  mutate(timepoint.sex = paste(timepoint, sex, sep = " ")) 
hormones$timepoint.sex <- factor(hormones$timepoint.sex, levels = charsexlevels)


hormones$okay <- ifelse(hormones$hormone == "cort" & hormones$plasma_conc > 30, "bad",
                    ifelse(hormones$hormone == "progesterone" & hormones$plasma_conc > 5, "bad", 
                           ifelse(hormones$hormone == "prolactin" & hormones$plasma_conc > 150, "bad", 
                        ifelse(hormones$hormone == "testosterone" & hormones$sex == "female", "bad",
                               ifelse(hormones$hormone == "estradiol" & hormones$sex == "male", "bad", "okay")))))
hormones <- hormones %>% filter(okay == "okay") %>% droplevels()
summary(hormones)

prl.char <- hormones %>% filter(hormone == "prolactin", timepoint %in% charlevels)   %>%  droplevels()
test.char <- hormones %>% filter(hormone == "testosterone", timepoint %in% charlevels)   %>%  droplevels()
est.char <- hormones %>% filter(hormone == "estradiol", timepoint %in% charlevels)   %>%  droplevels()
prog.char <- hormones %>% filter(hormone == "progesterone", timepoint %in% charlevels)   %>%  droplevels()
cort.char <- hormones %>% filter(hormone == "cort", timepoint %in% charlevels)   %>%  droplevels()


```

```{r characterizationplots}
hormonecharplot <- function(myhormone, myylab){
  
  mycolors <- charcolors
  sexcolors <- c("female" = "#969696", "male" = "#525252")
  
  hormones %>% 
    filter(study == "characterization",
           hormone %in% c(myhormone))  %>% 
    droplevels() %>% 
  ggplot(aes(x = as.numeric(timepoint), y = plasma_conc)) +
        geom_smooth(aes(colour = sex)) +
    geom_boxplot(aes(outlier.colour = timepoint, fill = timepoint, alpha = sex)) +
    theme_B3() +
    theme(axis.text.x =  element_blank(),
          legend.position = "none") +
    scale_fill_manual(values = mycolors) +
    scale_color_manual(values = sexcolors) +
    labs(y = myylab, x = NULL) +
    guides(fill = guide_legend(order=1),
         color = guide_legend(order=2)) +
    scale_alpha_manual(values = c(0.75,1)) +
    scale_color_manual(values = c("female" = "#969696", "male" = "#525252")) 
  }

```

```{r PRLonly, fig.width = 2.25, fig.height = 1}
hormonecharplot("prolactin", "PRL (ng/mL)")
```

```{r sexsteroids, fig.width=2.25, fig.height= 3}
b <- hormonecharplot("cort", "CORT (ng/mL)")
c <- hormonecharplot("progesterone", "PROG (ng/mL)") 
d1 <- hormonecharplot("estradiol", "E (ng/mL)")
d2 <- hormonecharplot("testosterone", "T (ng/mL)")
d <- plot_grid(d1,d2, nrow = 1)
bcd <- plot_grid(b ,c, d, ncol = 1)
bcd
```


```{r aov-char}
aovSexTretment <- function(mydata, whichormone){
  aov2 <- aov(data = mydata, plasma_conc ~ timepoint + sex)
  print(whichormone)
  print(summary(aov2))
  #print(TukeyHSD(aov2, which = "timepoint"))
}

aovTretment  <- function(mydata, whichormone){
  aov1 <- aov(data = mydata, plasma_conc ~ timepoint )
  print(whichormone)
  print(summary(aov1))
  #print(TukeyHSD(aov1, which = "timepoint"))
}

aovSexTretment(prl.char, "PRL")
aovSexTretment(cort.char, "CORT")
aovSexTretment(prog.char, "PROG")

aovTretment(est.char, "E")
aovTretment(test.char, "T")
```


```{r manipulation}
hormonemanipPRL <- function(myhormone, myylab){
  
  mycolors <- sexcolors
  
  hormones %>% 
    filter(timepoint %in% manipchar,
           hormone %in% c(myhormone))  %>% 
  ggplot(aes(x = timepoint, y = plasma_conc, fill = sex)) +
    geom_boxplot() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = mycolors) +
    labs(y = myylab, x = NULL) +
    facet_wrap(~sex) +
    annotate("rect", xmin = 0.5, xmax = 1.5, ymin = 0, ymax = 125, alpha = .2) +
    annotate("rect", xmin = 3.5, xmax = 5.5, ymin = 0, ymax = 125, alpha = .2) 
}

hormonemanipPRL("prolactin", "PRL (ng/mL)")

hormonemanipSteroids <- function(myhormone, myylab, myymax){
  
  mycolors <- sexcolors
  
  hormones %>% 
    filter(timepoint %in% manipchar,
           hormone %in% c(myhormone))  %>% 
  ggplot(aes(x = timepoint, y = plasma_conc, fill = sex)) +
    geom_boxplot() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = mycolors) +
    labs(y = myylab, x = NULL) +
    facet_wrap(~sex) +
    annotate("rect", xmin = 2.5, xmax = 4.5, ymin = 0, ymax = myymax, alpha = .2)
}

a <- hormonemanipSteroids("estradiol", "E (ng/mL)", 1)
b <- hormonemanipSteroids("testosterone", "T (ng/mL)", 3.5)
c <- hormonemanipSteroids("cort", "CORT (ng/mL)", 10)
d <- hormonemanipSteroids("progesterone", "PROG (ng/mL)",2.5)

plot_grid(d,a,c,b, rel_widths = c(0.65,0.35))
```
```{r removal}
hormoneremoval <- function(myhormone, myylab){
  
  mycolors <- c("female" = "#F8766D", "male" = "#00BFC4")
  
  hormones %>% 
    filter(timepoint %in% removechar,
           hormone %in% c(myhormone))  %>% 
  ggplot(aes(x = timepoint, y = plasma_conc, fill = sex)) +
    geom_boxplot() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none",
          strip.text = element_blank()) +
    scale_fill_manual(values = mycolors) +
    labs(y = myylab, x = NULL) +
    facet_wrap(~sex) +
    annotate("rect", xmin = 1.5, xmax = 2.5, ymin = 0, ymax = 125, alpha = .2) +
    annotate("rect", xmin = 3.5, xmax = 4.5, ymin = 0, ymax = 125, alpha = .2) +
    annotate("rect", xmin = 5.5, xmax = 6.5, ymin = 0, ymax = 125, alpha = .2) + 
    annotate("rect", xmin = 7.5, xmax = 8.5, ymin = 0, ymax = 125, alpha = .2) 
}

hormoneremoval("prolactin", "PRL (ng/mL)")
```

```{r}
write.csv(hormones, "../results/hormones.csv", row.names = F)
```