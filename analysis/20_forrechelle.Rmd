---
title: "forrechelle"
output: md_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggimage)
library(cowplot)
library(forcats)
library(corrr)

source("../R/themes.R")
source("../R/functions.R")

knitr::opts_chunk$set(echo = TRUE, fig.path = "../figures/favegenes/")
```

```{r input}

candidategenes <- c(  "PRLR", "PRL" )
timepoints <- charlevels
hormones <- c("PRL", "CORT")
  
```

```{r rechelle}

datapath <- "../results/"   # path to the data
datafiles <- dir(datapath, pattern = "*allvsd.csv") # get file names
datapathfile <- paste0(datapath, datafiles)

df <- datapathfile %>%
  setNames(nm = .) %>%
  map_df(~read_csv(.x, col_types = cols(), col_names = T), .id = "filename") %>% 
  mutate(tissue = sapply(strsplit(as.character(filename),'../results/06_'), "[", 2)) %>% 
  mutate(tissue = sapply(strsplit(as.character(tissue),'allvsd.csv'), "[", 1))  %>% 
  select(tissue, X1, everything()) 
head(df)

# check which genese appear in multiple tissue
tissuespecificity <- df %>%
  group_by(X1) %>%
  summarize(tissues = str_c(tissue, collapse = ", ")) %>%
  filter(tissues != "gon, hyp, pit") %>%
  group_by(tissues) %>%
  summarize(genes = str_c(X1, collapse = ", ")) %>% 
  mutate(n = str_count(genes, ",") + 1) %>% 
  arrange(desc(n))
tissuespecificity
write.csv(tissuespecificity, "../results/tissuespecificity.csv")
```

```{r}
genes <- as.data.frame(df$X1)
  
df2 <-  df  %>%
  filter(X1 %in% candidategenes) %>%
  pivot_longer(cols = L.Blu13_male_gonad_control.NYNO:y98.o50.x_male_pituitary_inc.d3, 
               names_to = "sample", values_to = "vsd") %>%
   mutate(sex = sapply(strsplit(as.character(sample),'_'), "[", 2)) %>%
   mutate(treatment = sapply(strsplit(as.character(sample),'_'), "[", 4))  %>%
   mutate(treatment = sapply(strsplit(as.character(treatment),'.NYNO'), "[", 1)) %>%
  mutate(bird = sapply(strsplit(as.character(sample),'_'), "[", 1)) %>%
  filter(treatment %in% timepoints) %>%
  select(bird, sex, treatment, tissue, X1, vsd) %>%
  mutate(tissue = fct_recode(tissue, "hypothalamus" = "hyp",
                    "pituitary" = "pit",
                    "gonads" = "gon"
                    )) %>%
  rename(gene = X1) %>%
  drop_na() %>%
  droplevels()
head(df2)

df2$treatment <- factor(df2$treatment, levels = alllevels)

df3 <- df2 %>% 
  mutate(treatment = fct_relevel(treatment, timepoints)) %>% 
  group_by(sex, treatment, tissue, gene)  %>% 
  summarize(m = mean(vsd, na.rm = T), se = sd(vsd,  na.rm = T)/sqrt(length(vsd))) %>%
  mutate(image = "../figures/images/DoveParentsRNAseq_note.png")
head(df3)  

for (i in levels(df3$tissue)) {
  
  p <-  df3 %>%
    filter(tissue == i) %>%
    ggplot(aes(x = treatment, y = m)) +
    geom_errorbar(aes(ymin=m-se, ymax=m+se, color=gene), width=.1) +
    geom_point(size = 1, aes(color = gene)) +
    geom_line(aes(x = as.numeric(treatment), y = m, color = gene)) +
    scale_alpha_manual(values = c(0.5, 1)) +
    labs(subtitle = i, y = "average expression", x = "parental stage") +
    facet_wrap(~sex, nrow = 1) +
    theme_B3()
 print(p)
}

for (i in levels(df3$tissue)) {
  
  p <-  df2 %>%
    filter(tissue == i) %>%
    ggplot(aes(x = treatment, y = vsd, fill = gene, color = sex)) +
    geom_boxplot() +
    scale_alpha_manual(values = c(0.5, 1)) +
    labs(subtitle = i, y = "expression", x = "parental stage") +
    facet_wrap(~gene, scales = "free_y") +
    theme_B3() +
    scale_color_manual(values = sexcolors)
 print(p)
}


dft <- df %>% filter(X1 %in% candidategenes) %>%
  unite("tissuegene", tissue:X1, remove = FALSE) %>%
  select(-tissue, -`X1`, -filename)  %>%
  pivot_longer(-tissuegene, names_to = "samples", values_to = "vsd") %>%
  drop_na() %>%
  mutate("bird" = sapply(strsplit(as.character(samples),'\\_'), "[", 1)) %>%
  select(bird,tissuegene,vsd) %>%
  pivot_wider(id_cols = bird, names_from = tissuegene, values_from = vsd)

dft <- as.data.frame(dft)
row.names(dft) <- dft$bird
dft$bird <- NULL
head(dft)

x <- correlate(dft)


x %>% network_plot.cor_df(min_cor = .2)

x %>%
  focus(pit_PRL) %>%
  mutate(rowname = reorder(rowname, pit_PRL)) %>%
  ggplot(aes(rowname, pit_PRL)) +
    geom_col() + coord_flip() +
  labs(y = "corrleation with pituitiary PRL", x = "candidate genes by tissue") +
  theme_B3() + 
  theme(legend.position = "none")
```


