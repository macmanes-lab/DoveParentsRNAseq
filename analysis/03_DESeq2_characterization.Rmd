---
title: "02_DESeq_characterization"
output: md_document
---

```{r setup, message=F, comment=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(DESeq2)
library(cowplot)
library(RColorBrewer)
library(pheatmap)
library(kableExtra)
library(viridis)
library(ggimage)
library(knitr)
library(kableExtra)


library(png)
library(grid)
library(ggimage)
library(ggpubr)

library(BiocParallel)
register(MulticoreParam(6))

# load custom functions  
source("../R/themes.R") 
source("../R/functions.R") 

knitr::opts_chunk$set(fig.path = '../figures/characterization/', cache = TRUE)
```

## Characterization data

```{r readfiles}
# import "colData" which contains sample information and "countData" which contains read counts
c.colData <- read.csv("../metadata/00_colData_characterization.csv", header = T, row.names = 1)
c.countData <- read.csv("../results/00_countData_characterization.csv", header = T, row.names = 1)
geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)

# set levels
c.colData$treatment <- factor(c.colData$treatment, levels = 
                              c("control",  "bldg", "lay", "inc.d3", "inc.d9", "inc.d17",
                                "hatch", "n5", "n9"))
c.colData$tissue <- factor(c.colData$tissue, levels = 
                              c("hypothalamus",  "pituitary", "gonad"))

levels(c.colData$treatment)
c.colData$sextissue <- as.factor(paste(c.colData$sex, c.colData$tissue, sep = "_"))
summary(c.colData[c(7,3,4,5,8)])

geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)
head(geneinfo)

# confirm gene-level analysis
c.countData %>% 
  mutate(gene = rownames(c.countData)) %>% 
  filter(gene == 'GRIN1') %>% 
  select(gene, everything())
```




## DESeq2 DEGs

```{r createDEGs}
createDEGdf <- function(mydds, whichfactor, up, down, mytissue){
  res <- results(mydds, contrast =c(whichfactor, up, down),
                 independentFiltering = T, alpha = 0.1)
   data <- data.frame(Name = row.names(res),
                     padj = res$padj, 
                     logpadj = -log10(res$padj),
                     lfc = res$log2FoldChange,
                     tissue = mytissue)
  data <- na.omit(data) 
  
  data <- data %>%
    dplyr::mutate(direction = ifelse(data$lfc > 0 & data$padj < 0.1, 
                                     yes = up, no = ifelse(data$lfc < 0 & data$padj < 0.1, 
                                                 yes = down, no = "NS")))
  data$direction <- factor(data$direction, levels = c(down, "NS", up))
  
  data <- left_join(data, geneinfo)  %>%
    select(Name, lfc, padj, logpadj, direction, tissue) %>%
    arrange(desc(lfc)) %>% 
    dplyr::rename("gene" = "Name")
  
  #write dataframe of only significant genes
  DEGs <- data %>% filter(direction != "NS")
  print(str(DEGs))
  myfilename = paste("../results/03_DEGs", mytissue, down,up, "csv", sep = ".")
  write.csv(DEGs, myfilename, row.names = F)
  
  # return data frome with all data, included NS genes
  return(data)
}  

```


### differences between consequtive stages


```{r hypdfs, eval=T}
dds.hypothalamus <- subsetDESeq2(c.colData,  c.countData, c("female_hypothalamus","male_hypothalamus"))

```

```{r hypdfs2, eval=T}
control.bldg <- createDEGdf(dds.hypothalamus, "treatment", "bldg", "control" ,  "hypothalamus")
bldg.lay <- createDEGdf(dds.hypothalamus, "treatment", "lay", "bldg" ,  "hypothalamus")
lay.inc.d3 <- createDEGdf(dds.hypothalamus, "treatment", "inc.d3", "lay" ,  "hypothalamus") 
inc.d3.inc.d9 <- createDEGdf(dds.hypothalamus,  "treatment", "inc.d9", "inc.d3" ,  "hypothalamus") 
inc.d9.inc.d17 <- createDEGdf(dds.hypothalamus, "treatment", "inc.d17", "inc.d9" ,  "hypothalamus")
inc.d17.hatch <- createDEGdf(dds.hypothalamus, "treatment", "hatch", "inc.d17" ,  "hypothalamus") 
hatch.n5 <- createDEGdf(dds.hypothalamus, "treatment", "n5", "hatch" ,  "hypothalamus") 
n5.n9 <- createDEGdf(dds.hypothalamus, "treatment", "n9", "n5" ,  "hypothalamus") 

```

```{r hypplot, eval = T}
a <- plot.volcano(control.bldg, "treatment", "bldg", "control", colorsvolcano)
b <- plot.volcano(bldg.lay, "treatment", "lay", "bldg", colorsvolcano)
c <- plot.volcano(lay.inc.d3, "treatment", "inc.d3", "lay", colorsvolcano) 
d <- plot.volcano(inc.d3.inc.d9, "treatment", "inc.d9", "inc.d3", colorsvolcano) 
e <- plot.volcano(inc.d9.inc.d17, "treatment", "inc.d17", "inc.d9", colorsvolcano)
f <- plot.volcano(inc.d17.hatch, "treatment", "hatch", "inc.d17", colorsvolcano) 
g <- plot.volcano(hatch.n5, "treatment", "n5", "hatch", colorsvolcano) 
h <- plot.volcano(n5.n9, "treatment", "n9", "n5", colorsvolcano) 

hypothalamus <- plot_grid(a + 
                       theme(axis.title.x = element_blank(), axis.text.x = element_blank()) +
                       labs(y = "hypothalamus \n -log10(p)"),
          b + theme(axis.title = element_blank(), axis.text = element_blank()),
          c + theme(axis.title = element_blank(), axis.text = element_blank()),
          d + theme(axis.title = element_blank(), axis.text = element_blank()), 
          e + theme(axis.title = element_blank(), axis.text = element_blank()),
          f + theme(axis.title = element_blank(), axis.text = element_blank()),
          g + theme(axis.title = element_blank(), axis.text = element_blank()),
          h + theme(axis.title = element_blank(), axis.text = element_blank()), 
          nrow = 1,  rel_widths = c(1.75,1,1,1,1,1,1,1,1))
hypothalamus
```

```{r pitdfs, eval=T}
dds.pituitary <- subsetDESeq2(c.colData,  c.countData, c("female_pituitary","male_pituitary"))

```

```{r pitdfs2, eval=T}
control.bldg <- createDEGdf(dds.pituitary, "treatment", "bldg", "control", "pituitary")
bldg.lay <- createDEGdf(dds.pituitary, "treatment", "lay", "bldg", "pituitary")
lay.inc.d3 <- createDEGdf(dds.pituitary, "treatment", "inc.d3", "lay", "pituitary") 
inc.d3.inc.d9 <- createDEGdf(dds.pituitary,  "treatment", "inc.d9", "inc.d3", "pituitary") 
inc.d9.inc.d17 <- createDEGdf(dds.pituitary, "treatment", "inc.d17", "inc.d9", "pituitary")
inc.d17.hatch <- createDEGdf(dds.pituitary, "treatment", "hatch", "inc.d17", "pituitary") 
hatch.n5 <- createDEGdf(dds.pituitary, "treatment", "n5", "hatch", "pituitary") 
n5.n9 <- createDEGdf(dds.pituitary, "treatment", "n9", "n5", "pituitary") 

```

```{r pitplot, eval = T}
a <- plot.volcano(control.bldg, "treatment", "bldg", "control", colorsvolcano)
b <- plot.volcano(bldg.lay, "treatment", "lay", "bldg", colorsvolcano)
c <- plot.volcano(lay.inc.d3, "treatment", "inc.d3", "lay", colorsvolcano) 
d <- plot.volcano(inc.d3.inc.d9, "treatment", "inc.d9", "inc.d3", colorsvolcano) 
e <- plot.volcano(inc.d9.inc.d17, "treatment", "inc.d17", "inc.d9", colorsvolcano)
f <- plot.volcano(inc.d17.hatch, "treatment", "hatch", "inc.d17", colorsvolcano) 
g <- plot.volcano(hatch.n5, "treatment", "n5", "hatch", colorsvolcano) 
h <- plot.volcano(n5.n9, "treatment", "n9", "n5", colorsvolcano) 

pituitary <- plot_grid(a + 
                       theme(axis.title.x = element_blank(), axis.text.x = element_blank()) +
                       labs(y = "pituitary \n -log10(p)"),
          b + theme(axis.title = element_blank(), axis.text = element_blank()),
          c + theme(axis.title = element_blank(), axis.text = element_blank()),
          d + theme(axis.title = element_blank(), axis.text = element_blank()), 
          e + theme(axis.title = element_blank(), axis.text = element_blank()),
          f + theme(axis.title = element_blank(), axis.text = element_blank()),
          g + theme(axis.title = element_blank(), axis.text = element_blank()),
          h + theme(axis.title = element_blank(), axis.text = element_blank()), 
          nrow = 1,  rel_widths = c(1.75,1,1,1,1,1,1,1,1))
pituitary

```


```{r gonaddfs, eval=T}
dds.gonads <- subsetDESeq2(c.colData,  c.countData, c("female_gonad","male_gonad"))

```

```{r gonaddfs2, eval=T}
control.bldg <- createDEGdf(dds.gonads, "treatment", "bldg", "control",  "gonads")
bldg.lay <- createDEGdf(dds.gonads, "treatment", "lay", "bldg",  "gonads")
lay.inc.d3 <- createDEGdf(dds.gonads, "treatment", "inc.d3", "lay",  "gonads") 
inc.d3.inc.d9 <- createDEGdf(dds.gonads, "treatment", "inc.d9", "inc.d3",  "gonads") 
inc.d9.inc.d17 <- createDEGdf(dds.gonads, "treatment", "inc.d17", "inc.d9",  "gonads")
inc.d17.hatch <- createDEGdf(dds.gonads, "treatment", "hatch", "inc.d17",  "gonads") 
hatch.n5 <- createDEGdf(dds.gonads, "treatment", "n5", "hatch",  "gonads") 
n5.n9 <- createDEGdf(dds.gonads, "treatment", "n9", "n5",  "gonads") 
```

```{r gonplot, eval=T}
a2 <- plot.volcano(control.bldg, "treatment", "bldg", "control", colorsvolcano)
b2 <- plot.volcano(bldg.lay, "treatment", "lay", "bldg", colorsvolcano)
c2 <- plot.volcano(lay.inc.d3, "treatment", "inc.d3", "lay", colorsvolcano) 
d2 <- plot.volcano(inc.d3.inc.d9, "treatment", "inc.d9", "inc.d3", colorsvolcano) 
e2 <- plot.volcano(inc.d9.inc.d17, "treatment", "inc.d17", "inc.d9", colorsvolcano)
f2 <- plot.volcano(inc.d17.hatch, "treatment", "hatch", "inc.d17", colorsvolcano) 
g2 <- plot.volcano(hatch.n5, "treatment", "n5", "hatch", colorsvolcano) 
h2 <- plot.volcano(n5.n9, "treatment", "n9", "n5", colorsvolcano) 

gonads <- plot_grid(a2 + labs(y = "gonads \n -log10(p)"),
          b2 + theme(axis.title.y = element_blank(), axis.text.y = element_blank()),
          c2 + theme(axis.title.y = element_blank(), axis.text.y = element_blank()),
          d2 + theme(axis.title.y = element_blank(), axis.text.y = element_blank()) +
            labs(x = "log fold change"), 
          e2 + theme(axis.title.y = element_blank(), axis.text.y = element_blank()), 
          f2 + theme(axis.title.y = element_blank(), axis.text.y = element_blank()),
          g2 + theme(axis.title.y = element_blank(), axis.text.y = element_blank()),
          h2 + theme(axis.title.y = element_blank(), axis.text.y = element_blank()), 
          nrow = 1, rel_widths = c(1.75,1,1,1,1,1,1,1,1))
gonads
```



```{r allvolcanos, fig.height=6}
background <- png::readPNG("../figures/images/DoveParentsRNAseq_charicons.png")
icons <- ggdraw() +  draw_image(background, scale = 1)
plot_grid(icons, hypothalamus, pituitary, gonads, nrow = 4, rel_heights = c(1,1,1,1.25))
```
