---
title: "05_DESeq_manipulation"
output: md_document
---

```{r setup, message=F, comment=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(DESeq2)
library(cowplot)
library(factoextra)
library(Rtsne)

# load custom functions  
source("../R/functions.R") 
source("../R/themes.R") 


knitr::opts_chunk$set(fig.path = '../figures/manipulation/', cache = TRUE)
```

## Manipulation data

```{r readfiles}
# import "colData" which contains sample information and "countData" which contains read counts
m.colData <- read.csv("../metadata/00_colData_manipluation.csv", header = T, row.names = 1)
m.countData <- read.csv("../results/00_countData_manipluation.csv", header = T, row.names = 1)
geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)

# set levels
m.colData$treatment <- factor(m.colData$treatment, levels = 
                              c("m.inc.d3",  "m.inc.d8",
                                "m.inc.d9", "m.inc.d17",
                                "prolong", "extend", "m.n2"))

m.colData$sextissue <- as.factor(paste(m.colData$sex, m.colData$tissue, sep = "_"))

m.colData$outcome <- ifelse(grepl("d3|d9|d17", m.colData$treatment), "end inc", 
                     ifelse(grepl("d8|n2", m.colData$treatment),"end hatch",
                     ifelse(grepl("prolong", m.colData$treatment),"prolong inc",
                     ifelse(grepl("extend", m.colData$treatment),"delay hatch", NA))))

summary(m.colData[c(7,3,4,5,8)])
```

## Run DESeq on all subsets of the data

```{r dds, cache = T}
dds.female_hypothalamus <- subsetDESeq("female_hypothalamus")
dds.female_pituitary <- subsetDESeq("female_pituitary" )
dds.female_gonad <- subsetDESeq("female_gonad" )
dds.male_hypothalamus <- subsetDESeq("male_hypothalamus" )
dds.male_pituitary <- subsetDESeq("male_pituitary"  )
dds.male_gondad <- subsetDESeq("male_gonad")
```


## Calculate and plot total DEGs

```{r totalDEGs, eval = T}
#create list of groups for deseq contrasts
group1 <- c("m.inc.d3","m.inc.d8", "m.inc.d9", "m.inc.d17", "prolong","extend", "m.n2" ) 
group2 <- group1

a <- plottotalDEGs(dds.female_hypothalamus, "female hypothalamus")
b <- plottotalDEGs(dds.female_pituitary, "female pituitary")
c <- plottotalDEGs(dds.female_gonad, "female gonad")
d <- plottotalDEGs(dds.male_hypothalamus, "male hypothalamus")
e <- plottotalDEGs(dds.male_pituitary, "male pituitary")
f <- plottotalDEGs(dds.male_gondad, "male gonad")

plot_grid(a + theme(legend.position = "none"),
          b + theme(legend.position = "none"),
          c,
          d + theme(legend.position = "none"),
          e + theme(legend.position = "none"),
          f,
          nrow = 2, rel_widths = c(0.3, 0.3, 0.4)) 
```


## Calculate and plot principal components


```{r pca, eval = F}
plotPCAs(dds.female_hypothalamus, "female hypothalamus")
plotPCAs(dds.female_pituitary, "female pituitary")      
plotPCAs(dds.female_gonad, "female gonad")
plotPCAs(dds.male_hypothalamus, "male hypothalamus")
plotPCAs(dds.male_pituitary, "male pituitary")
plotPCAs(dds.male_gondad, "male gonad")
```

## heamap with minimum pvalue

```{r pheatmap, eval = F}
makepheatmap(dds.female_hypothalamus, "female hypothalamus")
makepheatmap(dds.female_pituitary, "female pituitary")
makepheatmap(dds.female_gonad, "female gonad")
makepheatmap(dds.male_hypothalamus, "male hypothalamus")
makepheatmap(dds.male_pituitary, "male pituitary")
makepheatmap(dds.male_gondad, "male gonad")        
```

## candidate genes

```{r candidates, eval = F}
plotcandidates(dds.female_hypothalamus, "female hypothalamus")
plotcandidates(dds.female_pituitary, "female pituitary")
plotcandidates(dds.female_gonad, "female gonad")
plotcandidates(dds.male_hypothalamus, "male hypothalamus")
plotcandidates(dds.male_pituitary, "male pituitary")
plotcandidates(dds.male_gondad, "male gonad")

```

## offspring removal

```{r offspringremoval, eval = F}
g <- plotremoval(DEGs.female_hypothalamus, "Female hypothalamus", "bottom")
h <- plotremoval(DEGs.female_pituitary, "Female pituitary", "none")
i <- plotremoval(DEGs.female_gonad, "Female gonad",  "none")
j <- plotremoval(DEGs.male_hypothalamus, "Male hypothalamus", "none")
k <- plotremoval(DEGs.male_pituitary, "Male pituitary", "none")
l <- plotremoval(DEGs.male_gondad, "Male gonad", "none")

legend <- get_legend(g)

mybarplots <- plot_grid(g + theme(legend.position = "none"), h , i , j ,k , l, nrow = 2) 

mybarplots2 <- plot_grid(mybarplots, legend, ncol = 1, rel_heights = c(1,0.1))
mybarplots2

pdf("../figures/sexes/offspringremoval-1.pdf", width = 10, height = 6)
plot(mybarplots2)
dev.off()

```

## prolong extend

```{r prolongextend, eval = F}
g <- plotprolongdelay(DEGs.female_hypothalamus, "Female hypothalamus", "bottom")
h <- plotprolongdelay(DEGs.female_pituitary, "Female pituitary", "none")
i <- plotprolongdelay(DEGs.female_gonad, "Female gonad",  "none")
j <- plotprolongdelay(DEGs.male_hypothalamus, "Male hypothalamus", "none")
k <- plotprolongdelay(DEGs.male_pituitary, "Male pituitary", "none")
l <- plotprolongdelay(DEGs.male_gondad, "Male gonad", "none")

legend <- get_legend(g)

mybarplots <- plot_grid(g + theme(legend.position = "none"), h , i , j ,k , l, nrow = 2) 

mybarplots2 <- plot_grid(mybarplots, legend, ncol = 1, rel_heights = c(1,0.1))
mybarplots2

pdf("../figures/sexes/prolongextend-1.pdf", width = 10, height = 6)
plot(mybarplots2)
dev.off()

```

# pca and tsne

```{r}
pseudocounts <- read_csv("../results/01_pseudo.counts.csv")
head(pseudocounts[1:3])

colData <- read.csv("../metadata/00_colData_manipluation.csv", header = T, row.names = 1)

colData$treatment <- factor(colData$treatment, levels = maniplevels1)
colData$tissue <- factor(colData$tissue, levels = c("hypothalamus", "pituitary", "gonad"))
colData <- colData %>% mutate(tissue = fct_recode(tissue, "gonads" = "gonad"))
head(colData[1:3])

geneinfo <- read.csv("../metadata/00_geneinfo.csv", row.names = 1)


subsetcounts <- function(colData, countData){
  
  # save counts that match colData
  savecols <- as.character(colData$V1) 
  savecols <- as.vector(savecols) 
  countData <- countData %>% 
    dplyr::select(X1,savecols) %>% 
    dplyr::rename(entrezid = X1)  
  
  countData <- left_join(geneinfo, countData)
  print(head(countData))
  countData <- countData %>% dplyr::distinct(Name, .keep_all = TRUE) %>%
    dplyr::select(-row.names)  %>% dplyr::select(-geneid) %>% dplyr::select(-entrezid) 
  print(head(countData))
  row.names(countData) <- countData$Name
  countData$Name <- NULL
  countData <- as.data.frame(t(countData))
  
  return(countData)
}

countData <- subsetcounts(colData, pseudocounts)
head(countData[1:3])
head(colData)
# confirm
row.names(colData) <- colData$V1
row.names(countData) == row.names(colData)

euclidist <- dist(countData) # euclidean distances between the rows
```


```{r pcaprep}
# make pca dataframes
mypca <- prcomp(countData)

# percent conribution
eig.val <- get_eigenvalue(mypca)
head(eig.val)

mypcadf <- data.frame(PC1 = mypca$x[, 1], PC2 = mypca$x[, 2], PC3 = mypca$x[, 3], 
                  PC4 = mypca$x[, 4],PC5 = mypca$x[, 5],PC6 = mypca$x[, 6],
                  ID = row.names(countData))
mypcadf$V1 <- row.names(mypcadf)
mypcadf <- left_join(colData, mypcadf)
mypcadf <- mypcadf %>% dplyr::select(bird,sex,tissue,treatment,PC1:PC6)
mypcadf$treatment <- factor(mypcadf$treatment, levels = maniplevels1)
head(mypcadf)

a <- ggplot(mypcadf, aes(x = PC1, y = PC2, 
                         color = colData$treatment, 
                         shape = colData$tissue,
                         alpha = colData$sex)) +
  geom_point(size = 2)  + 
  mytheme() +
  theme(legend.title = element_blank(), 
        axis.text = element_blank()) +
  scale_alpha_manual(values = c(0.5,1)) +
  scale_color_manual(values = colorsmaniplevels1) +
  labs(x = "PC1: 63.6% of variance", y = "PC2: 30.1% of variance") 
  

b <-  fviz_pca_var(mypca,  labelsize = 3 , axes.linetype = "blank", 
                   repel = TRUE ,
                  select.var= list(contrib = 6)) + 
      mytheme() + 
      labs(x = " ", y = " ", subtitle = NULL, title =  NULL) 

png('../figures/manipulation/pcaprep-1.png',width=600,height=600, units="px",bg = "transparent")
print(a)
dev.off()

png('../figures/manipulation/pcaprep-2.png',width=600,height=600, units="px",bg = "transparent")
print(b)
dev.off()
```

```{r tsne}

tsne_model <- Rtsne(euclidist, check_duplicates=FALSE, pca=TRUE, perplexity=5, theta=0.5, dims=2)
tsne_df = as.data.frame(tsne_model$Y) 
plot(tsne_df$V1, tsne_df$V2)

# prep for adding columns
colData2 <- colData 
colData2$V1 <- NULL
tsne_df_cols <- cbind(colData2, tsne_df)

c  <- ggplot(tsne_df_cols, aes(x = V1, y = V2, shape = sex, color = tissue)) +
  geom_point(size = 2) +
  mytheme() +
  scale_color_manual(values = c("#d95f02","#1b9e77", "#7570b3")) +
  labs(x = "tSNE 1", y = "tSNE 2")

d <- ggplot(tsne_df_cols, aes(x = V1, y = V2, shape = tissue, color = treatment, alpha = sex)) +
  geom_point(size = 2) +
  mytheme() +
  labs(x = "tSNE 1", y = "tSNE 2") +
  scale_color_manual(values = colorsmaniplevels1) +
  scale_alpha_manual(values = c(0.5,1))

c
d
```

