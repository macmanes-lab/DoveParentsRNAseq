---
title: "Fig2: Candidate genes"
author: "Rayna M Harris"
date: "3/26/2020"
output: md_document
---


# Candidate gene analysis 

```{r setup, message=F}
library(tidyverse)
library(ggtext)
library(cowplot)
library(ggpubr)
library(knitr)
library(kableExtra)
library(corrr)
library(ggsignif)
library(magick)
library(scales)
library(ggimage)


source("../R/themes.R")
source("../R/functions.R")
source("../R/wrangledata.R")

knitr::opts_chunk$set(echo = TRUE, message = F, fig.path = "../figures/")
```



## Candidate DEGs


```{r DEGs}
# summary DEG results from DESeq2
candidateDEGS <- read_csv("../results/suppletable1.csv") %>%
  filter(gene %in% candidategenes) %>%
  mutate(posneg = ifelse(lfc >= 0, "+", "-"),
         sex = recode(sex, "female" = "F", "male" = "M" ),
         tissue = recode(tissue, 
                         "hypothalamus" = "H",
                         "pituitary" = "P", "gonad" = "G")) %>%
  mutate(res = paste(sex, tissue, posneg, sep = "")) %>%
  select(gene, res, comparison)  %>%
  group_by(gene,  comparison) %>%
  summarize(res = str_c(res, collapse = " ")) %>%
  pivot_wider(names_from = comparison, values_from = res) %>%
  select(gene, control_bldg, bldg_lay, lay_inc.d3, inc.d3_inc.d9, inc.d9_inc.d17, hatch_n5, n5_n9)
candidateDEGS

## table 1 summary candidate genes
table1 <- left_join(candidateDEGS, parentalcaregenes) %>%
  select(gene, control_bldg:n5_n9, parentalcare, parentalbehavior, NCBI) %>%
  mutate(parentalcare = if_else(is.na(parentalcare), " ", "X"),
         parentalbehavior = if_else(is.na(parentalbehavior), " ", "X")) %>%
  rename("Literature" = "parentalcare", "GO" =  "parentalbehavior")
table1$numDEGs <- rowSums(is.na(table1)) # count NAs to know how many are NS

table1 <- table1 %>% 
  mutate(sig = ifelse(numDEGs == 6, "NS", "DEG")) %>% 
  arrange(gene)  %>%  select(-sig, -numDEGs)
table1[is.na(table1)] <- " " # replace NA with blank space so it's pretty
head(table1)

kable(table1)
```

## Candidate Correlations


```{r}
# load `candidatevsd` with `source("../R/wrangledata.R")`
head(candidatevsd)

curleychampagnegenes <- curleychampagnegenes %>% pull(gene)

hyp1 <- makecorrdf("female", "hypothalamus", curleychampagnegenes)  
pit1 <- makecorrdf("female", "pituitary", curleychampagnegenes)  
gon1 <- makecorrdf("female", "gonad", curleychampagnegenes)  

hyp2 <- makecorrdf("male", "hypothalamus", curleychampagnegenes)  
pit2 <- makecorrdf("male", "pituitary", curleychampagnegenes)  
gon2 <- makecorrdf("male", "gonad", curleychampagnegenes)  

hyp3 <- makecorrdf(sexlevels, "hypothalamus", curleychampagnegenes)  
pit3 <- makecorrdf(sexlevels, "pituitary", curleychampagnegenes)  
gon3 <- makecorrdf(sexlevels, "gonad", curleychampagnegenes)  


candidatevsdwide <- candidatevsd  %>%
    pivot_wider(names_from = gene, values_from = counts) 
FH <- subsetcandidatevsdwide("female", "hypothalamus")
FP <- subsetcandidatevsdwide("female", "pituitary")
FG <- subsetcandidatevsdwide("female", "gonad")
MH <- subsetcandidatevsdwide("male", "hypothalamus")
MP <- subsetcandidatevsdwide("male", "pituitary")
MG <- subsetcandidatevsdwide("male", "gonad") 

```


### Candidate gene functions


```{r}
candidateboxplot <- function(whichtissue, whichgenes, whichsex){
  
  p <- candidatevsd %>%
    filter(tissue %in% whichtissue,
          gene %in% whichgenes,
          sex %in% whichsex) %>%
    mutate(treatment = factor(treatment, levels = charlevels)) %>%
    ggplot(aes(x = treatment, y = counts)) +
    geom_boxplot(aes(fill = treatment, color = sex), outlier.shape = NA) +
    geom_jitter(size = 0.25, aes(color = sex)) +
    facet_wrap(~sex, scales = "free_y", nrow = 1) +
    scale_fill_manual(values = allcolors) +
    scale_color_manual(values = allcolors) +
    theme_B3() + 
    theme(legend.position = "none",
          axis.title.y = element_text(face = "italic"),
          axis.text.x = element_blank(),
          axis.ticks = element_blank()) +
    labs(y = whichgenes,
         x = NULL) +
    geom_signif(comparisons = list(c( "control", "bldg"),
                                 c( "bldg", "lay"),
                                 c( "lay", "inc.d3"),
                                 c("inc.d3", "inc.d9"),
                                 c( "inc.d9", "inc.d17"),
                                 c( "inc.d17", "hatch"),
                                 c("hatch", "n5"),
                                 c( "n5", "n9")),  
                map_signif_level=TRUE,
                textsize = 1.5, family = 'Helvetica',
                vjust = 1.5, size = 0) 
                
  return(p)
}

scattercorrelations <- function(df, gene1, gene2, mylinecolor, myxlab, myylab){
  p <- ggplot(df, aes(x = gene1, y = gene2)) +
    labs(subtitle = " ", x = myxlab, y = myylab) + 
    scale_color_manual(values = allcolors) +
    geom_smooth(method = "glm",  color = mylinecolor) +
    geom_point(aes(color = treatment))  +
    theme_B3() +  
    theme(axis.title = element_text(face = "italic"), 
            legend.position = "none") +
    stat_cor( size = 2)
  return(p)
}


```


```{r fig2, fig.width = 7.25, fig.height = 7.25}

header <- png::readPNG("../figures/images/fig_fig2a.png")
header <- ggdraw() +  draw_image(header, scale = 1)


b <- plotcorrplot(hyp3, "females and males") + theme(legend.position = "none")  + labs(title = "Hypothalamus")
g <- plotcorrplot(pit3, NULL) + theme(legend.position = "none") + labs(title = "Pituitary")
l <- plotcorrplot(gon3, NULL) + theme(legend.position = "none")  + labs(title = "Gonad")

c <- scattercorrelations(FH, FH$DRD1, FH$HTR2C, "#969696", "DRD1", "HTR2C") + labs(subtitle = "female") + labs(title = "")
h <- scattercorrelations(FP, FP$AVPR1A, FP$CRHR1, "#969696", "AVPR1A", "CRHR1")  + labs(subtitle = NULL)+ labs(title = "")
m <- scattercorrelations(FG, FG$ESR1, FG$PGR, "#969696", "ESR1", "PGR")   + labs(subtitle = NULL)+ labs(title = "")

d <- scattercorrelations(MH, MH$DRD1, MH$HTR2C, "#525252", "DRD1", "HTR2C")  + labs(subtitle = "male") + labs(title = "")
i <- scattercorrelations(MP, MP$AVPR1A, MP$CRHR1, "#525252", "AVPR1A", "CRHR1")  + labs(subtitle = NULL) + labs(title = "")
n <- scattercorrelations(MG, MG$ESR1, MG$PGR, "#525252", "ESR1", "PGR")  + labs(subtitle = NULL) + labs(title = "")


d1 <- candidateboxplot("hypothalamus", c("DRD1"), sexlevels) + labs(x = NULL , title = " ")  + theme(axis.line.x = element_blank()) 
d2 <- candidateboxplot("hypothalamus", c("HTR2C"), sexlevels) + labs(x = "Parental stage" ) + theme(strip.text = element_blank())

g1 <- candidateboxplot("pituitary", c("AVPR1A"), sexlevels) + labs(x = NULL, title = " " )  + theme( strip.text = element_blank(), axis.line.x = element_blank())
g2 <- candidateboxplot("pituitary", c("CRHR1"), sexlevels) + labs(x = "Parental stage"  )  + theme(strip.text = element_blank())

j1 <- candidateboxplot("gonad", c("ESR1"), sexlevels) + labs(x = NULL , title = " ") + theme(strip.text = element_blank(), axis.line.x = element_blank())
j2 <- candidateboxplot("gonad", c("PGR"), sexlevels) + labs(x = "Parental stage"  ) + theme(strip.text = element_blank())


btn <- plot_grid(b,c,d, g,h,i,l,m,n, ncol = 3, labels = c("B", "C", " ","E", "F", " ", "H", "I"), label_size = 8, rel_widths = c(1.4,1,1), rel_heights = c(1.1,1,1))
dgj <- plot_grid(d1,d2,g1,g2,j1,j2, ncol = 1, labels = c("D", " ", "G", " " , "J"), label_size = 8, rel_heights = c(1.3,1,1.2,1,1.2,1))
btoj <- plot_grid(btn,dgj, ncol = 2 , rel_widths = c(1.75,1))

plot_grid(header, btoj,  rel_heights = c(0.2,1), ncol = 1)

```

```{r fig3, fig.height=3, fig.width=7.25}

musicplot <- function(whichgene, whichtissue){
    
    p <- candidatevsd %>%
      group_by(treatment, tissue, gene, sex)  %>% 
      summarize(median = median(counts, na.rm = T), 
                se = sd(counts,  na.rm = T)/sqrt(length(counts))) %>%
      dplyr::mutate(scaled = rescale(median, to = c(0, 7))) %>%
      dplyr::mutate(image = "../figures/images/musicnote.png")   %>%
      filter(
        gene %in% whichgene,
        tissue %in% whichtissue      ) %>% 
      collect() %>%
      drop_na() %>%
      ggplot( aes(x = treatment, y = median)) +
      geom_errorbar(aes(ymin = median - se, 
                        ymax = median + se, color = "white"),  width=0) +
      geom_image(aes(image=image), size = 0.1)+
      theme_B3() +
      theme(legend.position = "none",
            title = element_text(face = "italic"),
            strip.text = element_text(color = "white"),
            axis.text.x = element_text(angle = 45, hjust = 1),
            axis.text.y = element_blank(),
            axis.line = element_blank(), axis.ticks = element_blank()) +
      scale_color_manual(values = allcolors) +
      labs(y = " ",x = NULL ) +
      facet_wrap(~sex, nrow = 2, scales = "free_y")
      return(p)
}

music <- png::readPNG("../figures/images/fig_music.png")
music <- ggdraw() +  draw_image(music, scale = 1)

musicalgenes <- png::readPNG("../figures/images/fig_musicalgenes.png")
musicalgenes <- ggdraw() +  draw_image(musicalgenes, scale = 1)


p1 <- musicplot(c("AVP", "OXT"), "hypothalamus") + labs(subtitle = "Hypothalamic AVP & OXT" ) + theme(axis.text.x = element_blank())
p2 <- musicplot(c("AVP", "OXT"), "pituitary") + labs(subtitle = "Pituitary AVP & OXT " ) + theme(axis.text.x = element_blank())
p3 <- musicplot(c("AVP", "OXT"), "gonad") + labs(subtitle = "Gonadal  AVP & OXT"  )

p123 <- plot_grid(music, p1, music, p3, ncol = 2, rel_widths = c(0.125,1))

plot_grid(musicalgenes, p123, nrow = 1, rel_widths = c(1.5,1))

```






```{r writefiles}
#write.csv(candidatevsd, "../../musicalgenes/data/candidatecounts.csv")
#write.csv(candidatevsd, "../results/candidatecounts.csv")
write.csv(table1, "../results/table1.csv")
write.csv(candidategenes, "../results/candidategenes.csv")
```