---
title: "Fig2: Candidate genes"
author: "Rayna M Harris"
date: "3/26/2020"
output: md_document
---


# Candidate gene analysis 

```{r setup}
library(tidyverse)
library(ggtext)
library(cowplot)
library(ggpubr)
library(knitr)
library(kableExtra)

source("../R/themes.R")

knitr::opts_chunk$set(echo = TRUE, message = F, fig.path = "../figures/")
```


## Candidate Genes (from literature and relevant GO terms) 


```{r GO}

# all genes in this parental care dataset 

geneids <- read_csv("../metadata/00_geneinfo.csv") %>%
  select(-X1) %>%
  rename("NCBI" = "entrezid",
         "gene" = "Name")

# From Ch 17 Evolution of parental care
curleychampagnegenes <- c("AVPR1A", "ADRA2A",    
                         "COMT", "CRH", "CRHBP", "CRHR1", "CRHR2", 
                          "DRD1", "DRD4","ESR1", "ESR2", #ERa ERbeta
                          "FOS", "HTR2C", "MEST", "NR3C1", #GR
                          "OPRM1", "PGR", "PRL", "PRLR",  "SLC6A4") #5HTT
curleychampagnegenes <- as.data.frame(curleychampagnegenes) %>%
  mutate(GO = "parentalcare", gene = curleychampagnegenes)  %>%
  select(GO, gene)
curleychampagnegenes


# Candidate GO terms 
GO_path <- "../metadata/goterms/"   # path to the data
GO_files <- dir(GO_path, pattern = "*.txt") # get file names
GO_pathfiles <- paste0(GO_path, GO_files)

GOgenesLong <- GO_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_table(.x, col_types = cols(), col_names = FALSE), .id = "file_name") %>% 
  mutate(GO = sapply(strsplit(as.character(file_name),'../metadata/goterms/'), "[", 2)) %>% 
  mutate(GO = sapply(strsplit(as.character(GO),'.txt'), "[", 1)) %>% 
  mutate(gene = sapply(strsplit(as.character(X1), "[\\\\]|[^[:print:]]" ), "[", 2)) %>% 
  select(GO, gene)  %>%
  filter(gene != "Symbol") %>%
  distinct(GO,gene)  %>%
  mutate(gene = toupper(gene)) %>%
  rbind(., curleychampagnegenes) %>%
  arrange(gene) %>%
  left_join(., geneids, by = "gene") %>%
  drop_na() 
GOgenesLong

GOgenesWide <- GOgenesLong %>% 
  pivot_wider(
    names_from = GO,
    values_from = gene) %>%
  mutate(numGOs = 4 - rowSums(is.na(.))) %>%
  arrange(desc(numGOs)) %>%
  select(-numGOs) %>%
  left_join(geneids, by = c("geneid","NCBI"))
GOgenesWide

# genes I can't find in dataset 
# NOS1 or OXTR or FOX1B or HTR5A
```


## Candidate DEGs


```{r DEGs}

candidategenes <- GOgenesLong %>% distinct(gene) %>% pull(gene)

# summary DEG results from DESeq2
candidateDEGS <- read_csv("../results/suppletable1.csv") %>%
  filter(gene %in% candidategenes) %>%
  mutate(posneg = ifelse(lfc >= 0, "+", "-"),
         sex = recode(sex, "female" = "F", "male" = "M" ),
         tissue = recode(tissue, 
                         "hypothalamus" = "H",
                         "pituitary" = "P", "gonad" = "G")) %>%
  mutate(res = paste(sex, tissue, posneg, sep = "")) %>%
  select(gene, res, comparison)  %>%
  group_by(gene,  comparison) %>%
  summarize(res = str_c(res, collapse = " ")) %>%
  pivot_wider(names_from = comparison, values_from = res) %>%
  select(gene, bldg_lay, lay_inc.d3, inc.d3_inc.d9, inc.d9_inc.d17, hatch_n5, n5_n9)
candidateDEGS

table1 <- left_join(candidateDEGS, GOgenesWide) %>%
  select(gene, bldg_lay:n5_n9, parentalcare, parentalbehavior, NCBI) %>%
  mutate(parentalcare = if_else(is.na(parentalcare), " ", "X"),
         parentalbehavior = if_else(is.na(parentalbehavior), " ", "X")) %>%
  rename("Literature" = "parentalcare", "GO" =  "parentalbehavior")
table1$numDEGs <- rowSums(is.na(table1)) # count NAs to know how many are NS
table1 <- table1 %>% 
  mutate(sig = ifelse(numDEGs == 6, "NS", "DEG")) %>% 
  arrange(sig, gene)  %>%  select(-sig, -numDEGs)
table1[is.na(table1)] <- " " # replace NA with blank space so it's pretty
#table1

kable(table1)
```


## variance stabilized gene expression  (vsd)

```{r vsds}

vsd_path <- "../results/DEseq2/"   # path to the data
vsd_files <- dir(vsd_path, pattern = "*vsd.csv") # get file names
vsd_pathfiles <- paste0(vsd_path, vsd_files)
vsd_files

allvsd <- vsd_pathfiles %>%
  setNames(nm = .) %>% 
  map_df(~read_csv(.x), .id = "file_name")  %>% 
  dplyr::rename("gene" = "X1") %>% 
  pivot_longer(cols = L.G118_female_gonad_control:y98.o50.x_male_pituitary_inc.d3, 
               names_to = "samples", values_to = "counts") 

getcandidatevsd <- function(whichgenes, whichtissue, whichsex){
  candidates  <- allvsd %>%
    filter(gene %in% whichgenes) %>%
    dplyr::mutate(sextissue = sapply(strsplit(file_name, '_vsd.csv'), "[", 1)) %>%
    dplyr::mutate(sextissue = sapply(strsplit(sextissue, '../results/DEseq2/'), "[", 2)) %>%
    dplyr::mutate(sex = sapply(strsplit(sextissue, '\\_'), "[", 1),
                tissue = sapply(strsplit(sextissue, '\\_'), "[", 2),
                treatment = sapply(strsplit(samples, '\\_'), "[", 4)) %>%
    dplyr::mutate(treatment = sapply(strsplit(treatment, '.NYNO'), "[", 1)) %>%
    dplyr::select(sex, tissue, treatment, gene, samples, counts) %>%
    filter(tissue == whichtissue, sex %in% whichsex)  %>%
    drop_na()
  candidates$treatment <- factor(candidates$treatment, levels = alllevels)
  return(candidates)
}

candidategenes <- GOgenesLong %>% distinct(gene) %>% pull(gene)

hypvsd <- getcandidatevsd(candidategenes, "hypothalamus", sexlevels)
pitvsd <- getcandidatevsd(candidategenes, "pituitary", sexlevels)
gonvsd <- getcandidatevsd(candidategenes, "gonad", sexlevels)
candidatevsd <- rbind(hypvsd, pitvsd)
candidatevsd <- rbind(candidatevsd, gonvsd)
head(candidatevsd)
```


```{r fig2, fig.width = 7.25, fig.height = 7.25}

# significant candidate genes
hypDEGs <- c("CRHBP", "CRHR2", "DRD1", "GNAQ", 
             "HTR2C", "OPRK1", "PGR")
pitDEGs <- c("ESR1", "MEST", "PRL", "PTEN")
gonadDEGs <- c("AVPR1A", "CREBRF", "FOS", "GNAQ", 
               "NR3C1", "OPRM1", "PRLR")

candidateboxplot <- function(whichtissue, whichgenes, whichsex){
  
  p <- candidatevsd %>%
    filter(tissue %in% whichtissue,
          gene %in% whichgenes,
          sex %in% whichsex) %>%
    mutate(treatment = factor(treatment, levels = charlevels)) %>%
    mutate(treatmentNum = as.numeric(treatment)) %>%
    ggplot(aes(x = treatmentNum, y = counts)) +
    geom_boxplot(aes(fill = treatment, color = sex), outlier.shape = NA) +
    #geom_smooth(aes(color = sex)) +
    geom_jitter(size = 0.25, aes(color = sex)) +
    facet_wrap(~gene, scales = "free_y", nrow = 1) +
    scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9),
                       labels = charlevels) +
    scale_fill_manual(values = allcolors) +
    scale_color_manual(values = allcolors) +
    theme_B3() + 
    theme(legend.position = "none",
          strip.text = element_text(face = "italic"),
          axis.text.x = element_blank()) +
    labs(subtitle = whichsex,
         y = "gene expression",
         x = NULL) 
  return(p)
}

a1 <- candidateboxplot("hypothalamus", hypDEGs, "female") + labs(x = NULL, title = "hypothalamus") 
a2 <- candidateboxplot("hypothalamus", hypDEGs, "male") + labs(x = NULL) +
  theme(strip.text = element_blank())

b1 <- candidateboxplot("pituitary", pitDEGs, "female") + labs(x = NULL, title = "pituitary")
b2 <- candidateboxplot("pituitary", pitDEGs, "male") + labs(x = NULL) +
  theme(strip.text = element_blank())

c1 <- candidateboxplot("gonad", gonadDEGs, "female") + labs(x = NULL, title = "gonad")
c2 <- candidateboxplot("gonad", gonadDEGs, "male") + 
  theme(strip.text = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1))


plot_grid(a1,a2, b1,b2, c1,c2, nrow = 6, labels = c("A", " ","B", " ", "C", " "), label_size = 8,
          rel_heights = c(1, 0.75, 1, 0.75, 1, 1))
```



```{r writefiles}
#write.csv(candidatevsd, "../../musicalgenes/data/candidatecounts.csv")
#write.csv(candidatevsd, "../results/candidatecounts.csv")
write.csv(table1, "../results/table1.csv")
write.csv(candidategenes, "../results/candidategenes.csv")
```